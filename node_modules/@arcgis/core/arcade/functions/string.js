/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import t from"../ArcadePortal.js";import r from"../Attachment.js";import n from"../Dictionary.js";import e from"../Feature.js";import{p as o,d as a,t as i,Q as u,v as s,E as f,y as c,s as l,a as p,b as d,P as h,f as m,n as y,i as g,j as A,c as w,o as I,q as v}from"../../chunks/languageUtils.js";import{layerFieldEsriConstants as b}from"../featureset/support/shared.js";import{convertDirection as j}from"./convertdirection.js";import{XXH as E}from"./hash.js";import F from"../../geometry/Extent.js";import P from"../../geometry/Multipoint.js";import U from"../../geometry/Point.js";import x from"../../geometry/Polygon.js";import C from"../../geometry/Polyline.js";import T from"../../geometry/SpatialReference.js";function k(t,r){if(t.x===r.x&&t.y===r.y){if(t.hasZ){if(t.z!==r.z)return!1}else if(r.hasZ)return!1;if(t.hasM){if(t.m!==r.m)return!1}else if(r.hasM)return!1;return!0}return!1}function N(o,a,i){if(null!==o)if(p(o)){if(a.updateUint8Array([61]),i.map.has(o)){const t=i.map.get(o);a.updateIntArray([61237541^t])}else{i.map.set(o,i.currentLength++);for(const t of o)N(t,a,i);i.map.delete(o),i.currentLength--}a.updateUint8Array([199])}else if(d(o)){if(a.updateUint8Array([61]),i.map.has(o)){const t=i.map.get(o);a.updateIntArray([61237541^t])}else{i.map.set(o,i.currentLength++);for(const t of o.toArray())N(t,a,i);i.map.delete(o),i.currentLength--}a.updateUint8Array([199])}else{if(y(o))return a.updateIntArray([o.getTime()]),void a.updateUint8Array([241]);if(m(o))return a.updateIntArray([o.length]),a.updateWithString(o),void a.updateUint8Array([41]);if(g(o))a.updateUint8Array([!0===o?1:0,113]);else{if(A(o))return a.updateFloatArray([o]),void a.updateUint8Array([173]);if(o instanceof r)throw new Error("Type not supported in Hash");if(o instanceof t)throw new Error("Type not supported in Hash");if(!(o instanceof n)){if(o instanceof e)throw new Error("Type not supported in Hash");if(o instanceof U)return a.updateIntArray([3833836621]),a.updateIntArray([0]),a.updateFloatArray([o.x]),a.updateIntArray([1]),a.updateFloatArray([o.y]),o.hasZ&&(a.updateIntArray([2]),a.updateFloatArray([o.z])),o.hasM&&(a.updateIntArray([3]),a.updateFloatArray([o.m])),a.updateIntArray([3765347959]),void N(o.spatialReference.wkid,a,i);if(o instanceof x){a.updateIntArray([1266616829]);for(let t=0;t<o.rings.length;t++){const r=o.rings[t],n=[];let e=null,u=null;for(let a=0;a<r.length;a++){const i=o.getPoint(t,a);if(0===a)e=i;else if(k(u,i))continue;u=i,a===r.length-1&&k(e,i)||n.push(i)}a.updateIntArray([1397116793,n.length]);for(let t=0;t<n.length;t++){const r=n[t];a.updateIntArray([3962308117,t]),N(r,a,i),a.updateIntArray([2716288009])}a.updateIntArray([2278822459])}return a.updateIntArray([3878477243]),void N(o.spatialReference.wkid,a,i)}if(o instanceof C){a.updateIntArray([4106883559]);for(let t=0;t<o.paths.length;t++){const r=o.paths[t];a.updateIntArray([1397116793,r.length]);for(let n=0;n<r.length;n++)a.updateIntArray([3962308117,n]),N(o.getPoint(t,n),a,i),a.updateIntArray([2716288009]);a.updateIntArray([2278822459])}return a.updateIntArray([2568784753]),void N(o.spatialReference.wkid,a,i)}if(o instanceof P){a.updateIntArray([588535921,o.points.length]);for(let t=0;t<o.points.length;t++){const r=o.getPoint(t);a.updateIntArray([t]),N(r,a,i)}return a.updateIntArray([1700171621]),void N(o.spatialReference.wkid,a,i)}if(o instanceof F)return a.updateIntArray([3483648373]),a.updateIntArray([0]),a.updateFloatArray([o.xmax]),a.updateIntArray([1]),a.updateFloatArray([o.xmin]),a.updateIntArray([2]),a.updateFloatArray([o.ymax]),a.updateIntArray([3]),a.updateFloatArray([o.ymin]),o.hasZ&&(a.updateIntArray([4]),a.updateFloatArray([o.zmax]),a.updateIntArray([5]),a.updateFloatArray([o.zmin])),o.hasM&&(a.updateIntArray([6]),a.updateFloatArray([o.mmax]),a.updateIntArray([7]),a.updateFloatArray([o.mmin])),a.updateIntArray([3622027469]),void N(o.spatialReference.wkid,a,i);if(o instanceof T)return a.updateIntArray([14]),void 0!==o.wkid&&null!==o.wkid&&a.updateIntArray([o.wkid]),void(o.wkt&&a.updateWithString(o.wkt));if(w(o))throw new Error("Type not supported in Hash");if(I(o))throw new Error("Type not supported in Hash");if(v(o))throw new Error("Type not supported in Hash");if(o===s)throw new Error("Type not supported in Hash");throw new Error("Type not supported in Hash")}if(a.updateUint8Array([223]),i.map.has(o)){const t=i.map.get(o);a.updateIntArray([61237541^t])}else{i.map.set(o,i.currentLength++);for(const t of o.keys()){a.updateIntArray([t.length]),a.updateWithString(t),a.updateUint8Array([251]);N(o.field(t),a,i),a.updateUint8Array([239])}i.map.delete(o),i.currentLength--}a.updateUint8Array([73])}}else a.updateUint8Array([0,139])}function L(r,y){r.portal=function(r,n){return y(r,n,(function(r,n,e){return o(e,1,1),new t(a(e[0]))}))},r.trim=function(t,r){return y(t,r,(function(t,r,n){return o(n,1,1),a(n[0]).trim()}))},r.tohex=function(t,r){return y(t,r,(function(t,r,n){o(n,1,1);const e=i(n[0]);return isNaN(e)?e:e.toString(16)}))},r.upper=function(t,r){return y(t,r,(function(t,r,n){return o(n,1,1),a(n[0]).toUpperCase()}))},r.proper=function(t,r){return y(t,r,(function(t,r,n){o(n,1,2);let e=1;2===n.length&&"firstword"===a(n[1]).toLowerCase()&&(e=2);const i=/\s/,u=a(n[0]);let s="",f=!0;for(let o=0;o<u.length;o++){let t=u[o];if(i.test(t))1===e&&(f=!0);else{t.toUpperCase()!==t.toLowerCase()&&(f?(t=t.toUpperCase(),f=!1):t=t.toLowerCase())}s+=t}return s}))},r.lower=function(t,r){return y(t,r,(function(t,r,n){return o(n,1,1),a(n[0]).toLowerCase()}))},r.guid=function(t,r){return y(t,r,(function(t,r,n){if(o(n,0,1),n.length>0)switch(a(n[0]).toLowerCase()){case"digits":return u().replace("-","").replace("-","").replace("-","").replace("-","");case"digits-hyphen":return u();case"digits-hyphen-braces":return"{"+u()+"}";case"digits-hyphen-parentheses":return"("+u()+")"}return"{"+u()+"}"}))},r.console=function(t,r){return y(t,r,(function(r,n,e){return 0===e.length||(1===e.length?t.console(a(e[0])):t.console(a(e))),s}))},r.mid=function(t,r){return y(t,r,(function(t,r,n){o(n,2,3);let e=i(n[1]);if(isNaN(e))return"";if(e<0&&(e=0),2===n.length)return a(n[0]).substr(e);let u=i(n[2]);return isNaN(u)?"":(u<0&&(u=0),a(n[0]).substr(e,u))}))},r.find=function(t,r){return y(t,r,(function(t,r,n){o(n,2,3);let e=0;if(n.length>2){if(e=i(f(n[2],0)),isNaN(e))return-1;e<0&&(e=0)}return a(n[1]).indexOf(a(n[0]),e)}))},r.left=function(t,r){return y(t,r,(function(t,r,n){o(n,2,2);let e=i(n[1]);return isNaN(e)?"":(e<0&&(e=0),a(n[0]).substr(0,e))}))},r.right=function(t,r){return y(t,r,(function(t,r,n){o(n,2,2);let e=i(n[1]);return isNaN(e)?"":(e<0&&(e=0),a(n[0]).substr(-1*e,e))}))},r.split=function(t,r){return y(t,r,(function(t,r,n){let e;o(n,2,4);let u=i(f(n[2],-1));const s=c(f(n[3],!1));if(-1===u||null===u||!0===s?e=a(n[0]).split(a(n[1])):(isNaN(u)&&(u=-1),u<-1&&(u=-1),e=a(n[0]).split(a(n[1]),u)),!1===s)return e;const l=[];for(let o=0;o<e.length&&!(-1!==u&&l.length>=u);o++)""!==e[o]&&void 0!==e[o]&&l.push(e[o]);return l}))},r.text=function(t,r){return y(t,r,(function(t,r,n){return o(n,1,2),l(n[0],n[1])}))},r.concatenate=function(t,r){return y(t,r,(function(t,r,n){const e=[];if(n.length<1)return"";if(p(n[0])){const t=f(n[2],"");for(let r=0;r<n[0].length;r++)e[r]=l(n[0][r],t);return n.length>1?e.join(n[1]):e.join("")}if(d(n[0])){const t=f(n[2],"");for(let r=0;r<n[0].length();r++)e[r]=l(n[0].get(r),t);return n.length>1?e.join(n[1]):e.join("")}for(let o=0;o<n.length;o++)e[o]=l(n[o]);return e.join("")}))},r.reverse=function(t,r){return y(t,r,(function(t,r,n){if(o(n,1,1),p(n[0])){const t=n[0].slice(0);return t.reverse(),t}if(d(n[0])){const t=n[0].toArray().slice(0);return t.reverse(),t}throw new Error("Invalid Parameter")}))},r.replace=function(t,r){return y(t,r,(function(t,r,n){o(n,3,4);const e=a(n[0]),i=a(n[1]),u=a(n[2]);return 4!==n.length||c(n[3])?h(e,i,u):e.replace(i,u)}))},r.schema=function(t,r){return y(t,r,(function(t,r,o){if(o[0]instanceof e){const t=o[0].schema();return t?n.convertObjectToArcadeDictionary(t):null}throw new Error("Invalid Parameter")}))},r.subtypes=function(t,r){return y(t,r,(function(t,r,a){if(o(a,1,1),a[0]instanceof e){const t=a[0].subtypes();return t?n.convertObjectToArcadeDictionary(t):null}throw new Error("Invalid Parameter")}))},r.subtypecode=function(t,r){return y(t,r,(function(t,r,n){if(o(n,1,1),n[0]instanceof e){const t=n[0].subtypes();if(!t)return null;if(t.subtypeField&&n[0].hasField(t.subtypeField)){const r=n[0].field(t.subtypeField);for(const n of t.subtypes)if(n.code===r)return n.code;return null}return null}throw new Error("Invalid Parameter")}))},r.subtypename=function(t,r){return y(t,r,(function(t,r,n){if(o(n,1,1),n[0]instanceof e){const t=n[0].subtypes();if(!t)return"";if(t.subtypeField&&n[0].hasField(t.subtypeField)){const r=n[0].field(t.subtypeField);for(const n of t.subtypes)if(n.code===r)return n.name;return""}return""}throw new Error("Invalid Parameter")}))},r.gdbversion=function(t,r){return y(t,r,(function(t,r,n){if(o(n,1,1),n[0]instanceof e)return n[0].gdbVersion();throw new Error("Invalid Parameter")}))},r.domain=function(t,r){return y(t,r,(function(t,r,u){if(o(u,2,3),u[0]instanceof e){const t=u[0].fullDomain(a(u[1]),void 0===u[2]?void 0:i(u[2]));return t&&t.domain?"coded-value"===t.domain.type||"codedValue"===t.domain.type?n.convertObjectToArcadeDictionary({type:"codedValue",name:t.domain.name,dataType:b[t.field.type],codedValues:t.domain.codedValues.map((t=>({name:t.name,code:t.code})))}):n.convertObjectToArcadeDictionary({type:"range",name:t.domain.name,dataType:b[t.field.type],min:t.domain.min,max:t.domain.max}):null}throw new Error("Invalid Parameter")}))},r.domainname=function(t,r){return y(t,r,(function(t,r,n){if(o(n,2,4),n[0]instanceof e)return n[0].domainValueLookup(a(n[1]),n[2],void 0===n[3]?void 0:i(n[3]));throw new Error("Invalid Parameter")}))},r.domaincode=function(t,r){return y(t,r,(function(t,r,n){if(o(n,2,4),n[0]instanceof e)return n[0].domainCodeLookup(a(n[1]),n[2],void 0===n[3]?void 0:i(n[3]));throw new Error("Invalid Parameter")}))},r.urlencode=function(t,r){return y(t,r,(function(t,r,e){if(o(e,1,1),null===e[0])return"";if(e[0]instanceof n){let t="";for(const r of e[0].keys()){const n=e[0].field(r);""!==t&&(t+="&"),t+=null===n?encodeURIComponent(r)+"=":encodeURIComponent(r)+"="+encodeURIComponent(n)}return t}return encodeURIComponent(a(e[0]))}))},r.hash=function(t,r){return y(t,r,(function(t,r,n){o(n,1,1);const e=new E(0);return N(n[0],e,{map:new Map,currentLength:0}),e.digest()}))},r.convertdirection=function(t,r){return y(t,r,(function(t,r,n){return o(n,3,3),j(n[0],n[1],n[2])}))},r.fromjson=function(t,r){return y(t,r,(function(t,r,e){if(o(e,1,1),!1===m(e[0]))throw new Error("Invalid Parameter");return n.convertJsonToArcade(JSON.parse(a(e[0])))}))},r.expects=function(t,r){return y(t,r,(function(t,r,n){if(n.length<1)throw new Error("Function called with wrong number of Parameters");return s}))},r.tocharcode=function(t,r){return y(t,r,(function(t,r,n){o(n,1,2);const e=i(f(n[1],0)),u=a(n[0]);if(0===u.length&&1===n.length)return null;if(u.length<=e||e<0)throw new Error("Illegal argument");return u.charCodeAt(e)}))},r.tocodepoint=function(t,r){return y(t,r,(function(t,r,n){o(n,1,2);const e=i(f(n[1],0)),u=a(n[0]);if(0===u.length&&1===n.length)return null;if(u.length<=e||e<0)throw new Error("Illegal argument");return u.codePointAt(e)}))},r.fromcharcode=function(t,r){return y(t,r,(function(t,r,n){if(n.length<1)throw new Error("Function called with wrong number of Parameters");const e=n.map((t=>Math.trunc(i(t)))).filter((t=>t>=0&&t<=65535));return 0===e.length?null:String.fromCharCode.apply(null,e)}))},r.fromcodepoint=function(t,r){return y(t,r,(function(t,r,n){if(n.length<1)throw new Error("Function called with wrong number of Parameters");let e;try{e=n.map((t=>Math.trunc(i(t)))).filter((t=>t<=1114111&&t>>>0===t))}catch(o){return null}return 0===e.length?null:String.fromCodePoint.apply(null,e)}))}}export{L as registerFunctions};
