/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import"../../core/has.js";import{isSome as e,isNone as t,unwrap as l}from"../../core/maybe.js";import{loadArcade as r}from"../../support/arcadeOnDemand.js";import{getCSSFilterFromEffectList as i,applyColorToSymbol as a,applySizesToSymbol as n,applyRotationToSymbol as o,getColorFromSymbol as s,applyOpacityToColor as c}from"./utils.js";let u=null;function y(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function p(e,t,l){const{backgroundColor:r,outline:i,dotSize:a}=e,n=l&&l.swatchSize||22,o=.8,s=Math.round(n*n/a**2*o),c=window.devicePixelRatio,p=document.createElement("canvas"),h=n*c;p.width=h,p.height=h,p.style.width=p.width/c+"px",p.style.height=p.height/c+"px";const b=p.getContext("2d");if(r&&(b.fillStyle=r.toCss(!0),b.fillRect(0,0,h,h),b.fill()),b.fillStyle=t.toCss(!0),u&&u.length/2===s)for(let y=0;y<2*s;y+=2){const e=u[y],t=u[y+1];b.fillRect(e,t,a*c,a*c),b.fill()}else{u=[];for(let e=0;e<2*s;e+=2){const e=y(0,h),t=y(0,h);u.push(e,t),b.fillRect(e,t,a*c,a*c),b.fill()}}i&&(i.color&&(b.strokeStyle=i.color.toCss(!0)),b.lineWidth=i.width,b.strokeRect(0,0,h,h));const f=new Image(n,n);return f.src=p.toDataURL(),f}function h(e,t={}){const l=24,r=75,a="horizontal"===t.align,n=a?r:l,o=a?l:r,{width:s=n,height:c=o,gradient:u=!0}=t,y=window.devicePixelRatio,p=s*y,h=c*y,b=document.createElement("canvas");b.width=p,b.height=h,b.style.width=`${s}px`,b.style.height=`${c}px`;const f=b.getContext("2d"),d=a?p:0,m=a?0:h;if(u){const t=f.createLinearGradient(0,0,d,m),l=e.length,r=1===l?0:1/(l-1);e.forEach(((e,l)=>t.addColorStop(l*r,e.toString()))),f.fillStyle=t,f.fillRect(0,0,p,h)}else{const t=a?p/e.length:p,l=a?h:h/e.length;let r=0,i=0;for(const n of e)f.fillStyle=n.toString(),f.fillRect(r,i,t,l),r=a?r+t:0,i=a?0:i+l}const g=document.createElement("div");return g.style.width=`${s}px`,g.style.height=`${c}px`,g.style.filter=i(null==t?void 0:t.effectList),g.appendChild(b),g}async function b(e,t){switch(e.type){case"web-style":{const{previewWebStyleSymbol:l}=await import("./previewWebStyleSymbol.js");return l(e,b,t)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:l}=await import("./previewSymbol3D.js");return l(e,t)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:l}=await import("./previewSymbol2D.js");return l(e,t)}case"cim":{const{previewCIMSymbol:l}=await import("./previewCIMSymbol.js");return l(e,t)}default:return}}function f(e){return e&&"opacity"in e?e.opacity*f(e.parent):1}async function d(i,s){var c,u;if(!i)return;const y=i.sourceLayer,p=null!=(c=e(s)&&null!=(u=s.useSourceLayer)&&u?y:i.layer)?c:y,h=f(p);if(e(i.symbol)&&(!e(s)||!0!==s.ignoreGraphicSymbol)){const t="web-style"===i.symbol.type?await i.symbol.fetchSymbol(e(s)?s.abortOptions:null):i.symbol.clone();return a(t,null,h),t}const b=e(s)&&s.renderer||p&&"renderer"in p&&p.renderer;let d=b&&"getSymbolAsync"in b?await b.getSymbolAsync(i,s):null;if(!d)return;if(d="web-style"===d.type?await d.fetchSymbol(e(s)?s.abortOptions:null):d.clone(),!("visualVariables"in b)||!b.visualVariables||!b.visualVariables.length)return a(d,null,h),d;if("arcadeRequiredForVisualVariables"in b&&b.arcadeRequiredForVisualVariables&&(t(s)||t(s.arcade))){const e={...l(s)};e.arcade=await r(),s=e}const m=await import("../../renderers/visualVariables/support/visualVariableUtils.js"),g=[],w=[],S=[],v=[];for(const e of b.visualVariables)switch(e.type){case"color":g.push(e);break;case"opacity":w.push(e);break;case"rotation":v.push(e);break;case"size":e.target||S.push(e)}const V=!!g.length&&g[g.length-1],x=V?m.getColor(V,i,s):null,R=!!w.length&&w[w.length-1];let C=R?m.getOpacity(R,i,s):null;if(null!=h&&(C=null!=C?C*h:h),a(d,x,C),S.length){const e=m.getAllSizes(S,i,s);await n(d,e)}for(const e of v)o(d,m.getRotationAngle(e,i,s),e.axis);return d}async function m(i,a){var n;if(!i)return;const o=f(i.layer||i.sourceLayer);if(e(i.symbol)&&(!e(a)||!0!==a.ignoreGraphicSymbol)){const t="web-style"===i.symbol.type?await i.symbol.fetchSymbol(e(a)?a.abortOptions:null):i.symbol.clone();return s(t,o)}const u=e(a)&&a.renderer||i.get("layer.renderer")||i.get("sourceLayer.renderer");let y=await u.getSymbolAsync(i,a);if(!y)return;y="web-style"===y.type?await y.fetchSymbol(e(a)?a.abortOptions:null):y.clone();const p=s(y,o);if(!("visualVariables"in u)||"visualVariables"in u&&!u.visualVariables||"visualVariables"in u&&(null==(n=u.visualVariables)||!n.length))return p;if(u.arcadeRequiredForVisualVariables&&(t(a)||t(a.arcade))){const e={...l(a)};e.arcade=await r(),a=e}const h=await import("../../renderers/visualVariables/support/visualVariableUtils.js"),b=[],d=[];for(const e of u.visualVariables)switch(e.type){case"color":b.push(e);break;case"opacity":d.push(e)}const m=b.length>0?b[b.length-1]:null,g=m?h.getColor(m,i,a):p,w=d.length>0?d[d.length-1]:null;let S=w?h.getOpacity(w,i,a):null;return null!=o&&(S=null!=S?S*o:o),g?c(g,S):null}export{m as getDisplayedColor,d as getDisplayedSymbol,h as renderColorRampPreviewHTML,p as renderDotDensityPreviewHTML,b as renderPreviewHTML};
