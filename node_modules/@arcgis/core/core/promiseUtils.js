/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import t from"./clock.js";import n from"./Error.js";import{once as e}from"./events.js";import r from"./Logger.js";import{isSome as o,isNone as i,assumeNonNull as u,removeMaybe as c}from"./maybe.js";function s(t){return Promise.all(t)}function l(t,n){const e=t.slice();return Promise.all(t.map(((t,e)=>n(t,e)))).then((t=>e.filter(((n,e)=>t[e]))))}function f(t){return new Promise(((n,e)=>{try{t(n,e)}catch(r){Promise.resolve().then((()=>e(r)))}}))}function m(t="Aborted"){return new n("AbortError",t)}function h(t,n="Aborted"){if(p(t))throw m(n)}function a(t){return o(t)?"aborted"in t?t:t.signal:t}function p(t){const n=a(t);return o(n)&&n.aborted}function b(t){if(g(t))throw t}function w(t){if(!g(t))throw t}function v(t,n){const r=a(t);if(!i(r)){if(!r.aborted)return e(r,"abort",(()=>n()));n()}}function P(t,n){const r=a(t);if(!i(r))return h(r),e(r,"abort",(()=>n(m())))}function d(t,n){const e=a(n);return i(e)?t:new Promise(((e,r)=>{let o=v(n,(()=>r(m())));const i=()=>o=c(o);t.then(i,i),t.then(e,r)}))}function j(t,e){return Promise.race([t,x(e).then((()=>{throw new n("timeout",`Did not resolve within ${e} milliseconds`)}))])}function g(t){return t&&"AbortError"===t.name}function y(t){return t.catch((t=>{if(!g(t))throw t}))}function A(t,n=r.getLogger("esri")){return t.catch((t=>{g(t)||n.error(t)}))}function T(){let t=null;const n=new Promise(((n,e)=>{t={promise:void 0,resolve:n,reject:e}}));return t.promise=n,t}function E(t){if(!t)return;if("function"!=typeof t.forEach){const n=Object.keys(t);return E(n.map((n=>t[n]))).then((t=>{const e={};return n.forEach(((n,r)=>e[n]=t[r])),e}))}const n=t;return f((t=>{const e=[];let r=n.length;0===r&&t(e),n.forEach((n=>{const o={promise:n||Promise.resolve(n)};e.push(o),o.promise.then((t=>{o.value=t})).catch((t=>{o.error=t})).then((()=>{--r,0===r&&t(e)}))}))}))}function C(t){return E(t).then((t=>t.filter((t=>!!t.value)).map((t=>t.value))))}function k(t){return Promise.reject(t)}function L(t){return Promise.resolve(t)}function x(t,n,e){const r=new AbortController;return v(e,(()=>r.abort())),new Promise(((e,o)=>{let i=setTimeout((()=>{i=0,e(n)}),t);v(r,(()=>{i&&(clearTimeout(i),o(m()))}))}))}function D(t,e,r,o){const i=r&&"abort"in r?r:null;null!=o||i||(o=r);let u=setTimeout((()=>{u=0,i&&i.abort()}),e);const c=()=>o||new n("promiseUtils:timeout","The wrapped promise did not resolve within "+e+" ms");return t.then((t=>{if(0===u)throw c();return clearTimeout(u),t}),(t=>{throw clearTimeout(u),0===u?c():t}))}function O(t){return t&&"function"==typeof t.then}function U(t){return $(t)?t:Promise.resolve(t)}function $(t){return t&&"object"==typeof t&&"then"in t&&"function"==typeof t.then}function q(t,n=-1){let e,r,o,i,c=null;const s=(...l)=>{if(e){r=l,i&&i.reject(m()),i=T();const t=u(i.promise);if(c){const t=c;c=null,t.abort()}return t}if(o=i||T(),i=null,n>0){const r=new AbortController;e=U(t(...l,r.signal));const o=e;x(n).then((()=>{e===o&&(i?r.abort():c=r)}))}else e=1,e=U(t(...l));const f=()=>{const t=r;r=o=e=c=null,null!=t&&s(...t)},h=e,a=o;return h.then(f,f),h.then(a.resolve,a.reject),u(a.promise)};return s}function z(){let n,e;const r=new Promise(((t,r)=>{n=t,e=r})),o=t=>{n(t)};return o.resolve=t=>n(t),o.reject=t=>e(t),o.timeout=(n,e)=>t.setTimeout((()=>o.reject(e)),n),o.promise=r,o}function B(t,n){return t.then(n,n)}function F(t,n){let e,r=new AbortController;const i=t(r.signal);let u={promise:i,finished:!1,abort:()=>{r&&(r.abort(),r=null)}};const c=()=>{u&&(u.finished=!0,u=null),o(e)&&(e.remove(),e=null),r=null};return i.then(c,c),e=v(n,(()=>{o(u)&&u.abort()})),u}function G(t){return Promise.resolve().then((()=>{h(t)}))}export{x as after,s as all,B as always,f as create,m as createAbortError,T as createDeferred,z as createResolver,F as createTask,q as debounce,E as eachAlways,C as eachAlwaysValues,l as filter,y as ignoreAbortErrors,g as isAbortError,p as isAborted,$ as isPromise,O as isPromiseLike,A as logOnError,v as onAbort,P as onAbortOrThrow,k as reject,L as resolve,b as throwIfAbortError,h as throwIfAborted,w as throwIfNotAbortError,D as timeout,G as waitTick,U as when,d as whenOrAbort,j as whenOrTimeout};
