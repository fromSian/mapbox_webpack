/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{trackAccess as s,runTracked as t,trackExplicitDependencies as e,runUntracked as i}from"./tracking.js";import{ObservationHandle as n}from"./tracking/ObservationHandle.js";class l{constructor(s,t,e){this.properties=s,this.propertyName=t,this.metadata=e,this._observers=null,this._accessed=null,this._handles=null,this.flags=1|(e.nonNullable?8:0)|(e.hasOwnProperty("value")?16:0)|(void 0===e.get?32:0)|(void 0===e.dependsOn?64:0)}destroy(){this._accessed=null,this._observers=null,this._clearObservationHandles()}getComputed(){s(this);const n=this.properties.store,l=this.propertyName,r=this.flags,h=n.get(l);if(4&r)return h;if(1&~r&&n.has(l))return h;this.flags|=4;const o=this.properties.host;let a;64&r?a=t(this,this.metadata.get,o):(e(o,this),a=this.metadata.get.call(o)),n.set(l,a,1);const d=n.get(l);return d===h?this.flags&=-2:i(this.commit,this),this.flags&=-5,d}onObservableAccessed(s){s!==this&&(null===this._accessed&&(this._accessed=[]),this._accessed.includes(s)||this._accessed.push(s))}onTrackingEnd(){this._clearObservationHandles(),this.flags|=32;const s=this._accessed;if(null===s)return;let t=this._handles;null===t&&(t=this._handles=[]);for(let e=0;e<s.length;++e)t.push(s[e].observe(this));s.length=0}observe(s){return null===this._observers&&(this._observers=[]),this._observers.includes(s)||this._observers.push(s),new n(this._observers,s)}notifyChange(){this.onInvalidated(),this.onCommitted()}invalidate(){this.onInvalidated()}onInvalidated(){2&~this.flags&&(this.flags|=1);const s=this._observers;if(null!==s)for(let t=0;t<s.length;++t)s[t].onInvalidated()}commit(){this.flags&=-2,this.onCommitted()}onCommitted(){if(null===this._observers)return;const s=this._observers.slice();for(let t=0;t<s.length;++t)s[t].onCommitted()}_clearObservationHandles(){const s=this._handles;if(null!==s){for(let t=0;t<s.length;++t)s[t].remove();s.length=0}}}export{l as Property};
