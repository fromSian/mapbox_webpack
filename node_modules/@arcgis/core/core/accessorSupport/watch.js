/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../ArrayPool.js";import{equals as t}from"../lang.js";import{ReentrantObjectPool as r}from"../ReentrantObjectPool.js";import{schedule as o}from"../scheduling.js";import{someSet as l}from"../SetUtils.js";import{generateUID as i}from"../uid.js";import{valueOf as n}from"./get.js";import{reaction as s,reactionDeferred as u}from"./trackingUtils.js";import{once as a,parse as c}from"./utils.js";class d{constructor(){this.uid=i(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,r,o,l,i){return this.pool.acquire(0,e,r,o,l,i,t)}static acquireTracked(e,t,r,o){return this.pool.acquire(1,e,t,r,null,null,o)}notify(e,t){0===this.type?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t)}acquire(e,t,r,o,l,n,s){this.uid=i(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=r,this.getValue=o,this.target=l,this.path=n,this.equals=s}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=i(),this.removed=!0}}d.pool=new r(d);const h=new e,f=new Set;let m;function p(e){f.delete(e),f.add(e),m||(m=o(q))}function v(e){if(e.removed)return;const t=e.oldValue,r=e.getValue();e.equals(t,r)||(e.oldValue=r,e.notify(r,t))}function g(e){const t=Array.from(f);for(let r=0;r<t.length;r++){const o=t[r];o.target===e&&(v(o),f.delete(o))}}function _(e){for(const t of f.values())t.target===e&&(t.removed=!0)}function q(){let e=10;for(;m&&e--;){m=null;const e=j(),t=h.acquire();for(const r of e){const e=r.uid;v(r),e===r.uid&&r.removed&&t.push(r)}for(const r of f)r.removed&&(t.push(r),f.delete(r));for(const r of t)d.pool.release(r);h.release(t),h.release(e),k.forEach((e=>e()))}}function j(){const e=h.acquire();e.length=f.size;let t=0;for(const r of f)e[t]=r,++t;return f.clear(),e}const k=new Set;function y(e){return k.add(e),{remove(){k.delete(e)}}}function V(e,t,r){let o=c(e,t,r,((e,t,r)=>{let l,i,s=u((()=>n(e,t)),((n,s)=>{e.__accessor__.destroyed||l&&l.uid!==i?o.remove():(l||(l=d.acquireUntracked(n,r,s,e,t),i=l.uid),p(l))}));return{remove:a((()=>{s.remove(),l&&(l.uid!==i||l.removed||(l.removed=!0,p(l)),l=null),o=s=null}))}}));return o}function b(e,r,o){const l=c(e,r,o,((e,r,o)=>{let i=!1;return s((()=>n(e,r)),((n,s)=>{e.__accessor__.destroyed?l.remove():i||(i=!0,t(s,n)||o.call(e,n,s,r,e),i=!1)}))}));return l}function w(e,t,r,o=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:o?b(e,t,r):V(e,t,r)}function U(e,t,r){let o,l,i=u(e,((e,n)=>{o&&o.uid!==l?i.remove():(o||(o=d.acquireTracked(e,t,n,r),l=o.uid),p(o))}));return{remove:a((()=>{i.remove(),o&&(o.uid!==l||o.removed||(o.removed=!0,p(o)),o=null),i=null}))}}function S(e,t,r){let o=!1;return s(e,((e,l)=>{o||(o=!0,r(l,e)||t(e,l),o=!1)}))}function A(e,r,o=!1,l=t){return o?S(e,r,l):U(e,r,l)}function P(e){return l(f,(t=>t.oldValue===e))}export{y as afterDispatch,w as default,q as dispatch,g as dispatchTarget,P as isValueInUse,_ as removeTarget,S as syncWatchTracked,w as watch,A as watchTracked};
