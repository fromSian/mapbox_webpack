/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{deg2rad as t,rad2deg as e,asinClamped as a}from"../core/mathUtils.js";import{i as o,e as s}from"./mat4.js";import{c as i}from"./mat4f64.js";import{n,c as r,d as c,m as l,o as m,l as f,a as p}from"./vec3.js";import{f as h,c as u}from"./vec3f64.js";import y from"../geometry/Extent.js";import{getReferenceEllipsoid as M}from"../geometry/projectionEllipsoid.js";import d from"../geometry/SpatialReference.js";import{geographicToWebMercator as j}from"../geometry/support/webMercatorUtils.js";import{createDirectionUp as T,directionToHeadingTilt as g}from"../views/3d/support/cameraUtilsInternal.js";import{getLonDeltaForDistance as R}from"../views/3d/support/earthUtils.js";import{Cyclical as x,cyclical2PI as b}from"../views/3d/support/mathUtils.js";const w=h(0,0,1),I=n(u(),h(1,1,1)),U=new x(-180,180),v=i(),P=u(),q=u();function E(e,a,i,f=T()){r(P,e,w),0===c(P,P)&&r(P,e,I),o(v),s(v,v,-t(a),e),s(v,v,-t(i),P);const{up:p,direction:h}=f;return r(p,P,e),n(p,p),l(p,p,v),n(h,e),m(h,h),l(h,h,v),f}function _(t,e,a,o){const s=P,i=q;return n(s,t),r(q,s,w),0===c(q,q)&&r(q,s,I),r(i,q,s),g(e,a,o,s,i)}function H(e,o,s,i){const n={eye:u(),up:null,tilt:i,heading:s},r=P;r[0]=e[0],r[1]=e[2],r[2]=-e[1];const c=o,l=t(s),m=t(i),h=Math.sin(l),y=Math.cos(l),M=Math.sin(m),d=Math.cos(m),j=f(r);let T;if(Math.abs(m)<1e-8)T=c+j;else{const t=j/M,e=a(c/t),o=Math.PI-m-e;T=t*Math.sin(o)}const g=d*c,R=c*c*(M*M),x=y*y*R,b=T-g,w=b*b,I=x*(x+w-r[1]*r[1]);if(I<0)return p(n.eye,r,T/j),n.tilt=0,n;const U=Math.sqrt(I),v=r[1]*b,q=x+w;let E;if(E=y>0?-U+v:U+v,Math.abs(q)<1e-8)return j<1e-8?(n.eye[0]=0,n.eye[1]=0,n.eye[2]=c):p(n.eye,r,T/j),n.tilt=0,W(n.eye),k(n,e);n.eye[1]=E/q;const _=h*h*R,H=M*c,z=y*H*n.eye[1],A=n.eye[1]*n.eye[1],G=1-A,S=Math.sqrt(G),C=x*A+_-2*z*S*b+G*w;return Math.abs(C)<1e-8?(p(n.eye,r,T/j),n.tilt=0,W(n.eye),k(n,e)):(n.eye[0]=(G*(T*r[0]-g*r[0])-H*S*(r[0]*n.eye[1]*y+r[2]*h))/C,n.eye[2]=(G*(T*r[2]-g*r[2])-H*S*(r[2]*n.eye[1]*y-r[0]*h))/C,p(n.eye,n.eye,T),W(n.eye),k(n,e))}function W(t){const e=t[1];t[1]=-t[2],t[2]=e}function k(t,e){const a=E(e,t.heading,t.tilt);return t.up=a.up,t}function z(t,o,s){const i=f(o),n=Math.sqrt(s*s+i*i-2*s*i*Math.cos(Math.PI-t)),r=a(s/(n/Math.sin(t)));return e(t-r)}function A(e,o,s){const i=t(e),n=f(o);return a(s/(n/Math.sin(i)))+i}function G(a,o,s,i,n){let r,c,l,m;const f=o.latitude,p=o.longitude,h=R(f,s,M(a.spatialReference).radius)/2;r=p-h,c=p+h;const u=t(f),T=M(a.spatialReference).radius,g=(1+Math.sin(u))/(1-Math.sin(u)),x=(g+1)*Math.tan(i/T/2),w=x*x;function I(t){const e=Math.PI/2;return(t=b.normalize(t,-e))>e&&(t=Math.PI-t),t}if(l=1.5*Math.PI-2*Math.atan(.5*(x+Math.sqrt(4*g+w))),m=l+i/T,l=I(l),m=I(m),m<l){const t=m;m=l,l=t}if(l=Math.max(e(l),-90),m=Math.min(e(m),90),c=U.monotonic(r,c),c-r>180){const t=(c-r-180)/2;r+=t,c-=t}const v=a.spatialReference&&a.spatialReference.isGeographic?a.spatialReference:d.WGS84;return n?(n.xmin=r,n.ymin=l,n.xmax=c,n.ymax=m,n.spatialReference=v):n=new y(r,l,c,m,v),a.spatialReference&&a.spatialReference.isWebMercator&&j(n,!1,n),n}const S=Object.freeze({__proto__:null,headingTiltToDirectionUp:E,directionToHeadingTilt:_,eyeForCenterWithHeadingTilt:H,lookAtTiltToEyeTilt:z,eyeTiltToLookAtTilt:A,toExtent:G});export{A as a,S as c,_ as d,H as e,E as h,z as l,G as t};
