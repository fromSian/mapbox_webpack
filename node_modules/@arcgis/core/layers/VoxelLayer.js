/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Collection.js";import r from"../core/Handles.js";import i from"../core/Logger.js";import{destroyMaybe as s,isSome as o}from"../core/maybe.js";import{MultiOriginJSONMixin as n}from"../core/MultiOriginJSONSupport.js";import{throwIfAbortError as a}from"../core/promiseUtils.js";import{react as l}from"../core/reactiveUtils.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import"../core/arrayUtils.js";import"../core/has.js";import"../core/accessorSupport/ensureType.js";import{reader as m}from"../core/accessorSupport/decorators/reader.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import{n as c}from"../chunks/vec3.js";import{f as u}from"../chunks/vec3f64.js";import h from"./Layer.js";import y from"./VoxelWasmManager.js";import{APIKeyMixin as b}from"./mixins/APIKeyMixin.js";import{ArcGISService as f}from"./mixins/ArcGISService.js";import{OperationalLayer as g}from"./mixins/OperationalLayer.js";import{PortalLayer as v}from"./mixins/PortalLayer.js";import{ScaleRangeLayer as S}from"./mixins/ScaleRangeLayer.js";import{SceneService as V}from"./mixins/SceneService.js";import{sanitizeUrl as x}from"./support/arcgisLayerUrl.js";import{popupEnabled as _,legendEnabled as j,url as I}from"./support/commonProperties.js";import w from"./support/VoxelDynamicSection.js";import L from"./support/VoxelSection.js";import T from"./support/VoxelSlice.js";import W from"./support/VoxelStyle.js";import N from"./support/VoxelVariable.js";import M from"./support/VoxelVolume.js";import D from"./support/VoxelVolumeIndex.js";const R=i.getLogger(" esri.layers.VoxelLayer");let C=class extends(V(f(g(v(S(n(b(h)))))))){constructor(e){super(e),this.serviceRoot="",this.popupEnabled=!0,this.operationalLayerType="Voxel",this.legendEnabled=!0,this.title=null,this.sections=new t,this.style=null,this.opacity=1,this.variables=new t,this.volumes=new t,this.index=null,this.minScale=0,this.maxScale=0,this.type="voxel",this._dbgFlags=new Set,this._handles=new r,this.version={major:Number.NaN,minor:Number.NaN,versionString:""}}set url(e){this._set("url",x(e,R))}destroy(){this._handles=s(this._handles)}dbg(e,t){this._dbgFlags.has(e)&&(3===e?R.error(t):R.warn(t))}load(e){const t=o(e)?e.signal:null,r=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(a).then((()=>this._fetchService(t))).then((()=>this.serviceRoot=this.url));return this.addResolvingPromise(r),Promise.resolve(this)}getConfiguration(){this._handles.add([l((()=>this._getRenderMode()),(e=>this._pushRenderModeToWasm(e))),l((()=>this._getCurrentVariableId()),(e=>this._pushCurrentVariableIdToWasm(e))),l((()=>this._getDynamicSections()),(e=>this._pushDynamicSectionsToWasm(e))),l((()=>this._getSlices()),(e=>this._pushSlicesToWasm(e))),l((()=>this._getSections()),(e=>this._pushSectionsToWasm(e)))]);const e={layerType:this.operationalLayerType,version:this.version.versionString,name:this.title,spatialReference:this.spatialReference,fullExtent:this.fullExtent,volumes:this.volumes.toJSON(),variables:this.variables.toJSON(),index:this.index.toJSON(),sections:this.sections.toJSON(),style:this.style};return e.index&&this.index.isValid()?JSON.stringify(e):""}readVersion(e,t){return super.parseVersionString(e)}_getSections(){const e=[];for(const t of this.sections)e.push(new L({enabled:t.enabled,href:t.href,id:t.id,label:t.label,normal:t.normal,point:t.point,sizeInPixel:t.sizeInPixel,slices:t.slices,timeId:t.timeId,variableId:t.variableId}));return e}_pushSectionsToWasm(e){this.dbg(2,"VoxelLayer._pushSectionsToWasm() called");y.getInstance().setLayerStaticSections(this,e)||this.dbg(3,"VoxelLayer._pushSectionsToWasm() failed!")}_isPlaneValid(e,t,r){if(!e.point)return!1;if(!Array.isArray(e.point)||3!==e.point.length)return!1;if(!e.normal)return!1;if(!Array.isArray(e.normal)||3!==e.normal.length)return!1;for(let o=0;o<3;++o){const i=e.point[o];if(i<0||i>=r[t[o]].size)return!1}const i=u(e.normal[0],e.normal[1],e.normal[2]);c(i,i);const s=1e-6;return!(Math.abs(i[0])+Math.abs(i[1])+Math.abs(i[2])<s)&&(e.normal[0]=i[0],e.normal[1]=i[1],e.normal[2]=i[2],!0)}getVariableStyle(e){let t=-1;t=o(e)?e:this._getCurrentVariableId();if(!(null==this?void 0:this.style.variableStyles)||-1===t)return null;const r=this.style.variableStyles.findIndex((e=>e.variableId===t));return r<0?null:this.style.variableStyles.getItemAt(r)}getVariable(e){let t=-1;if(t=o(e)?e:this._getCurrentVariableId(),!this.variables||-1===t)return null;const r=this.variables.findIndex((e=>e.id===t));return r<0?null:this.variables.getItemAt(r)}_getVolume(e){const t=this.getVariable(e);return o(t)?this.volumes.find((({id:e})=>e===t.volumeId)):null}_getVolumeStyle(e){const t=this.getVariable(e);return o(t)?this.style.volumeStyles.find((({volumeId:e})=>e===t.volumeId)):null}_getSlices(){const e=[],t=this._getVolume(null);if(!o(t)||!t.isVolumeValid())return e;const r=this._getVolumeStyle(null);if(!o(r))return e;for(const i of r.slices)this._isPlaneValid(i,[0,1,t.getZDimension()],t.dimensions)?e.push(new T({enabled:i.enabled,label:i.label,point:i.point,normal:i.normal})):e.push(new T({enabled:!1,label:"invalid",point:i.point,normal:i.normal}));return e}_pushSlicesToWasm(e){this.dbg(2,"VoxelLayer._pushSlicesToWasm() called!");y.getInstance().setLayerSlices(this,e)||this.dbg(3,"VoxelLayer._pushSlicesToWasm() failed!")}_getDynamicSections(){const e=[],t=this._getVolume(null);if(!o(t)||!t.isVolumeValid())return e;const r=this._getVolumeStyle(null);if(!o(r))return e;for(const i of r.dynamicSections)this._isPlaneValid(i,[0,1,t.getZDimension()],t.dimensions)?e.push(new w({enabled:i.enabled,label:i.label,point:i.point,normal:i.normal})):e.push(new w({enabled:!1,label:"invalid",point:i.point,normal:i.normal}));return e}_pushDynamicSectionsToWasm(e){this.dbg(2,"VoxelLayer._pushDynamicSectionsToWasm() called!");y.getInstance().setLayerDynamicSections(this,e)||this.dbg(3,"VoxelLayer._updateDynamicSections() failed!")}_getCurrentVariableId(){return this.style?this.style.currentVariableId:-1}_pushCurrentVariableIdToWasm(e){this.dbg(2,"VoxelLayer._pushCurrentVariableIdToWasm() called!");y.getInstance().setLayerCurrentVariable(this,e)||this.dbg(3,"VoxelLayer._pushCurrentVariableIdToWasm() failed!")}_getRenderMode(){return this.style?this.style.renderMode:"volume"}_pushRenderModeToWasm(e){this.dbg(2,"VoxelLayer._pushRenderModeToWasm() called!");y.getInstance().setLayerRenderMode(this,e)||this.dbg(3,"VoxelLayer.setLayerRenderMode() failed!")}};e([p(_)],C.prototype,"popupEnabled",void 0),e([p({type:["Voxel"]})],C.prototype,"operationalLayerType",void 0),e([p(j)],C.prototype,"legendEnabled",void 0),e([p({json:{write:!0}})],C.prototype,"title",void 0),e([p(I)],C.prototype,"url",null),e([p({type:t.ofType(L),json:{write:!0,origins:{"web-scene":{name:"layerDefinition.sections",write:!0},service:{write:!1}}}})],C.prototype,"sections",void 0),e([p({type:W,json:{write:!0,origins:{"web-scene":{name:"layerDefinition.style",write:!0},service:{write:!1}}}})],C.prototype,"style",void 0),e([p({type:["show","hide"]})],C.prototype,"listMode",void 0),e([p({type:Number,range:{min:0,max:1},nonNullable:!0,json:{read:!1,write:!1,origins:{"web-scene":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],C.prototype,"opacity",void 0),e([p({type:t.ofType(N)})],C.prototype,"variables",void 0),e([p({type:t.ofType(M)})],C.prototype,"volumes",void 0),e([p({type:D})],C.prototype,"index",void 0),e([p({type:Number,json:{name:"layerDefinition.minScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],C.prototype,"minScale",void 0),e([p({type:Number,json:{name:"layerDefinition.maxScale",read:!1,write:!1,origins:{service:{read:!1,write:!1}}}})],C.prototype,"maxScale",void 0),e([p({json:{read:!1},readOnly:!0})],C.prototype,"type",void 0),e([p({readOnly:!0,json:{name:"serviceVersion"}})],C.prototype,"version",void 0),e([m("service","version")],C.prototype,"readVersion",null),C=e([d("esri.layers.VoxelLayer")],C);const P=C;export{P as default};
