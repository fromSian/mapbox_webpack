/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{remove as t}from"../../core/arrayUtils.js";import{removeMaybe as a,isSome as i,isNone as r,destroyMaybe as s}from"../../core/maybe.js";import{react as o,syncAndInitial as n}from"../../core/reactiveUtils.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import"../../core/has.js";import"../../core/accessorSupport/set.js";import{subclass as l}from"../../core/accessorSupport/decorators/subclass.js";import c from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{BatchCreateWorkflowData as u}from"./BatchCreateWorkflowData.js";import d from"./Workflow.js";import{startCreatingNewFeature as h,findLayerInfo as p,updateGraphicSymbolWhenRequired as f,getVisualVariableAttributes as v,startUpdatingFeature as g,createWorkflowSteps as m,avoidFeatureTemplateSelectionWithOnlyOneItem as w,visualVariableInteractiveUpdate as y}from"./workflowUtils.js";var b;let M=b=class extends d{constructor(e){super(e),this.type="batch-create",this.createFeatureState="create-new",this.featureFormHandle=null,this.visualVariableAttributes={rotation:null,size:null},this.highlightHandles=new Map,this.preventDefaultActionOnCancel=!1}get numPendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics.length}get pendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics}async updatePendingFeature(e){return this.preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),t(this.lastActiveGraphics,e),this.startUpdating(e)}static create(e,t,a,i){const r=new b({data:new u({creationInfo:t,viewModel:e}),onCommit:async e=>{await i(e.creationInfo.layer,{addFeatures:e.viewModel.sketchViewModel.layer.graphics.toArray()})}});return r._set("steps",this._createWorkflowSteps(r,a)),r}highlight(e){const t=this.data.viewModel.view;"3d"===t.type&&this.highlightHandles.set(e,t.highlight(e))}removeHighlight(e){a(this.highlightHandles.get(e)),this.highlightHandles.delete(e)}async startCreating(){return this.createFeatureState="create-new",h(this.data.viewModel.sketchViewModel,this.data.creationInfo)}async startUpdating(e){const t=this.data.viewModel,i=t.sketchViewModel,r=this.data.creationInfo.layer,s=p(t.layerInfos,r),o=null==s?void 0:s.formTemplate,n=o?null:null==s?void 0:s.fieldConfig;return t.featureFormViewModel.set({feature:e,fieldConfig:n,formTemplate:o}),a(this.featureFormHandle),this.featureFormHandle=t.featureFormViewModel.on("value-change",(async()=>{e.attributes=t.featureFormViewModel.getValues(),"3d"===i.view.type&&await f(e)})),this.removeHighlight(e),this.createFeatureState="update-pending",this.visualVariableAttributes=v(e),g(i,e,r,this.visualVariableAttributes)}static _createWorkflowSteps(e,l="awaiting-feature-creation-info"){const{data:u,handles:d}=e;let h=null,p=!0;const f=m(["awaiting-feature-creation-info","batch-creating-features"],l,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){u.creationInfo=null,d.add(u.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{u.creationInfo={layer:e.layer,template:e.template},u.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){d.remove(this.id)}}),"batch-creating-features":()=>({id:"batch-creating-features",async setUp(){const l=u.viewModel.view,f=u.viewModel.sketchViewModel;p=f.updateOnGraphicClick,f.updateOnGraphicClick=!1,e.lastActiveGraphics=[],e.featureFormHandle=a(e.featureFormHandle),e.visualVariableAttributes={rotation:null,size:null};const v=f.on("create",(async t=>{if("cancel"===t.state){if(e.preventDefaultActionOnCancel)return void(e.preventDefaultActionOnCancel=!1);if(e.lastActiveGraphics.length<1)return e.startCreating();const t=e.lastActiveGraphics.pop();return e.startUpdating(t)}if("complete"===t.state)return e.startUpdating(t.graphic)})),g=f.on("update",(async t=>{const a=t.graphics[0];if("complete"===t.state)return a!==h&&(e.lastActiveGraphics.push(a),e.highlight(a)),h=null,t.aborted&&e.preventDefaultActionOnCancel?void(e.preventDefaultActionOnCancel=!1):e.startCreating();"start"===t.state&&e.removeHighlight(a),await y(l,a,t,e.visualVariableAttributes);const r=a.attributes;if(i(e.visualVariableAttributes.rotation)){const{field:t}=e.visualVariableAttributes.rotation;u.viewModel.featureFormViewModel.setValue(t,r[t])}if(i(e.visualVariableAttributes.size)){const{field:t}=e.visualVariableAttributes.size;u.viewModel.featureFormViewModel.setValue(t,r[t])}})),m=f.on("delete",(async a=>{const i=a.graphics[0];t(e.lastActiveGraphics,i),h=i}));let w=null;const b=o((()=>{var e;const t=f.snappingOptions.featureSources.find((e=>e.layer===u.creationInfo.layer));return{hasFeatureLayerSource:!!t,enabled:null!=(e=null==t?void 0:t.enabled)&&e}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=f.snappingOptions.featureSources;e?(r(w)&&(w=new c({layer:f.layer,enabled:t}),a.add(w)),w.enabled=t):(i(w)&&a.remove(w),w=s(w))}),n),M=l.on("immediate-click",(async t=>{const a=await l.hitTest(t,{include:f.layer});if(a.results.length>0){const t=a.results[0].graphic;if("transform"===f.activeTool||"reshape"===f.activeTool){if(f.updateGraphics.getItemAt(0)===t)return;await e.updatePendingFeature(t)}}}));await e.startCreating();const V={remove:()=>{a(e.featureFormHandle),v.remove(),g.remove(),m.remove(),b.remove(),i(w)&&f.snappingOptions.featureSources.remove(w),w=s(w),f.cancel(),M.remove()}};d.add(V,this.id)},async tearDown(e){e.cancelled&&u.viewModel.sketchViewModel.layer.removeAll(),d.remove(this.id),u.viewModel.sketchViewModel.updateOnGraphicClick=p}})});return w(u,f)}};M=b=e([l("esri.widgets.Editor.BatchCreateWorkflow")],M);const V=M;export{V as default};
