/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import o from"../../Color.js";import t from"../../core/Handles.js";import{makeHandle as r}from"../../core/handleUtils.js";import{applySome as s,destroyMaybe as i,isSome as n,isNone as a}from"../../core/maybe.js";import{createTask as l,throwIfAborted as p}from"../../core/promiseUtils.js";import{react as c,syncAndInitial as h}from"../../core/reactiveUtils.js";import{property as d}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/has.js";import"../../core/accessorSupport/ensureType.js";import{subclass as m}from"../../core/accessorSupport/decorators/subclass.js";import u from"../Widget.js";import{tsx as _}from"./jsxFactory.js";import v from"./Popover.js";import"./widgetUtils.js";import{messageBundle as C}from"./decorators/messageBundle.js";import"../../core/Logger.js";const b="esri-color-picker",y={base:b,backgroundPattern:`${b}__bg-pattern`,toggleButton:`${b}__toggle-button`,popover:`${b}__popover`,opacitySliderContainer:`${b}__opacity-slider-container`,opacitySlider:`${b}__opacity-slider`};let f=class extends u{constructor(e,r){super(e,r),this.value=new o,this.alphaEnabled=!0,this._handles=new t,this._containerElement=null,this._popover=null,this._popoverElement=null,this._buttonElement=null,this._colorPickerCreated=!1}initialize(){this.own(c((()=>({container:this._containerElement,value:this.value})),(({container:e,value:o})=>{s(e,(e=>{e.style.setProperty("--esri-color-picker-value",o.toCss(!0))}))}),h))}loadDependencies(){return Promise.all([import("@esri/calcite-components/dist/components/calcite-button.js"),import("@esri/calcite-components/dist/components/calcite-color-picker.js"),import("@esri/calcite-components/dist/components/calcite-label.js"),import("@esri/calcite-components/dist/components/calcite-slider.js")])}destroy(){this._destroyPopover(),this._handles=i(this._handles),this._buttonElement=null}render(){const e=this._messages,o=n(this._popover)&&this._popover.open?e.close:e.open;return _("div",{class:this.classes(y.base,this.class),bind:this,afterCreate:this._onContainerAfterCreate},_("div",{class:y.backgroundPattern}),_("calcite-button",{appearance:"transparent",label:o,class:y.toggleButton,color:"neutral",id:this.id,scale:"s",tabIndex:-1,title:o,bind:this,onclick:this._togglePopover,afterCreate:this._onButtonAfterCreate}))}_onContainerAfterCreate(e){this._containerElement=e}_onButtonAfterCreate(e){this._destroyPopover(),this._buttonElement=e,this._popover=new v({owner:this,anchorElement:e,placement:"bottom-start",renderContentFunction:this._renderPopoverContent})}_destroyPopover(){this._handles.remove("hex-input-poll-timeout"),this._popover=i(this._popover),this._popoverElement=null}_renderPopoverContent(){const e=this.value,o=this._messages;return _("div",{class:y.popover,tabIndex:-1,bind:this,afterCreate:this._onPopoverAfterCreate,onfocusout:this._onPopoverFocusOut,onkeydown:this._onPopoverKeyDown},_("calcite-color-picker",{appearance:"minimal",hideSaved:!0,hideChannels:!0,scale:"m",value:this._colorPickerCreated?e.toCss():null,bind:this,onCalciteColorPickerInput:this._onColorInput,afterCreate:this._onColorPickerAfterCreate,afterRemoved:()=>this._colorPickerCreated=!1}),this.alphaEnabled&&_("section",{class:y.opacitySliderContainer},_("calcite-label",{scale:"s"},o.opacity,_("calcite-slider",{class:y.opacitySlider,labelHandles:!0,min:0,max:1,step:.01,value:e.a,bind:this,onCalciteSliderInput:this._onOpacityChange}))))}_onColorInput(e){const t=e.target.value,r="string"==typeof t?new o(t):new o;r.a=this.value.a,this._onChange(r)}_onOpacityChange(e){const o=e.target,t=this.value.clone();t.a=o.value,this._onChange(t)}_onChange(e){this.value=e,n(this.onChange)&&this.onChange(e)}_onColorPickerAfterCreate(e){this._handles.remove("hex-input-poll-timeout");const o=l((async o=>{await(null==e.componentOnReady?void 0:e.componentOnReady()),p(o),this._colorPickerCreated=!0,await new Promise((e=>requestAnimationFrame(e))),p(o),e.setFocus()}));this._handles.add(r((()=>{o.abort(),this._colorPickerCreated=!1})),"hex-input-poll-timeout")}_togglePopover(e){n(this._popover)&&this._popover.open?this._closePopover():this._openPopover()}_openPopover(){s(this._popover,(e=>e.open=!0))}_closePopover(){this._handles.remove("hex-input-poll-timeout"),s(this._popover,(e=>e.open=!1)),this._setFocusOnButton()}_setFocusOnButton(){this._handles.remove("button-focus-timeout"),this._handles.add(g((()=>{s(this._buttonElement,(e=>e.setFocus()))})),"button-focus-timeout")}_onPopoverAfterCreate(e){this._popoverElement=e}_onPopoverFocusOut(e){const o=this._popoverElement;if(a(o))return;const t=e.relatedTarget;if(t&&t instanceof Node){if(o.contains(t))return;if(t===this._buttonElement||this._isAssociatedLabel(t))return}this._closePopover()}_isAssociatedLabel(e){var o;const t=this.id,r=null==(o=e.tagName)?void 0:o.toLowerCase();return"calcite-label"===r&&e.for===t||"label"===r&&e.htmlFor===t}_onPopoverKeyDown(e){"Escape"!==e.key&&"Enter"!==e.key||(e.stopPropagation(),this._closePopover())}};function g(e,o){const t=setTimeout(e,o);return r((()=>clearTimeout(t)))}e([d()],f.prototype,"class",void 0),e([d()],f.prototype,"value",void 0),e([d()],f.prototype,"alphaEnabled",void 0),e([d()],f.prototype,"onChange",void 0),e([d()],f.prototype,"_containerElement",void 0),e([d()],f.prototype,"_popover",void 0),e([d()],f.prototype,"_popoverElement",void 0),e([d()],f.prototype,"_buttonElement",void 0),e([d(),C("esri/widgets/support/t9n/ColorPicker")],f.prototype,"_messages",void 0),e([d()],f.prototype,"_colorPickerCreated",void 0),f=e([m("esri.widgets.support.ColorPicker")],f);export{f as ColorPicker};
