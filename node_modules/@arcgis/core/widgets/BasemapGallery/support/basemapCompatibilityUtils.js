/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{throwIfAborted as a}from"../../../core/promiseUtils.js";import{isTiledLayer as t}from"../../../layers/support/layerUtils.js";import{stringFromViewingMode as i}from"../../../views/ViewingMode.js";import{checkIfTileInfoSupportedForView as r}from"../../../views/3d/terrain/terrainUtils.js";import n from"../../../views/3d/terrain/TilingScheme.js";import{isSpatialReferenceSupported as o}from"../../../views/support/spatialReferenceSupport.js";async function s(e,t={}){await c(e,t),a(t)}async function l(e,i={}){const{basemap:r,view:n}=e;if(await r.load(i),a(i),0===r.baseLayers.length)return;const o=r.baseLayers.getItemAt(0);if(!t(o))return;if(r.spatialReference){if(n.spatialReference.equals(r.spatialReference))return;p()}await o.load(i),a(i);const s=(o.get("supportedSpatialReferences")||[o.get("tileInfo.spatialReference")]).filter(Boolean);0!==s.length&&s.every((e=>!n.spatialReference.equals(e)))&&p()}function p(){throw new e("basemap-compatibility:incompatible-spatial-reference","Basemap spatial reference is not compatible with the view")}async function c(a,t){const{basemap:i,view:r}=a;if(await i.load(t),0===i.baseLayers.length)return;const n=m(i.baseLayers.concat(i.referenceLayers));if(n.length)throw n[0];const o=i.baseLayers.getItemAt(0);try{await o.load(t)}catch(s){const a="basemap-compatibility:unknown-error",t="Unknown basemap compatibility error",{name:i=a,message:r=t,details:n}=s;throw new e(i,r,n)}f(o,r)}function m(a){const t=["ArcGISTiledImageServiceLayer","ArcGISTiledMapServiceLayer","OpenStreetMap","VectorTileLayer","WebTiledLayer"];return a.toArray().filter((e=>-1===t.indexOf(e.operationalLayerType))).map((a=>new e("basemap-compatibility:unsupported-basemap-layer-type","Unsupported basemap layer type ${operationalLayerType}",{layer:a,operationalLayerType:a.operationalLayerType||"unknown"})))}function f(a,t){const s=a.tileInfo;if(!s)return;const l=t.state.viewingMode;if(!l)return;if(!o(s.spatialReference,l))throw new e(`basemapgalleryitem:spatial-reference-unsupported-${i(l)}`,`Basemap spatial reference is unsupported in ${i(l)} mode`);if(1===l){let t=r(s,a.fullExtent,null,1);if(t&&a.compatibleTileInfo256&&!r(a.compatibleTileInfo256,a.fullExtent,null,1)&&(t=null),t){const a=s.spatialReference.isWebMercator?"web-mercator":"wgs84";throw new e(`basemapgalleryitem:tiling-scheme-unsupported-${a}-global`,"Basemap tiling scheme is unsupported in global mode",{error:t})}}else if(n.checkUnsupported(s))throw new e("basemapgalleryitem:tiling-scheme-unsupported-local","Basemap tiling scheme is unsupported in local mode");const p=t.get("basemapTerrain.tilingScheme");if(p&&!p.compatibleWith(s)&&(!a.compatibleTileInfo256||!p.compatibleWith(a.compatibleTileInfo256)))throw new e("basemapgalleryitem:tiling-scheme-incompatible","Basemap tiling scheme is incompatible with the view")}export{l as default2DCompatibility,s as default3DCompatibility};
