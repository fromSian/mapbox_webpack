/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{getAssetUrl as t}from"../../assets.js";import s from"../../config.js";import r from"../../Graphic.js";import o from"../../PopupTemplate.js";import"../../symbols.js";import l from"../../core/Accessor.js";import i from"../../core/Collection.js";import{deprecatedProperty as a}from"../../core/deprecate.js";import n from"../../core/Error.js";import u from"../../core/Evented.js";import c from"../../core/Handles.js";import h from"../../core/has.js";import p from"../../core/Logger.js";import{unwrap as d,isSome as g}from"../../core/maybe.js";import{eachAlways as m,after as y}from"../../core/promiseUtils.js";import{on as f,init as S,whenFalseOnce as v,whenOnce as _}from"../../core/watchUtils.js";import{property as b}from"../../core/accessorSupport/decorators/property.js";import"../../core/arrayUtils.js";import"../../core/accessorSupport/ensureType.js";import{subclass as w}from"../../core/accessorSupport/decorators/subclass.js";import x from"../../geometry/Point.js";import I from"../../geometry/SpatialReference.js";import{onLocaleChange as j}from"../../intl/locale.js";import{fetchMessageBundle as P}from"../../intl/messages.js";import T from"../../portal/Portal.js";import{highlightsSupported as R}from"../../views/support/layerViewUtils.js";import L from"./LayerSearchSource.js";import E from"./LocatorSearchSource.js";import C from"./SearchSource.js";import{getPointFromGeometry as F,getPointWithElevation as O}from"./support/geometryUtils.js";import{isArcGISWorldGeocoder as A,meteredArcGISLocatorUrl as G,isProxiedArcGISWorldGeocoder as N,isMeteredArcGISWorldGeocoder as D}from"./support/locatorUtils.js";import{supported as M,getCurrentPosition as V,positionToPoint as k}from"../support/geolocationUtils.js";import{GoToMixin as B}from"../support/GoTo.js";import J from"../../symbols/PictureMarkerSymbol.js";import U from"../../symbols/SimpleLineSymbol.js";import H from"../../symbols/SimpleFillSymbol.js";import Q from"../../symbols/TextSymbol.js";function Z(e,t){return e.hasOwnProperty(t)&&null!=e[t]&&""!==e[t]}const q=()=>P("esri/widgets/Search/t9n/Search"),z="esri.widgets.Search.SearchViewModel",K=p.getLogger(z),W="highlight",X=i.ofType({key:e=>e.layer?"layer":"locator",base:C,typeMap:{layer:L,locator:E}}),Y=I.WGS84,$="esri/images/search/search-symbol-32.svg",ee="esri/images/search/search-symbol-32.png",te=/<(?:.|\s)*?>/g,se=-1;let re=class extends(B(u.EventedMixin(l))){constructor(e){super(e),this._handles=new c,this._gotoController=null,this._searching=null,this.autoNavigate=!0,this.autoSelect=!0,this.defaultPopupTemplate=null,this.defaultSources=new X,this.defaultSymbols={point:new J({url:t(h("trident")?ee:$),size:24,width:24,height:24}),polyline:new U({color:[130,130,130,1],width:2}),polygon:new H({color:[235,235,235,.4],outline:{color:[130,130,130,1],width:2}})},this.includeDefaultSources=!0,this.maxInputLength=128,this.maxResults=6,this.maxSuggestions=6,this.messages=null,this.minSuggestCharacters=3,this.popupEnabled=!0,this.popupTemplate=null,this.portal=T.getDefault(),this.resultCount=null,this.resultGraphicEnabled=!0,this.resultGraphic=null,this.results=null,this.selectedSuggestion=null,this.searchAllEnabled=!0,this.selectedResult=null,this.sources=new X,this.suggestionDelay=350,this.suggestionCount=null,this.suggestions=null,this.suggestionsEnabled=!0,this.view=null}initialize(){const e=async()=>{const e=await q();this.messages=e,this.defaultPopupTemplate=new o({title:e.searchResult,content:"{Match_addr}"})};e(),this._handles.add([f(this,["defaultSources","sources"],"change",(()=>this.notifyChange("allSources"))),S(this,["includeDefaultSources","view","portal"],(()=>this._update())),j(e)])}destroy(){this._abortGoTo(),this.clearGraphics(),this._handles.destroy(),this._handles=null}get activeSource(){return this.allSources.getItemAt(this.activeSourceIndex)||null}get activeSourceIndex(){return 1===this.allSources.length||!this.searchAllEnabled?0:se}set activeSourceIndex(e){void 0!==e?this._override("activeSourceIndex",e):this._clearOverride("activeSourceIndex")}get allPlaceholder(){var e;return null==(e=this.messages)?void 0:e.allPlaceholder}set allPlaceholder(e){e?this._override("allPlaceholder",e):this._clearOverride("allPlaceholder")}get allSources(){const{sources:e,defaultSources:t,includeDefaultSources:s}=this,r="function"==typeof s?s.call(null,{sources:e,defaultSources:t}):s?t.concat(e):e,o=this._get("allSources")||new X;return o.removeAll(),o.addMany(r.filter(Boolean)),o}get defaultSymbol(){return a(K,"defaultSymbol",{replacement:"defaultSymbols",version:"4.22"}),this._get("defaultSymbol")}set defaultSymbol(e){a(K,"defaultSymbol",{replacement:"defaultSymbols",version:"4.22"}),this._set("defaultSymbol",e)}get locationEnabled(){return this._get("locationEnabled")||M()}set locationEnabled(e){if(void 0===e)return void this._clearOverride("locationEnabled");const t=M();if(e&&!t){const e=new n("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});K.error(e)}this._override("locationEnabled",e&&t)}get placeholder(){const{allSources:e,activeSourceIndex:t,allPlaceholder:s}=this;if(t===se)return s;const r=e.getItemAt(t);return r?r.placeholder:""}set searchTerm(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),""===e&&this._clear()}get searchTerm(){return this._get("searchTerm")||""}get state(){return this._searching?"searching":this.updating?"loading":0===this.allSources.length?"disabled":"ready"}get updating(){return null!=this._updatingPromise}clear(){this.searchTerm=""}clearGraphics(){this._removeHighlight(),this._closePopup(),this.view&&this.view.graphics.remove(this.resultGraphic),this._set("resultGraphic",null)}search(e,t){this.emit("search-start"),this.clearGraphics();const s=this._createSuggestionForSearch(e),r=this.when().then((()=>this._getResultsFromSources(s,t).then((e=>{var r;if(null!=(r=d(null==t?void 0:t.signal))&&r.aborted)return null;const o={activeSourceIndex:this.activeSourceIndex,searchTerm:s.text,numResults:0,numErrors:0,errors:[],results:[]};this._formatResponse(o,e,s);const l=this._getFirstResult(o.results),i=(s.location&&l?l.name:s.text).replace(te,"");return this._set("searchTerm",i),(s.key&&"number"==typeof s.sourceIndex||s.location)&&this._set("selectedSuggestion",s),this._set("results",o.results),this._set("resultCount",o.results.reduce(((e,t)=>e+t.results.length),0)),this.emit("search-complete",o),this._selectFirstResult(l).then((()=>o))})))).then((e=>(this._clearSearching(),e)),(e=>{throw this._clearSearching(),e}));return this._searching=r,this.notifyChange("state"),r}searchNearby(e){if(!this.locationEnabled){const e=new n("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});return K.error(e),Promise.reject(e)}const t=V().then((t=>k({position:t,view:this.view},e))).then((t=>this.search(t,e)));return this._searching=t,this.notifyChange("state"),t.catch((()=>{})).then((()=>this._clearSearching())),t}select(e){if(this.clearGraphics(),!e){const t=new n("select:missing-parameter","Cannot select without a searchResult.",{searchResult:e});return K.error(t),Promise.reject(t)}const{view:t}=this,s=Z(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),o=this.allSources.getItemAt(s);if(!o){const e=new n("select:missing-source","Cannot select without a source.",{source:o});return K.error(e),Promise.reject(e)}const l=o instanceof L?this._getLayerSourcePopupTemplate(o):o.popupTemplate,i=o.resultSymbol||this._getDefaultSymbol(e),a=Z(o,"resultGraphicEnabled")?o.resultGraphicEnabled:this.resultGraphicEnabled,u=Z(o,"autoNavigate")?o.autoNavigate:this.autoNavigate,c=Z(o,"popupEnabled")?o.popupEnabled:this.popupEnabled,h=c?l||this.popupTemplate||this.defaultPopupTemplate:null,{feature:p}=e;if(!p){const e=new n("select:missing-feature","Cannot select without a feature.",{feature:p});return K.error(e),Promise.reject(e)}const{attributes:d,geometry:y,layer:f,sourceLayer:S}=p,v=F(y),_={layerViewQuery:this._getLayerView(p),elevationQuery:t&&g(v)?O(v,t).catch((()=>v)):Promise.resolve(v)};return m(_).then((l=>{const n=l.layerViewQuery.value,m=l.elevationQuery.value;i instanceof Q&&(i.text=e.name);const v=t&&u?e.target||e.extent:null;return(g(v)?this._goToSearchResult(v):Promise.resolve()).then((()=>{var l;const u=n?p:new r({geometry:y,symbol:i,attributes:d,layer:f,sourceLayer:S,popupTemplate:h}),g=c&&(null==(l=this.view)?void 0:l.popup),v=g&&u.getEffectivePopupTemplate(g.defaultPopupTemplateEnabled);return v&&t.popup.open({features:[u],location:m}),n&&R(n)&&!v&&this._highlightFeature({graphic:u,layerView:n}),!n&&a&&t&&t.graphics.push(u),this._setResultFloor(e),this._set("selectedResult",e),this._set("resultGraphic",u),this.emit("select-result",{result:e,source:o,sourceIndex:s}),e}))}))}suggest(e,t,s){const r=e||this.searchTerm;return this.emit("suggest-start",{searchTerm:r}),this._suggestTimer(t,s).then((()=>this._suggestImmediate(r,s).then((e=>(this._set("suggestions",e.results),this._set("suggestionCount",e.results.reduce(((e,t)=>e+t.results.length),0)),this.emit("suggest-complete",e),e)))))}async when(){await v(this,"updating")}async _update(){const{portal:e,view:t}=this;if(this.includeDefaultSources){const s=this._updatingPromise=m([null==e?void 0:e.load(),null==t?void 0:t.when()]);if(this.destroyed)return;if(this.notifyChange("updating"),await s,s!==this._updatingPromise)return}this._updatingPromise=null,this.notifyChange("updating");const s=_(this,"messages");this.destroyed||(this._handles.add(s),await s,this._updateDefaultSources())}_clearSearching(){this._searching=null,this.notifyChange("state")}_convertHelperServices(){var e,t;const r=null==(e=this.portal)||null==(t=e.helperServices)?void 0:t.geocode;if(!r)return[];return r.map((e=>{if(!1===e.placefinding)return;const t=s.apiKey&&A(e.url)?{url:G}:null,r=E.fromJSON({...e,...t}),o=r.url;if(A(o)||N(o)||D(o)){const e=r.outFields||["Addr_type","Match_addr","StAddr","City"],t=r.placeholder||this.messages.placeholder,s="number"==typeof r.defaultZoomScale?r.defaultZoomScale:2500;r.set({singleLineFieldName:"SingleLine",outFields:e,placeholder:t,defaultZoomScale:s})}return r.singleLineFieldName?r:void 0})).filter(Boolean)}_getLayerSources(e,t){var s;const r=null==(s=this.view)?void 0:s.map;return e.map((e=>{const s=r.findLayerById(e.id);if(!s)return;const o=this._getLayerJSON(e),l=L.fromJSON(o);return l.placeholder=t,this._getLayer(s,o).then((e=>{l.layer=e})),l})).filter(Boolean).toArray()}_getTableSources(e,t){var s;const r=null==(s=this.view)?void 0:s.map;return e.map((e=>{const s=r.findTableById(e.id);if(!s)return;const o=this._getLayerJSON(e),l=L.fromJSON(o);return l.placeholder=t,this._getLayer(s,o).then((e=>{l.layer=e})),l})).filter(Boolean).toArray()}_convertApplicationProperties(){var e,t,s;const r=null==(e=this.view)?void 0:e.map,o=null==r||null==(t=r.applicationProperties)||null==(s=t.viewing)?void 0:s.search;if(!o)return[];const{enabled:l,hintText:i,layers:a,tables:n}=o;if(!l)return[];return[...this._getLayerSources(a,i),...this._getTableSources(n,i)]}_getSubLayer(e,t){return e.load().then((()=>{if(!e.allSublayers)return Promise.reject();const s=e.allSublayers.find((e=>e.id===t.subLayer));return s?s.createFeatureLayer():Promise.reject()}))}async _getBuildingSubLayer(e,t){await e.load();const s=e.allSublayers.find((e=>e.id===t.subLayer));return"building-component"!==(null==s?void 0:s.type)?Promise.reject():(await s.load(),null==s.associatedLayer?Promise.reject():(await s.associatedLayer.load(),s))}_getLayer(e,t){return"feature"===e.type||"scene"===e.type||"csv"===e.type||"geojson"===e.type||"ogc-feature"===e.type?Promise.resolve(e):"map-image"===e.type?this._getSubLayer(e,t).catch((()=>{const t=new n("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:e});return K.error(t),null})):"building-scene"===e.type?this._getBuildingSubLayer(e,t):Promise.resolve(null)}_getLayerJSON(e){return"function"==typeof e.toJSON?e.toJSON():e}_updateDefaultSources(){const{defaultSources:e,includeDefaultSources:t}=this;e.removeAll(),t&&e.addMany([...this._convertApplicationProperties(),...this._convertHelperServices()]),this.notifyChange("allSources")}_abortGoTo(){this._gotoController&&this._gotoController.abort(),this._gotoController=null}_clear(){this._abortGoTo(),this._set("resultCount",null),this._set("results",null),this._set("suggestions",null),this._set("suggestionCount",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")}_closePopup(){var e;const t=null==(e=this.view)?void 0:e.popup,{resultGraphic:s}=this;if(!t||!s)return;const{selectedFeature:r}=t;r&&r===s&&t.close()}_suggestTimer(e,t){const s=null!=e?e:this.suggestionDelay;return y(s,null,t&&t.signal)}_createLocationForSearch(e){return e instanceof r?F(e.geometry):e instanceof x?e:Array.isArray(e)&&2===e.length?new x({longitude:e[0],latitude:e[1]}):null}_createSuggestionForSearch(e){if(e&&Z(e,"key")&&Z(e,"text")&&Z(e,"sourceIndex"))return e;const t=this._createLocationForSearch(e),s="string"==typeof e?e:this.searchTerm,{selectedSuggestion:r,selectedResult:o}=this,l=!e&&r&&o,i=l&&r.key===o.key&&r.sourceIndex===o.sourceIndex,a=l&&r.location;return i||a?r:{location:d(t),text:t?"":s,sourceIndex:null,key:null}}_getFirstResult(e){let t=null;return e&&e.some((e=>{const{results:s}=e,r=s[0],o=!!r;return o&&(t=r),o})),t}_selectFirstResult(e){return this.autoSelect&&e?this.select(e):Promise.resolve(null)}_suggestImmediate(e,t){return this.when().then((()=>this._getSuggestionsFromSources(e,t))).then((s=>{var r;if(null!=(r=d(null==t?void 0:t.signal))&&r.aborted)return null;const o={activeSourceIndex:this.activeSourceIndex,searchTerm:e,numResults:0,numErrors:0,errors:[],results:[]};return this._formatResponse(o,s),o}))}_formatSourceResponse(e,t,s){const r=t&&t.value||[],o=t&&t.error,l=this.allSources.getItemAt(s);if(o){const t={sourceIndex:s,source:l,error:o};e.errors.push(t),K.error(o),e.numErrors++}else{const t={sourceIndex:s,source:l,results:r};e.results.push(t),e.numResults+=r.length}}_formatResponse(e,t,s){if(t)if(e.activeSourceIndex===se){const r=s&&Z(s,"sourceIndex")&&-1!==s.sourceIndex?s.sourceIndex:void 0;t.forEach(((t,s)=>{const o=void 0!==r?r:s;this._formatSourceResponse(e,t,o)}))}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)}_getResultsFromSources(e,t){const{allSources:s}=this,r=!e.location&&Z(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,o=[];if(!s.length){const e=new n("search:no-sources-defined","At least one source is required.",{allSources:s});return K.error(e),Promise.reject(e)}return r===se?s.forEach(((s,r)=>{o.push(this._getResultsFromSource(e,r,t))})):o.push(this._getResultsFromSource(e,r,t)),m(o)}_getSuggestionsFromSources(e,t){const{allSources:s,activeSourceIndex:r}=this,o=[];if(!s.length){const e=new n("suggest:no-sources-defined","At least one source is required.",{allSources:s});return K.error(e),Promise.reject(e)}return r===se?s.forEach(((s,r)=>{o.push(this._getSuggestionsFromSource(e,r,t))})):o.push(this._getSuggestionsFromSource(e,r,t)),m(o)}_getResultsFromSource(e,t,s){var r;const o=this.allSources.getItemAt(t),{location:l=null}=e,i=(null==(r=this.view)?void 0:r.spatialReference)||Y,a=Z(o,"maxResults")?o.maxResults:this.maxResults,n=!!(o instanceof L&&Z(o,"exactMatch"))&&o.exactMatch,{view:u}=this;return o.getResults({view:u,sourceIndex:t,location:l,suggestResult:e,spatialReference:i,exactMatch:n,maxResults:a},s)}_getSuggestionsFromSource(e,t,s){const r=this.allSources.getItemAt(t),o=Z(r,"suggestionsEnabled")?r.suggestionsEnabled:this.suggestionsEnabled,l=e.length,i=Z(r,"minSuggestCharacters")?r.minSuggestCharacters:this.minSuggestCharacters;if(o&&e.trim()&&l>=i){var a;const o=(null==(a=this.view)?void 0:a.spatialReference)||Y,l=Z(r,"maxSuggestions")?r.maxSuggestions:this.maxSuggestions,{view:i}=this,n=!!(r instanceof L&&Z(r,"exactMatch"))&&r.exactMatch;return r.getSuggestions({view:i,sourceIndex:t,suggestTerm:e,spatialReference:o,maxSuggestions:l,exactMatch:n},s)}return Promise.resolve(null)}_getLayerSourcePopupTemplate(e){const{layer:t}=e;if(t)return Z(e,"popupTemplate")?e.popupTemplate:t.popupTemplate}_getSourceIndexOfResult(e){const t=this.results;let s=null;return t.some((t=>t.results.some((r=>r===e&&(s=t.sourceIndex,!0))))),s}async _goToSearchResult(e){const t=!!e;this._abortGoTo();const s=new AbortController;this._gotoController=s;const r={target:{target:e},options:{animate:t,signal:s.signal}};await this.callGoTo(r),this._gotoController=null}_getDefaultSymbol(e){var t;const{defaultSymbols:s}=this,r=null==(t=e.feature)?void 0:t.geometry;if(!g(r))return null;const o=this._get("defaultSymbol");if(o&&("point"===r.type||"multipoint"===r.type))return o;switch(r.type){case"point":case"multipoint":return s.point;case"polyline":return s.polyline;case"extent":case"polygon":return s.polygon;default:return null}}_removeHighlight(){this._handles.remove(W)}async _getLayerView(e){const{view:t}=this;if(!e||!t||"building-component"===e.layer.type||"subtype-sublayer"===e.layer.type)return Promise.resolve(null);const{layer:s}=e;return await t.when(),t.whenLayerView(s)}_highlightFeature(e){const{graphic:t,layerView:s}=e,{attributes:r,layer:o}=t,{objectIdField:l}=o,i=r&&r[l],a=s.highlight(i||t);this._handles.add(a,W)}_setResultFloor(e){var t,s,r;const{view:o}=this,l=null==(t=e.feature)?void 0:t.attributes,i=null==(s=e.feature)?void 0:s.sourceLayer;if(i&&"floorInfo"in i&&null!=i&&null!=(r=i.floorInfo)&&r.floorField&&l){const e=l[i.floorInfo.floorField];o.emit("select-result-floor",e)}}};re.ALL_INDEX=se,e([b({readOnly:!0,value:null})],re.prototype,"activeSource",null),e([b()],re.prototype,"activeSourceIndex",null),e([b()],re.prototype,"allPlaceholder",null),e([b({readOnly:!0,dependsOn:["defaultSources.length","sources.length","includeDefaultSources"]})],re.prototype,"allSources",null),e([b()],re.prototype,"autoNavigate",void 0),e([b()],re.prototype,"autoSelect",void 0),e([b()],re.prototype,"defaultPopupTemplate",void 0),e([b({readOnly:!0})],re.prototype,"defaultSources",void 0),e([b()],re.prototype,"defaultSymbol",null),e([b()],re.prototype,"defaultSymbols",void 0),e([b()],re.prototype,"includeDefaultSources",void 0),e([b()],re.prototype,"locationEnabled",null),e([b()],re.prototype,"maxInputLength",void 0),e([b()],re.prototype,"maxResults",void 0),e([b()],re.prototype,"maxSuggestions",void 0),e([b()],re.prototype,"messages",void 0),e([b()],re.prototype,"minSuggestCharacters",void 0),e([b({readOnly:!0})],re.prototype,"placeholder",null),e([b()],re.prototype,"popupEnabled",void 0),e([b({type:o})],re.prototype,"popupTemplate",void 0),e([b({type:T})],re.prototype,"portal",void 0),e([b()],re.prototype,"resultCount",void 0),e([b()],re.prototype,"resultGraphicEnabled",void 0),e([b({readOnly:!0})],re.prototype,"resultGraphic",void 0),e([b({readOnly:!0})],re.prototype,"results",void 0),e([b({readOnly:!0})],re.prototype,"selectedSuggestion",void 0),e([b()],re.prototype,"searchAllEnabled",void 0),e([b({readOnly:!0})],re.prototype,"selectedResult",void 0),e([b()],re.prototype,"searchTerm",null),e([b({type:X})],re.prototype,"sources",void 0),e([b({readOnly:!0,dependsOn:["allSources.length","updating"]})],re.prototype,"state",null),e([b()],re.prototype,"suggestionDelay",void 0),e([b()],re.prototype,"suggestionCount",void 0),e([b({readOnly:!0})],re.prototype,"suggestions",void 0),e([b()],re.prototype,"suggestionsEnabled",void 0),e([b({readOnly:!0})],re.prototype,"updating",null),e([b()],re.prototype,"view",void 0),e([b()],re.prototype,"clear",null),re=e([w(z)],re);const oe=re;export{oe as default};
