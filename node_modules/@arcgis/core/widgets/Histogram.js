/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{isSome as t}from"../core/maybe.js";import{aliasOf as i}from"../core/accessorSupport/decorators/aliasOf.js";import"../core/arrayUtils.js";import"../core/has.js";import"../core/accessorSupport/ensureType.js";import{property as s}from"../core/accessorSupport/decorators/property.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import{R as a}from"../chunks/ResizeObserver.js";import n from"./Widget.js";import o from"./Histogram/HistogramViewModel.js";import"./support/widgetUtils.js";import{messageBundle as l}from"./support/decorators/messageBundle.js";import"../core/Logger.js";import{tsx as d}from"./support/jsxFactory.js";import{substitute as h}from"../intl/substitute.js";var u;const c={base:"esri-histogram",horizontalLayout:"esri-histogram--horizontal",verticalLayout:"esri-histogram--vertical",content:"esri-histogram__content",svg:"esri-histogram__svg",bar:"esri-histogram__bar",bars:"esri-histogram__bars",label:"esri-histogram__label",dataLines:"esri-histogram__data-lines",dataLinesSubgroup:"esri-histogram__data-lines-subgroup",dataLine:"esri-histogram__data-line",averageLabel:"esri-histogram__average-label",averageDataLine:"esri-histogram__average-data-line",averageSymbol:"esri-histogram__average-symbol",esriWidget:"esri-widget",widgetIcon:"esri-icon-edit",disabled:"esri-disabled"};let g=u=class extends n{constructor(e,t){super(e,t),this._bgFillId=null,this._containerNode=null,this._containerOffsetHeight=0,this._containerOffsetWidth=0,this._defaultBarColor="#d8d8d8",this._observer=null,this.average=null,this.barCreatedFunction=null,this.bins=null,this.dataLines=null,this.dataLineCreatedFunction=null,this.dataLineUpdatedFunction=null,this.label=void 0,this.labelFormatFunction=null,this.max=null,this.messages=null,this.min=null,this.state=null,this.viewModel=new o,this._observer=new a((()=>{this._storeContainerDimensions(),this.scheduleRender()})),this._bgFillId=`${this.id}-bg-fill`}destroy(){this._containerNode&&this._observer.unobserve(this._containerNode)}set layout(e){"vertical"!==e&&(e="horizontal"),this._set("layout",e)}static fromHistogramResult(e){const{bins:t,maxValue:i,minValue:s}=e;return new u({bins:t,max:i,min:s})}render(){const{label:e,layout:t,state:i}=this,s=this.classes(c.base,c.esriWidget,"horizontal"===t?c.horizontalLayout:c.verticalLayout,"disabled"===i?c.disabled:null);return d("div",{"aria-label":e,afterCreate:this._afterContainerNodeCreate,bind:this,class:s,"data-node-ref":"_containerNode"},"ready"===i?this.renderContent():null)}renderContent(){if(!this._containerNode)return;const e=this._bgFillId,t=`clip-path: url(#${e})`;return d("div",{class:c.content},d("svg",{class:c.svg,xmlns:"http://www.w3.org/2000/svg"},d("defs",null,this.renderFillDefinition(e)),d("g",{style:t},this.renderBarsGroup()),this.renderLinesGroup()))}renderBarsGroup(){return d("g",{class:this.classes(c.bars)},this.renderBars())}renderBars(){const{layout:e,viewModel:{binRange:t,range:i}}=this;if(!t||!i)return;const s=t/i,[r,a]=this._getContainerDimensions();if(0===r&&0===a)return;if(0===r&&0!==a)return void this.scheduleRender();const[n,o]="vertical"===e?[r*s,a]:[r,a*s];return this._getBarDimensions(n,o).map((([e,t],i)=>this.renderBar(i,e,t)))}renderBar(e,t,i){const{bins:s,layout:r,max:a,messages:n,viewModel:{range:o}}=this,[l,u]=this._getContainerDimensions(),g=s.slice()[e],{count:p,maxValue:m,minValue:b}=g,_=a-m,[v,f]="vertical"===r?[0,_*(l/o)]:[u-i-_*(u/o),l-t],L=h(n.barLabel,{count:p,maxValue:m,minValue:b});return d("rect",{"aria-label":L,afterCreate:this._afterBarCreate,bind:this,class:c.bar,"data-index":e,fill:this._defaultBarColor,height:t,role:"img","shape-rendering":"crispEdges","stroke-width":"0",width:i,x:v,y:f})}renderLinesGroup(){return d("g",{class:this.classes(c.dataLines)},this.renderAverageLine(),this.renderCustomLines())}renderAverageLine(){const{average:e}=this;if(!t(e))return;const i=[d("tspan",{class:this.classes(c.averageSymbol)},"xÌ„ "),d("tspan",{class:this.classes(c.averageLabel)},this.labelFormatFunction?this.labelFormatFunction(e,"average"):e)];return d("g",{afterCreate:this._afterLinesSubgroupCreate,afterUpdate:this._afterLinesSubgroupUpdate,bind:this,class:this.classes(c.dataLinesSubgroup)},d("title",{key:"title"},e),this.renderLine(e,this.classes(c.averageDataLine)),this.renderLabel(e,i))}renderCustomLines(){if(this.dataLines&&this.dataLines.length)return this.dataLines.map((({value:e,label:t},i)=>this.renderLineSubgroup(i,e,t)))}renderLineSubgroup(e,t,i){return d("g",{afterCreate:this._afterLinesSubgroupCreate,afterUpdate:this._afterLinesSubgroupUpdate,bind:this,class:this.classes(c.dataLinesSubgroup),"data-index":e},d("title",{key:"title"},t),this.renderLine(t),this.renderLabel(t,i))}renderLine(e,t){const[i,s,r,a]=this._getLinePosition(e);return d("line",{class:this.classes(c.dataLine,t),x1:i,x2:s,y1:r,y2:a,"shape-rendering":"crispEdges"})}renderLabel(e,t,i){const[s,r]=this._getLabelPosition(e),a=2;return d("text",{class:this.classes(c.label,i),"text-anchor":"end",transform:"horizontal"===this.layout?"rotate(270)":null,x:s,y:r-a},t)}renderFillDefinition(e){const[t,i]=this._getContainerDimensions();return d("clipPath",{id:e},d("rect",{x:"0",y:"0",width:i,height:t}))}_afterContainerNodeCreate(e){this._containerNode&&this._observer.unobserve(this._containerNode),this._containerNode=e,this._observer.observe(this._containerNode),this._storeContainerDimensions()}_afterBarCreate(e){if(this.barCreatedFunction){const t=e.dataset?parseInt(e.dataset.index,10):e.getAttribute("data-index")?parseInt(e.getAttribute("data-index"),10):null;this.barCreatedFunction(isNaN(t)?null:t,e)}}_afterLinesSubgroupCreate(e){if(this.dataLineCreatedFunction){const t=e.dataset?parseInt(e.dataset.index,10):e.getAttribute("data-index")?parseInt(e.getAttribute("data-index"),10):null,i=e.childNodes[0],s=e.childNodes[1]?e.childNodes[1]:null;this.dataLineCreatedFunction(i,s,isNaN(t)?null:t)}}_afterLinesSubgroupUpdate(e){if(this.dataLineUpdatedFunction){const t=e.dataset?parseInt(e.dataset.index,10):e.getAttribute("data-index")?parseInt(e.getAttribute("data-index"),10):null,i=e.childNodes[0],s=e.childNodes[1]?e.childNodes[1]:null;this.dataLineUpdatedFunction(i,s,isNaN(t)?null:t)}}_storeContainerDimensions(){const{_containerNode:e}=this;e&&(this._containerOffsetHeight=e.offsetHeight,this._containerOffsetWidth=e.offsetWidth)}_getContainerDimensions(){return[this._containerOffsetHeight,this._containerOffsetWidth]}_getBarDimensions(e,t){const{bins:i,layout:s}=this,r=i?i.map((e=>e.count)):[],a=Math.max.apply(Math,r);return r.map((i=>"vertical"===s?[e/r.length,0!==a?i/a*t:0]:[0!==a?i/a*e:0,t/r.length]))}_getLinePosition(e){const{layout:t,min:i,viewModel:{range:s}}=this,r=Math.round((e-i)/s*100)/100,[a,n]=this._getContainerDimensions(),[o,l]=[r*n||1,a-r*a||1];return"vertical"===t?[0,"100%",l,l]:[o,o,"100%",0]}_getLabelPosition(e){const{layout:t,min:i,viewModel:{range:s}}=this,r=Math.round((e-i)/s*100)/100,[a,n]=this._getContainerDimensions();return"vertical"===t?[n,a-r*a]:[0,r*n]}};e([s()],g.prototype,"_containerOffsetHeight",void 0),e([s()],g.prototype,"_containerOffsetWidth",void 0),e([i("viewModel.average")],g.prototype,"average",void 0),e([s()],g.prototype,"barCreatedFunction",void 0),e([i("viewModel.bins")],g.prototype,"bins",void 0),e([s()],g.prototype,"dataLines",void 0),e([s()],g.prototype,"dataLineCreatedFunction",void 0),e([s()],g.prototype,"dataLineUpdatedFunction",void 0),e([s({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],g.prototype,"label",void 0),e([i("viewModel.labelFormatFunction")],g.prototype,"labelFormatFunction",void 0),e([s({value:"horizontal"})],g.prototype,"layout",null),e([i("viewModel.max")],g.prototype,"max",void 0),e([s(),l("esri/widgets/Histogram/t9n/Histogram")],g.prototype,"messages",void 0),e([i("viewModel.min")],g.prototype,"min",void 0),e([i("viewModel.state")],g.prototype,"state",void 0),e([s()],g.prototype,"viewModel",void 0),g=u=e([r("esri.widgets.Histogram")],g);const p=g;export{p as default};
