/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../Camera.js";import"../geometry.js";import i from"../Graphic.js";import r from"../Ground.js";import s from"../Viewpoint.js";import n from"../core/Collection.js";import{byId as a}from"../core/domUtils.js";import o from"../core/Error.js";import{on as l}from"../core/events.js";import{handlesGroup as p,makeHandle as h}from"../core/handleUtils.js";import d from"../core/has.js";import{isIterable as c}from"../core/iteratorUtils.js";import u from"../core/Logger.js";import{destroyMaybe as g,isNone as m,isSome as f,unwrapOr as y}from"../core/maybe.js";import{throwIfAborted as w}from"../core/promiseUtils.js";import{setFrameDuration as v}from"../core/scheduling.js";import{on as _,whenOnce as S,init as b,whenTrueOnce as M}from"../core/watchUtils.js";import{initialize as R}from"../core/workers/workers.js";import{screenPointObjectToArray as x,createScreenPoint as V,createScreenPointArray as T}from"../core/screenUtils.js";import{property as C}from"../core/accessorSupport/decorators/property.js";import"../core/arrayUtils.js";import{cast as O}from"../core/accessorSupport/decorators/cast.js";import{subclass as P}from"../core/accessorSupport/decorators/subclass.js";import{ensureType as j}from"../core/accessorSupport/ensureType.js";import{c as E}from"../chunks/vec3f64.js";import I from"../geometry/HeightModelInfo.js";import{canProjectWithoutEngine as H,project as G,projectPointToVector as U,projectVectorToVector as A,projectBoundingRect as L}from"../geometry/projection.js";import{create as D,toExtent as F}from"../geometry/support/aaBoundingRect.js";import{B as W,a as q}from"../chunks/boundedPlane.js";import{renderSRFromViewSR as z}from"../geometry/support/coordinateSystem.js";import{getResolutionForScale as k}from"../geometry/support/scaleUtils.js";import N from"../layers/VoxelWasmManager.js";import{isTiledLayer as B}from"../layers/support/layerUtils.js";import{BreakpointsOwner as Q}from"./BreakpointsOwner.js";import{DOMContainer as $}from"./DOMContainer.js";import K from"./GroundView.js";import{PopupView as Z}from"./PopupView.js";import J from"./View.js";import X from"./ViewAnimation.js";import{stringFromViewingMode as Y,viewingModeFromString as ee}from"./ViewingMode.js";import{layerView3DImporter as te}from"./3d/layerViewModuleImportUtils.js";import ie from"./3d/analysis/AnalysisViewManager3D.js";import re from"./3d/constraints/Constraints.js";import se from"./3d/environment/SceneViewEnvironment.js";import{SceneViewEnvironmentManager as ne}from"./3d/environment/SceneViewEnvironmentManager.js";import ae from"./3d/input/SceneInputManager.js";import{GraphicsDeconflictor as oe}from"./3d/layers/graphics/GraphicsDeconflictor.js";import{Labeler as le}from"./3d/layers/graphics/Labeler.js";import{ObjectResourceCache as pe}from"./3d/layers/graphics/ObjectResourceCache.js";import he from"./3d/layers/support/FeatureTileTree3D.js";import de from"./3d/state/ViewState.js";import ce from"./3d/state/ViewStateManager.js";import{SceneIntersectionHelper as ue}from"./3d/state/helpers/SceneIntersectionHelper.js";import{CombinedElevationProvider as ge}from"./3d/support/CombinedElevationProvider.js";import me from"./3d/support/debugFlags.js";import fe from"./3d/support/DisplayQualityProfile.js";import{getElevationAtPoint as ye}from"./3d/support/ElevationProvider.js";import we from"./3d/support/HighlightOptions.js";import{MapCoordsHelper as ve}from"./3d/support/MapCoordsHelper.js";import{PropertiesPool as _e}from"./3d/support/PropertiesPool.js";import Se from"./3d/support/QualitySettings.js";import{RenderCoordsHelper as be}from"./3d/support/RenderCoordsHelper.js";import{newResourceController as Me}from"./3d/support/ResourceController.js";import Re from"./3d/support/SceneViewPerformanceInfo.js";import{SharedSymbolResources as xe}from"./3d/support/SharedSymbolResources.js";import Ve from"./3d/support/pointsOfInterest/PointsOfInterest.js";import Te from"./3d/terrain/TerrainSurface.js";import{isSurfaceLayerView as Ce,getTiledLayerInfo as Oe}from"./3d/terrain/terrainUtils.js";import{Stage as Pe}from"./3d/webgl-engine/Stage.js";import{newIntersector as je,DEFAULT_TOLERANCE as Ee}from"./3d/webgl-engine/lib/Intersector.js";import{isValidIntersectorResult as Ie}from"./3d/webgl-engine/lib/intersectorUtils.js";import{toGraphic as He,toOwner as Ge}from"./3d/webgl-engine/lib/intersectorUtilsConversions.js";import{TERRAIN_ID as Ue}from"./3d/webgl-engine/lib/verticalOffsetUtils.js";import{hitTestSelectSameDistance as Ae}from"./support/hitTestSelectUtils.js";import{occludeesSupported as Le}from"./support/layerViewUtils.js";import{toRenderSettings as De,screenshotSuperSampleSettings as Fe}from"./support/screenshotUtils.js";import{isSupportedScreenPointEvent as We,createScreenPointFromSupportedEvent as qe}from"./support/screenUtils.js";import{isSpatialReferenceSupported as ze}from"./support/spatialReferenceSupport.js";import{check as ke}from"./support/WebGLRequirements.js";import Ne from"./ui/3d/DefaultUI3D.js";import Be from"../webscene/Environment.js";import Qe from"../geometry/Extent.js";import $e from"../geometry/SpatialReference.js";import Ke from"../geometry/Point.js";const Ze=u.getLogger("esri.views.SceneView");let Je=class extends(Q($(Z(J)))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new _e({slicePlane:W},this),this._resourceController=Me(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new oe({view:this}),this.labeler=new le({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new re,this.environmentManager=new ne,this.extent=null,this.floors=new n,this.windowDevicePixelRatio=1,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new ie({view:this}),this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new de,this.scale=null,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new Ne,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new we,R(),e&&e.environment||(this._defaults.environment=new se,this.environment=this._defaults.environment);const t=e=>{f(e)&&4===e.type||(this.updatingChanged(),this.map&&this.map.allLayers.forEach((async e=>{try{await e.when()}catch{}this.updatingChanged()})))};this.handles.add([_(this,"map.allLayers","after-changes",t,t,t,!0),this.allLayerViews.on("after-changes",(e=>this._updateUpdatingMonitors(e))),this.watch("map",(e=>{e&&e.load&&e.load().catch((()=>{}))}))]),this.inputManager=new ae({view:this});const i=()=>{const e=window.devicePixelRatio;e!==this.windowDevicePixelRatio&&(this.windowDevicePixelRatio=e,this.notifyChange("pixelRatio"))};this.stateManager=new ce({view:this,updateDevicePixelRatio:i})}initialize(){this.groundView=new K({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(_(this,"map.allLayers","after-changes",e,e,e)),this.updatingHandles.add(this.qualitySettings,"memoryLimit",(e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)}),2),this.updatingHandles.add(this.qualitySettings,"additionalCacheMemory",(e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)}),2),this.updatingHandles.add(this.qualitySettings,"frameRate",(e=>v(e>0?1e3/Math.ceil(e):0)),2),this.updatingHandles.add(me,"SCENEVIEW_LOCKING_LOG",(e=>this.defaultsFromMap.logDebugInformation=e),2),this.updatingHandles.add(this,"map.ground",e,3),this.updatingHandles.add(this,"map.ground.opacity",(()=>this._updateDefaultHitTestOptions()),3),this.handles.add(this.watch("spatialReference",(()=>this.notifyChange("clippingArea")),!0))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=g(this.sharedSymbolResources),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController=g(this._resourceController),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView=g(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain&&this.basemapTerrain.spatialReference}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get clippingArea(){if("global"===this.viewingMode)return null;let e=this._userClippingArea||this.get("map.clippingArea");return!(!!this._userClippingArea||this.get("map.clippingEnabled"))||m(e)?(this._clippingArea=null,null):e instanceof Qe?this.spatialReference&&(e=et(e,this.spatialReference),m(e))?(Ze.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),m(e.intersection(this.groundAndLayersExtent))&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(Ze.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&"global"===this.viewingMode&&f(e)?Ze.error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(1===this.state.viewingMode)return null;const e=this.renderSpatialReference,t=this.dataExtent;return m(t)||m(e)||t.spatialReference.equals(e)?t:et(t,e)}get dataExtent(){let e=this.groundAndLayersExtent;const t=this.spatialReference||$e.WGS84,i=et(this.clippingArea,t);f(i)&&(e=f(e)?e.intersection(i):i);const r=this._get("dataExtent");return f(e)&&e.equals(r)?r:e}get groundAndLayersExtent(){const e=this.spatialReference||$e.WGS84;let t;const i=i=>{const r=et(i,e);m(r)||(f(t)?t.union(r):t=r.clone())},r=this.basemapTerrain;if(null!=r&&r.spatialReference){const e=r.groundExtent;i(new Qe({xmin:e[0],ymin:e[1],zmin:0,xmax:e[2],ymax:e[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const e=e=>{!f(e.fullExtent)||"graphics"===e.type&&e.internal||i(e.fullExtent)};this.map.allLayers.forEach((t=>e(t)))}if(m(t))return null;t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0);const s=this._get("groundAndLayersExtent");return t.equals(s)?s:t}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof se?e:e instanceof Be?null!=this.environment?this.environment.cloneWithWebsceneEnvironment(e):se.fromWebsceneEnvironment(e):j(se,e):new se}get pixelRatio(){return Math.min(this.windowDevicePixelRatio,this.maximumPixelRatio)}set pixelRatio(e){f(e)?this._override("pixelRatio",e):this._clearOverride("pixelRatio")}get maximumPixelRatio(){let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.qualitySettings;if(null!=t&&(e=Math.min(e,t)),null!=i){const t=i/Math.max(this.width,this.height);e=Math.min(e,t)}return e}set maximumPixelRatio(e){f(e)?this._override("maximumPixelRatio",e):this._clearOverride("maximumPixelRatio")}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||f(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(m(this.state)||this.state.stationary)}set qualityProfile(e){fe.isValidProfile(e)&&(fe.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||fe.getDefaultProfile()}set slicePlane(e){if(f(this._stage)&&this._stage.renderView.setRenderParameters({slicePlane:e}),m(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");q(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return null!=this.spatialReference?k(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return null!=e?I.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var e,t,i;if(this.destroyed)return!1;let r=0,s=this.layerViewManager.updating,n=s?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach((e=>{if(e.isFulfilled()){if(e.updating){if(s=!0,e.suspended||Ce(e))return;++n,r+=e.updatingProgress}}else++n}));for(const a of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager,this.analysisViewManager])if(f(a)&&a.updating){const e=.1;n+=e,r+=.5*e}for(const a of[this.deconflictor,this.labeler,this.basemapTerrain])f(a)&&a.updating&&(++n,r+=a.updatingProgress);if(s=!!(s||n>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||null!=(e=this.inputManager)&&e.hasPendingInputs||null!=(t=this.map)&&null!=(i=t.allLayers)&&i.some((e=>!e.isFulfilled()))),s?(this._numUpdating=Math.max(n,this._numUpdating),r+=this._numUpdating-n):this._numUpdating=0,this._numUpdating>0?r/=this._numUpdating:r=s?0:1,this._get("updatingProgress")!==r){const e=this._resourceController.scheduler.now;if(r<1){const t=Math.min((e-this._lastUpdateTime)/2e3,1);r=this.updatingProgress*(1-t)+r*t}this._set("updatingProgress",r),this._lastUpdateTime=s&&r<1?e:0}return s}get viewingMode(){var e;const t=this._predeterminedViewingMode;if(f(t))return Y(t);const i=this.spatialReference;return f(null==(e=this.defaultsFromMap)?void 0:e.viewingMode)&&i&&i.equals(this.defaultsFromMap.spatialReference)?Y(this.defaultsFromMap.viewingMode):!i||ze(i,1)?"global":"local"}set viewingMode(e){this.ready?Ze.error("#viewingMode","viewingMode cannot be set once view is ready"):e?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}get resourceController(){return this._resourceController}get performanceInfo(){return new Re(this)}forceAnimationTime(e){this._stage.renderView.forcedAnimationTime=this.basemapTerrain.overlayManager.forcedAnimationTime=e}on(e,t,i,r){const s=this.viewEvents.on(e,t,i,r);return s||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return Ze.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=f(i.graphics)&&(f(i.graphics.include)||f(i.graphics.exclude)),s=We(e)?qe(this,e):e,n=x(s);i.enableDraped=i.include&&!i.include.has(Ue)||i.exclude&&i.exclude.has(Ue);const a=this.sceneIntersectionHelper,o=je(this.state.viewingMode);if(o.options.selectionMode=!0,o.options.store=r?2:0,a.intersectIntersectorScreen(n,o,i),r){for(const e of o.results.all){const t=He(e,this);if(m(t))return this._intersectResultToMapPoint(e);if(this._testGraphicUidFilter(i.graphics,t))return this._intersectResultToMapPoint(e)}return null}return this._intersectResultToMapPoint(o.results.min)}toScreen(e){if(!this.ready)return Ze.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=y(null==e.z&&ye(this.elevationProvider,e),0);return U(e,tt,this.renderSpatialReference,t),this.state.camera.projectToScreen(tt,it),V(it[0],it[1])}pixelSizeAt(e){return this.ready?e?(U(e,tt,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(tt)):0:(Ze.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return Ze.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=We(e)?qe(this,e):e,r=T(i.x,i.y),s=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=je(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=2,this.sceneIntersectionHelper.intersectIntersectorScreen(r,n,s);const a=this._intersectResultsToHits(n.results.all,s.graphics),o=n.results.ground,l=Ge(o,this),p=f(l)&&"type"in l&&"integrated-mesh"===l.type?l:null,h={screenPoint:i,results:a,ground:{mapPoint:this._intersectResultToMapPoint(o),distance:Ie(o)?o.distanceInRenderSpace:0,layer:p}};return me.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}popupHitTest(e){return Ae(this,e).then((({results:t,ground:i})=>{let r=null;return!(0===t.length||Math.abs(y(t[0].distance,0)-i.distance)<1e-5)||i.layer&&"integrated-mesh"===i.layer.type||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}}))}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(m(e.parent))throw new o("view:no-analysisview-for-analysis","The analysis has not been added to an AnalysisLayer or SceneView.analyses",{analysis:e});if("analysis"===e.parent.type){return(await this.whenLayerView(e.parent)).whenAnalysisView(e)}return this.analysisViewManager.whenAnalysisView(e)}whenLayerView(e){return super.whenLayerView(e)}takeScreenshot(e){return this.whenReady().then((()=>{const t=De(e,this);for(const e of this.map.allLayers.items)"voxel"===e.type&&(t.renderScreenshotTwice=!0);return t.pixelRatio/=this.pixelRatio,this._stage.renderView.takeScreenshot(Fe(t,this.supersampleScreenshotsEnabled,this.padding))}))}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return te.importLayerView(e)}hasLayerViewModule(e){return te.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var e,t,i,r;return this.map&&"initialViewProperties"in this.map&&(null==(e=this.map)||null==(t=e.initialViewProperties)?void 0:t.spatialReference)||(null==(i=this.defaultsFromMap)?void 0:i.spatialReference)||(null==(r=this.defaultsFromMap)?void 0:r.ready)&&this._initialDefaultSpatialReference||null}async validate(){let e=ke();if(d("safari")&&d("safari")<9&&(e=new o("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:d("safari")})),f(e))throw Ze.warn("#validate()",e.message),e}get _predeterminedViewingMode(){var e,t;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):null!=(e=this.map&&"initialViewProperties"in this.map?null==(t=this.map.initialViewProperties)?void 0:t.viewingMode:null)?e:null;return f(i)?ee(i):null}getSpatialReferenceSupport({spatialReference:e,layer:t}){const i=this._predeterminedViewingMode;if(f(i))return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,2),s=this._validateSpatialReferenceForViewingMode(e,t,1);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,2)}:{constraints:this._makeSpatialReferenceConstraints(e,t,1)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!!ze(e,i)&&(!!m(t)||(!B(t)||!m(Oe(t,e,i)))&&("voxel"!==t.type||2===i))}_makeSpatialReferenceConstraints(e,t,i){return t&&!B(t)&&"voxel"!==t.type&&(e.isWebMercator||e.isWGS84)?[{spatialReference:e,viewingMode:i},{spatialReference:e.isWebMercator?$e.WGS84:$e.WebMercator,viewingMode:i}]:[{spatialReference:e,viewingMode:i}]}_validateSpatialReference(e){const t=f(this.getSpatialReferenceSupport({spatialReference:e})),i=this._predeterminedViewingMode;return t||(f(i)?Ze.warnOnce(`Spatial reference defined on view not supported in ${Y(i)} viewing mode.`):e.isGeographic&&Ze.warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise((e=>{this.ready?e(this):this._resolveWhenReady.push(e)}))}computeMapPointFromVec3d(e,t){let i=this.spatialReference||$e.WGS84;return A(e,this.renderSpatialReference,e,i)||(i=$e.WGS84,A(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new Ke(e,i),t}trackGraphicState(e){if(!e.graphic)return Ze.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=t=>{!r&&f(t)&&"graphics3d"in t&&t.graphics3d&&t.graphics3d.graphicsCore&&(i=t.graphics3d.graphicsCore.trackGraphicState(e))};return f(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,f(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return p(e.map((e=>this.highlight(e))));if(n.isCollection(e))return p(e.toArray().map((e=>this.highlight(e))));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):h()}maskOccludee(e){if(!e)return Ze.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=t=>{!r&&f(t)&&"graphics3d"in t&&Le(t)&&(i=t.maskOccludee(e))};return f(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then((e=>s(e)),(()=>{})).catch((()=>{})),{remove:()=>{r=!0,f(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find((t=>t.layer===e.layer)):null}graphicChanged(e){f(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await S(this,"graphicsView"),this.graphicsView;if(!e.layer||!this.map)throw new o("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise(((t,i)=>{const r=this.map.allLayers.on("change",(s=>{-1!==s.added.indexOf(e.layer)&&(r.remove(),this.whenLayerView(e.layer).then(t,i))}))})):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,0),i=this._externalToInternalRenderItems(e.exclude,1);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(tt)?(t=this.computeMapPointFromVec3d(tt,t),2===e.intersector&&this.basemapTerrain&&(t.z=y(ye(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const n=e[s],a=Ge(n,this);if(f(a)&&(a===this.map.ground||"type"in a&&"integrated-mesh"===a.type))break;const o=He(n,this);if(!f(o))continue;if(m(r)&&s!==e.length-1&&(r=new Set),f(r)){const e=this._getGraphicFilterUid(o);if(r.has(e))continue;r.add(e)}if(!this._testGraphicUidFilter(t,o))continue;const l=this._intersectResultToMapPoint(n),p=n.distanceInRenderSpace;i.push({graphic:o,mapPoint:l,distance:p})}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return`u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return m(e)||(m(e.include)||e.include.has(i))&&(m(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,s={layerUids:null,graphicUids:null}){if(!e)return s;if(e instanceof i)Ye(s,this._getGraphicFilterUid(e)),0===t&&(f(this.graphicsView)&&e.layer===this?Xe(s,this.graphicsView.graphics3d.layer.id):e.layer&&Xe(s,e.layer.uid));else if(c(e))for(const i of e)i===this.graphics&&f(this.graphicsView)?Xe(s,this.graphicsView.graphics3d.layer.id):i instanceof r?i===this.map.ground&&Xe(s,Ue):this._externalToInternalRenderItems(i,t,s);else Xe(s,e.uid);return s}_initBasemapTerrain(){this._set("basemapTerrain",new Te({view:this})),this._set("elevationProvider",new ge({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Ve({view:this})),this._set("featureTiles",new he({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{const e=this.basemapTerrain&&this.basemapTerrain.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const e=f(this.basemapTerrain.extent)?G(F(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;f(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(e):this.featureTiles.filterExtent=e}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(me,"FEATURE_TILE_TREE_SHOW_TILES",(e=>{e&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import("./3d/layers/support/FeatureTileTree3DDebugger.js")).then((({FeatureTileTree3DDebugger:e})=>{!this.featureTreeDebugger&&me.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new e({view:this}))})):e||!this.featureTreeDebugger||me.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)}),3),this.updatingHandles.add(this,"clippingArea",e,3),this.updatingHandles.add(this,"basemapTerrain.extent",e,3)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new ve(this.map,e));const t=this.state.isGlobal,i=z(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",be.create(this.state.viewingMode,i)),t||this.handles.add(this.watch("basemapTerrain.extent",(e=>{const t=this.renderCoordsHelper.spatialReference;0===e[0]&&0===e[1]&&0===e[2]&&0===e[3]||!L(e,this.basemapTerrain.spatialReference,rt,t)||(this.renderCoordsHelper.extent=rt)}),!0),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Ee/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){f(e)&&4===e.type||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach((e=>{e.destroyed||(this.handles.add([e.watch(["updating","updatingProgress"],(()=>this.updatingChanged()),!0)],"updatingMonitors"),e.when((()=>this.updatingChanged()),(()=>this.updatingChanged())))})),this.updatingChanged())}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(e,t)=>this._renderScreenshotOverlay(e,t)}},t=new ue(this.state.viewingMode,(e=>this._stage.layers.forAll(e)),this);this._set("sceneIntersectionHelper",t);const i=a(this.surface),{resourceController:r,state:s,renderSpatialReference:n}=this;this._stage=new Pe({options:e,container:i,resourceController:r,state:s,sceneIntersectionHelper:t,renderSR:n}),this._lostWebGLContextHandle=l(this._stage.renderView.canvas,"webglcontextlost",(()=>this.fatalError=new o("webgl-context-lost"))),this.handles.add([this.updatingHandles.add(this.qualitySettings,"antialiasingEnabled",(()=>{this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})}),2),this.updatingHandles.add(this.qualitySettings,"highQualityTransparency",(()=>{this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency})}),2),b(this,"magnifier",(e=>this._stage.renderView.magnifier=e),!0)],"stage");const p=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:we.toEngineOptions(this.highlightOptions)})};for(const a of["highlightOptions","highlightOptions.color","highlightOptions.haloColor","highlightOptions.haloOpacity","highlightOptions.fillOpacity","highlightOptions.shadowOpacity","highlightOptions.shadowColor","highlightOptions.shadowDifference"])this.handles.add(this.updatingHandles.add(this,a,p),"stage");p(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Ee/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new xe({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new pe})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController)return;if(0===this.graphics.length)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this.updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this.updatingChanged()}async _createGraphicsViewAsync(e){const t=(await import("./3d/layers/GraphicsView3D.js")).default;w(e),await M(this.basemapTerrain,"ready",e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),f(this.graphicsView)&&(this.handles.remove(this.graphicsView.graphics3d.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=ee(this.viewingMode);if(1===e&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.handles.add(_(this,"graphics","after-changes",(()=>this._createGraphicsViewIfNeeded())),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const e=this.get("map.initialViewProperties.environment");e&&(this.environment=e)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach((e=>e(this)))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Ue);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Ue);for(const e of this.map.allLayers.items)"integrated-mesh"===e.type&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid)}}getVoxelWasmPerSceneView(){return N.getInstance().getVoxelWasmPerSceneView(this)}};function Xe(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function Ye(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function et(e,t){return f(e)&&H(e.spatialReference,t)?G(e,t):null}e([C()],Je.prototype,"_userClippingArea",void 0),e([C()],Je.prototype,"_resourceController",void 0),e([C()],Je.prototype,"_stage",void 0),e([C({readOnly:!0})],Je.prototype,"deconflictor",void 0),e([C({readOnly:!0})],Je.prototype,"labeler",void 0),e([C({type:X,readOnly:!0,aliasOf:"state.animation"})],Je.prototype,"animation",void 0),e([C({readOnly:!0})],Je.prototype,"basemapTerrain",void 0),e([C({readOnly:!0})],Je.prototype,"elevationProvider",void 0),e([C({type:t,aliasOf:"stateManager.camera"})],Je.prototype,"camera",void 0),e([C({type:t,aliasOf:"stateManager.contentCamera"})],Je.prototype,"contentCamera",void 0),e([C({readOnly:!0})],Je.prototype,"canvas",void 0),e([C({type:Ke,aliasOf:"stateManager.center"})],Je.prototype,"center",void 0),e([C({type:Qe})],Je.prototype,"clippingArea",null),e([C({type:re})],Je.prototype,"constraints",void 0),e([C({type:Qe,readOnly:!0})],Je.prototype,"renderDataExtent",null),e([C({type:Qe,readOnly:!0})],Je.prototype,"dataExtent",null),e([C({type:Qe,readOnly:!0})],Je.prototype,"groundAndLayersExtent",null),e([C({value:null,type:se})],Je.prototype,"environment",null),e([O("environment")],Je.prototype,"castEnvironment",null),e([C({readOnly:!0})],Je.prototype,"environmentManager",void 0),e([C({type:Qe,aliasOf:"stateManager.extent"})],Je.prototype,"extent",void 0),e([C()],Je.prototype,"floors",void 0),e([C({readOnly:!0,aliasOf:"stateManager.screenCenter"})],Je.prototype,"screenCenter",void 0),e([C({type:Number})],Je.prototype,"pixelRatio",null),e([C({type:Number,dependsOn:["qualitySettings.maximumPixelRatio","qualitySettings.maximumRenderResolution","size"]})],Je.prototype,"maximumPixelRatio",null),e([C({aliasOf:"stateManager.frustum"})],Je.prototype,"frustum",void 0),e([C({type:Number,readOnly:!0})],Je.prototype,"fullOpacity",void 0),e([C({readOnly:!0})],Je.prototype,"graphicsView",void 0),e([C({readOnly:!0})],Je.prototype,"analysisViewManager",void 0),e([C()],Je.prototype,"groundView",void 0),e([C({type:Boolean})],Je.prototype,"initialExtentRequired",null),e([C()],Je.prototype,"_defaultsFromMapSettings",null),e([C({type:Boolean,readOnly:!0})],Je.prototype,"interacting",null),e([C()],Je.prototype,"stationary",null),e([C({aliasOf:"state.navigating"})],Je.prototype,"navigating",void 0),e([C()],Je.prototype,"map",void 0),e([C({readOnly:!0})],Je.prototype,"mapCoordsHelper",void 0),e([C({aliasOf:"stateManager.padding"})],Je.prototype,"padding",void 0),e([C({type:Ve,readOnly:!0})],Je.prototype,"pointsOfInterest",void 0),e([C({type:he,readOnly:!0})],Je.prototype,"featureTiles",void 0),e([C()],Je.prototype,"featureTreeDebugger",void 0),e([C({type:Boolean})],Je.prototype,"screenSizePerspectiveEnabled",void 0),e([C({constructOnly:!0})],Je.prototype,"deactivatedWebGLExtensions",void 0),e([C({constructOnly:!0})],Je.prototype,"debugWebGLExtensions",void 0),e([C({constructOnly:!0})],Je.prototype,"renderCanvas",void 0),e([C({constructOnly:!0})],Je.prototype,"state",void 0),e([C({readOnly:!0})],Je.prototype,"inputManager",void 0),e([C({readOnly:!0})],Je.prototype,"stateManager",void 0),e([C({type:["low","medium","high"]})],Je.prototype,"qualityProfile",null),e([C({type:Se,get(){let e=this._get("qualitySettings");return e||(e=new Se,fe.apply(this.qualityProfile,e)),e}})],Je.prototype,"qualitySettings",void 0),e([C()],Je.prototype,"slicePlane",null),e([C({readOnly:!0})],Je.prototype,"typeSpecificPreconditionsReady",null),e([C({readOnly:!0})],Je.prototype,"renderCoordsHelper",void 0),e([C({readOnly:!0})],Je.prototype,"sceneIntersectionHelper",void 0),e([C({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Je.prototype,"resolution",null),e([C({type:Number,aliasOf:"stateManager.scale"})],Je.prototype,"scale",void 0),e([C()],Je.prototype,"heightModelInfo",null),e([C()],Je.prototype,"spatialReference",void 0),e([C({type:Boolean,constructOnly:!0})],Je.prototype,"alphaCompositingEnabled",void 0),e([C({type:Boolean})],Je.prototype,"supersampleScreenshotsEnabled",void 0),e([C({readOnly:!0})],Je.prototype,"type",void 0),e([C({type:Ne})],Je.prototype,"ui",void 0),e([C({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating"]})],Je.prototype,"updating",null),e([C({type:Number,readOnly:!0,dependsOn:["updating"]})],Je.prototype,"updatingProgress",void 0),e([C({type:["global","local"]})],Je.prototype,"viewingMode",null),e([C({type:s,aliasOf:"stateManager.viewpoint"})],Je.prototype,"viewpoint",void 0),e([C({type:Number,aliasOf:"stateManager.zoom"})],Je.prototype,"zoom",void 0),e([C({type:we})],Je.prototype,"highlightOptions",void 0),Je=e([P("esri.views.SceneView")],Je);const tt=E(),it=T(),rt=D(),st=Je;export{st as default};
