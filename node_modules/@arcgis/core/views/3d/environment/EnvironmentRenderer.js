/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../core/Accessor.js";import"../../../core/has.js";import s from"../../../core/Handles.js";import{equalsShallow as i}from"../../../core/lang.js";import{lerp as r}from"../../../core/mathUtils.js";import{isSome as o,destroyMaybe as n,applySome as h,isNone as a}from"../../../core/maybe.js";import{react as p,syncAndInitial as d}from"../../../core/reactiveUtils.js";import{when as l}from"../../../core/watchUtils.js";import{property as m}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/accessorSupport/ensureType.js";import{subclass as _}from"../../../core/accessorSupport/decorators/subclass.js";import{l as u}from"../../../chunks/vec3.js";import{getReferenceEllipsoid as c}from"../../../geometry/projectionEllipsoid.js";import{isMoon as g,isEarth as v}from"../../../geometry/support/spatialReferenceUtils.js";import{ChapmanAtmosphere as w}from"./ChapmanAtmosphere.js";import{CloudsComposition as y}from"./CloudsComposition.js";import{CloudsGenerator as f,cloudPresets as A}from"./CloudsGenerator.js";import{Fog as C}from"./Fog.js";import{PanoramicAtmosphere as R}from"./PanoramicAtmosphere.js";import b from"./SimpleAtmosphere.js";import{Stars as j}from"./Stars.js";const x=[12,13];let T=class extends t{constructor(e){super(e),this._handles=new s,this._context=null,this._pendingAtmosphere=null,this._atmosphere=null,this._stars=null,this._clouds=null,this._cloudComposition=null,this._fog=null}get atmosphereType(){return o(this._pendingAtmosphere)?this._pendingAtmosphere.type:o(this._atmosphere)?this._atmosphere.type:"none"}get canRender(){var e;return!(null==(e=this.view.basemapTerrain)||!e.renderer.canRender)||"global"!==this.view.viewingMode}get needsLinearDepth(){return"realistic"===this._selectAtmosphereType()}get updating(){return o(this._pendingAtmosphere)||o(this._stars)&&this._stars.updating||o(this._clouds)&&this._clouds.running}get weatherEnabled(){var e;return!(null==(e=this.view.environmentManager)||!e.weatherEnabled)}initialize(){this.view._stage.addRenderPlugin(x,this)}destroy(){this._pendingAtmosphere=n(this._pendingAtmosphere),this.uninitializeRenderContext(),this._handles=n(this._handles),this.view&&null!=this.view._stage&&(this.view._stage.removeRenderPlugin(this),this._set("view",null))}initializeRenderContext(e=null){this._context=e,this._handles.add([l(this.view,"basemapTerrain",(()=>this._updateBasemapTerrain()),!0),p((()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality})),(()=>this._updateAtmosphere()),d),p((()=>this._starsCreationParameters),(e=>this._createOrDestroyStars(e)),{sync:!0,initial:!0,equals:i}),p((()=>this._cloudsCreationParameters),(e=>this._createOrDestroyClouds(e)),{sync:!0,initial:!0,equals:i}),p((()=>this._fogCreationParameters),(e=>this._createOrDestroyFog(e)),{sync:!0,initial:!0,equals:i}),p((()=>this._weatherUpdateParameters),(e=>{this._updateWeather(e),this._updateFog(e)}),d)])}uninitializeRenderContext(){this._stars=n(this._stars),this._atmosphere=n(this._atmosphere),this._clouds=n(this._clouds),this._cloudComposition=n(this._cloudComposition),this._fog=n(this._fog)}render(e){if(0!==e.pass)return!1;let t=!1;switch(e.slot){case 12:o(this._stars)&&this._stars.render(e)&&(t=!0),o(this._atmosphere)&&this._atmosphere.canRender&&(this._atmosphere.render(e)&&(t=!0),o(this._clouds)&&o(this._clouds.cubeMap)&&!this._clouds.running&&o(this._cloudComposition)&&("sunny"!==this.view.environment.weather.type||0!==this.view.environment.weather.cloudCover)&&(this._cloudComposition.render(e,this._clouds.cubeMap,o(this.view.animation),this._clouds.coverage,this._clouds.absorption)&&(t=!0),this._cloudComposition.isFading()&&this._setNeedsRender()));break;case 13:if(o(this._atmosphere)&&this._atmosphere.canRender){const s=this.weatherEnabled?this.view.environment.weather.type:"disabled";this._atmosphere.renderHaze(e,"rainy"===s)&&(t=!0),o(this._fog)&&("foggy"!==s&&"realistic"===this._selectAtmosphereType()||this._fog.render(e,"foggy"===s,"rainy"===s)&&(t=!0))}break;default:return!1}return t}get _cloudsCreationParameters(){return this.weatherEnabled?{view:this.view,viewingMode:this.view.state.viewingMode,rctx:o(this._context)?this._context.renderContext.rctx:null,radius:c(this.view.spatialReference).radius}:null}_createOrDestroyClouds(e){this._clouds=n(this._clouds),this._cloudComposition=n(this._cloudComposition),h(e,(({view:e,viewingMode:t,rctx:s,radius:i})=>{this._clouds=new f({rctx:s,view:e,requestRender:()=>this._setNeedsRender()}),this._cloudComposition=new y(s,t,i,u(e.state.camera.eye)-i)})),this._setNeedsRender()}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return a(e)?null:{type:e.type,presetAdjustment:"foggy"===e.type?e.fogStrength:e.cloudCover}}_updateWeather(e){if(a(e)||a(this._clouds))return;const t=A[e.type].median;for(const s in A[e.type])if("raymarchingStepType"===s)this._clouds[s]=A[e.type][s];else if("median"!==s){const i=A[e.type][s],o=r(i[0],i[1],t);this._clouds[s]=e.presetAdjustment<.5?r(i[0],o,2*e.presetAdjustment):r(o,i[1],2*(e.presetAdjustment-.5))}}_setNeedsRender(){o(this._context)&&this._context.requestRender()}get _starsCreationParameters(){var e,t,s;return{view:this.view,starsEnabled:null!=(e=null==(t=this.view)||null==(s=t.environment)?void 0:s.starsEnabled)&&e}}_createOrDestroyStars({view:e,starsEnabled:t}){t&&a(this._stars)?(this._stars=new j({view:e,requestRender:()=>this._setNeedsRender()}),this._setNeedsRender()):!t&&o(this._stars)&&(this._stars.destroy(),this._stars=null,this._setNeedsRender())}_updateFog(e){a(this._fog)||a(e)||("foggy"===e.type?this._fog.strength=r(3e-5,.005,e.presetAdjustment**3):this._fog.strength=4e-6)}get _fogCreationParameters(){return!this.weatherEnabled||a(this._context)?null:{view:this.view,context:this._context}}_createOrDestroyFog(e){this.weatherEnabled&&a(this._fog)?(h(e,(({view:e,context:t})=>{this._fog=new C(t,e)})),this._updateFog(this._weatherUpdateParameters),this._setNeedsRender()):o(this._fog)&&(this._fog.destroy(),this._fog=null,this._setNeedsRender())}_updateAtmosphere(){const e=this._selectAtmosphereType();if(this.atmosphereType===e)return;o(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return o(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const s=new t(this.view);o(this._context)&&s.initializeRenderContext(this._context),a(this._atmosphere)&&(this._atmosphere=s,this._setNeedsRender()),this._pendingAtmosphere=s,s.when().then((()=>{o(this._atmosphere)&&this._pendingAtmosphere&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()})).catch((()=>{this._pendingAtmosphere===s&&(this._pendingAtmosphere=null)}))}_getAtmosphereClass(){switch(this._selectAtmosphereType()){case"none":return null;case"realistic":return w;case"panoramic":return R;case"simple":return b;default:return}}_selectAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),s=this.view.viewingMode;return!e||null==t||g(this.view.spatialReference)?"none":"local"===s?"panoramic":"high"===t&&o(this._context)&&w.isSupported(this._context)&&v(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=o(this._atmosphere)&&"simple"===this.atmosphereType)}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType()}}};e([m({constructOnly:!0})],T.prototype,"view",void 0),e([m({type:Boolean,readOnly:!0})],T.prototype,"updating",null),e([m()],T.prototype,"_pendingAtmosphere",void 0),e([m()],T.prototype,"_stars",void 0),e([m()],T.prototype,"_clouds",void 0),e([m()],T.prototype,"_cloudComposition",void 0),e([m()],T.prototype,"_fog",void 0),e([m()],T.prototype,"weatherEnabled",null),e([m()],T.prototype,"_cloudsCreationParameters",null),e([m()],T.prototype,"_weatherUpdateParameters",null),e([m()],T.prototype,"_starsCreationParameters",null),e([m()],T.prototype,"_fogCreationParameters",null),T=e([_("esri.views.3d.environment.EnvironmentRenderer")],T);export{T as EnvironmentRenderer};
