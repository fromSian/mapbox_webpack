/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{clamp as a}from"../../../core/mathUtils.js";import{releaseMaybe as t,disposeMaybe as s,isNone as r}from"../../../core/maybe.js";import{b as e,e as i}from"../../../chunks/mat4.js";import{c as o}from"../../../chunks/mat4f64.js";import{z as n,g as h,n as d,a as m,l as _,f as c}from"../../../chunks/vec3.js";import{c as f,f as I}from"../../../chunks/vec3f64.js";import{create as F,fromPoints as P,axis as u}from"../../../geometry/support/axisAngle.js";import{CloudsCompositionTechnique as l}from"./CloudsCompositionTechnique.js";import{createQuadVAO as g}from"../webgl-engine/lib/glUtil3D.js";var O,H,S,x;!function(a){a[a.FINISHED=0]="FINISHED",a[a.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",a[a.FADE_IN=2]="FADE_IN"}(O||(O={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.FADE_OUT=1]="FADE_OUT",a[a.FADE_IN=2]="FADE_IN"}(H||(H={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.CROSS_FADE=1]="CROSS_FADE"}(S||(S={})),function(a){a[a.FINISHED=0]="FINISHED",a[a.HEIGHT_FADE=1]="HEIGHT_FADE"}(x||(x={}));class p{constructor(a,t,s,r){this._viewingMode=t,this._inverseProjectionMatrix=o(),this._inverseViewMatrix=o(),this._cameraPositionLastFrame=f(),this._technique=new l({rctx:a,viewingMode:this._viewingMode},null),this._vao=g(a),this._setDefaultParallax(s,r)}destroy(){this._technique=t(this._technique),this._vao=s(this._vao)}render(a,t,s,i,o){const n=a.camera;if(r(this._vao)||r(n))return!1;const h=a.rctx,d=this._technique.program;return h.useProgram(d),this._technique.bindPipelineState(h),this._isCameraAnimating=s,a.scenelightingData.setLightDirectionUniform(d),a.scenelightingData.setUniforms(d),e(this._inverseProjectionMatrix,n.projectionMatrix),e(this._inverseViewMatrix,n.viewMatrix),d.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),d.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),d.bindTexture(t.colorTexture,"cubeMap"),d.setUniform2fv("cloudVariables",[i,o]),this._setParallaxParams(n.eye),this._bindParallaxParams(d,a.camera),h.bindVAO(this._vao),d.assertCompatibleVertexAttributeLocations(this._vao),h.drawArrays(5,0,4),!0}isFading(){return this._crossFadeParams.crossFadeStage!==S.FINISHED||this._fadeInOutParams.fadeInOutStage!==H.FINISHED||this._fadeInParams.fadeInStage!==O.FINISHED||this._fadeInOutHeightParams.fadeHeightStage!==x.FINISHED}_setDefaultParallax(a,t){this._parallaxParams={anchorPointClouds:f(),radius:a,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:o()},this._parallaxParamsNew={anchorPointClouds:f(),radius:a,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:o()},this._crossFadeParams={crossFadeStage:S.FINISHED,crossFadeFactor:0,distanceThresholdFactor:.3},this._fadeInOutParams={fadeInOutStage:H.FINISHED,fadeInOutFactor:0,distanceThresholdFactor:.6},this._fadeInParams={fadeInStage:O.FINISHED,fadeInFactor:0,distanceThresholdFactor:2},this._fadeInOutHeightParams={fadeHeightStage:x.FINISHED,fadeHeightFactor:t>1e4?1:0,heightThresholdFactor:1e4}}_isCameraPositionFinal(a){return n(this._cameraPositionLastFrame,a)}_setFadeInStage(a){const t=this._isCameraPositionFinal(a);this._fadeInParams.fadeInStage===O.FINISHED&&(this._fadeInParams.fadeInFactor=1,h(this._parallaxParams.anchorPointClouds,N),this._fadeInParams.fadeInStage=O.CHANGE_ANCHOR,this._crossFadeParams.crossFadeStage=S.FINISHED,this._fadeInOutParams.fadeInOutStage=H.FINISHED),this._fadeInParams.fadeInStage===O.CHANGE_ANCHOR&&t&&(h(this._parallaxParams.anchorPointClouds,N),this._fadeInParams.fadeInStage=O.FADE_IN,this._startTime=performance.now()),this._fadeInParams.fadeInFactor>0&&this._fadeInParams.fadeInStage===O.FADE_IN&&(this._fadeInParams.fadeInFactor=1-(performance.now()-this._startTime)/500),this._fadeInParams.fadeInFactor<=0&&this._fadeInParams.fadeInStage===O.FADE_IN&&(this._fadeInParams.fadeInStage=O.FINISHED,this._fadeInParams.fadeInFactor=0)}_setCrossFadingStage(){this._crossFadeParams.crossFadeStage===S.FINISHED&&(h(this._parallaxParamsNew.anchorPointClouds,N),this._startTime=performance.now(),this._crossFadeParams.crossFadeFactor=0,this._crossFadeParams.crossFadeStage=S.CROSS_FADE),this._crossFadeParams.crossFadeFactor<1&&this._crossFadeParams.crossFadeStage===S.CROSS_FADE&&(this._crossFadeParams.crossFadeFactor=(performance.now()-this._startTime)/500),this._crossFadeParams.crossFadeFactor>=1&&this._crossFadeParams.crossFadeStage===S.CROSS_FADE&&(this._crossFadeParams.crossFadeStage=S.FINISHED,this._crossFadeParams.crossFadeFactor=1,h(this._parallaxParams.anchorPointClouds,this._parallaxParamsNew.anchorPointClouds))}_setFadeInOutStage(a){this._fadeInOutParams.fadeInOutStage===H.FINISHED&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=0,this._fadeInOutParams.fadeInOutStage=H.FADE_OUT),this._fadeInOutParams.fadeInOutFactor<1&&this._fadeInOutParams.fadeInOutStage===H.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=(performance.now()-this._startTime)/250),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===H.FADE_OUT&&(this._fadeInOutParams.fadeInOutFactor=1,h(this._parallaxParams.anchorPointClouds,N)),this._fadeInOutParams.fadeInOutFactor>=1&&this._fadeInOutParams.fadeInOutStage===H.FADE_OUT&&this._isCameraPositionFinal(a)&&(this._startTime=performance.now(),this._fadeInOutParams.fadeInOutFactor=1,this._fadeInOutParams.fadeInOutStage=H.FADE_IN,this._crossFadeParams.crossFadeStage=S.FINISHED,this._crossFadeParams.crossFadeFactor=0),this._fadeInOutParams.fadeInOutFactor>0&&this._fadeInOutParams.fadeInOutStage===H.FADE_IN&&(this._fadeInOutParams.fadeInOutFactor=1-(performance.now()-this._startTime)/500),this._fadeInOutParams.fadeInOutFactor<=0&&this._fadeInOutParams.fadeInOutStage===H.FADE_IN&&(this._fadeInOutParams.fadeInOutStage=H.FINISHED,this._fadeInOutParams.fadeInOutFactor=0)}_setFadeInOutHeight(t){const s=performance.now();this._startTimeHeightFade=this._fadeInOutHeightParams.fadeHeightStage===x.FINISHED?s:this._startTimeHeightFade,t?this._fadeInOutHeightParams.fadeHeightFactor+=(s-this._startTimeHeightFade)/500:this._fadeInOutHeightParams.fadeHeightFactor-=(s-this._startTimeHeightFade)/500,this._startTimeHeightFade=s,this._fadeInOutHeightParams.fadeHeightFactor=a(this._fadeInOutHeightParams.fadeHeightFactor,0,1),this._fadeInOutHeightParams.fadeHeightStage=x.HEIGHT_FADE}_setParallaxParams(a){d(N,a),m(N,N,this._parallaxParams.radius),0===this._parallaxParams.anchorPointClouds[0]&&0===this._parallaxParams.anchorPointClouds[1]&&0===this._parallaxParams.anchorPointClouds[2]&&h(this._parallaxParams.anchorPointClouds,N);const t=_(c(C,this._parallaxParams.anchorPointClouds,N));let s=!0;t>this._fadeInParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInParams.fadeInStage!==O.FINISHED?this._setFadeInStage(a):t>this._fadeInOutParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight||this._fadeInOutParams.fadeInOutStage!==H.FINISHED?this._setFadeInOutStage(a):t>this._crossFadeParams.distanceThresholdFactor*this._parallaxParams.cloudsHeight&&!this._isCameraAnimating||this._crossFadeParams.crossFadeStage!==S.FINISHED?this._setCrossFadingStage():s=!1;const r=_(a),e=r-this._parallaxParams.radius;(e>1.7*this._fadeInOutHeightParams.heightThresholdFactor||e<-1*this._fadeInOutHeightParams.heightThresholdFactor)&&this._fadeInOutHeightParams.fadeHeightFactor<1?this._fadeInOutHeightParams.fadeHeightFactor=1:(e>this._fadeInOutHeightParams.heightThresholdFactor||e<-.35*this._fadeInOutHeightParams.heightThresholdFactor)&&this._fadeInOutHeightParams.fadeHeightFactor<1?this._setFadeInOutHeight(!0):e<this._fadeInOutHeightParams.heightThresholdFactor&&e>-.35*this._fadeInOutHeightParams.heightThresholdFactor&&this._fadeInOutHeightParams.fadeHeightFactor>0?this._setFadeInOutHeight(!1):this._fadeInOutHeightParams.fadeHeightStage=x.FINISHED,this._parallaxParams.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(r*r-this._parallaxParams.radius*this._parallaxParams.radius,0))/r,P(E,this._parallaxParams.anchorPointClouds,D),this._parallaxParams.transform=o(),i(this._parallaxParams.transform,this._parallaxParams.transform,D[3],u(D)),s&&(P(E,this._parallaxParamsNew.anchorPointClouds,D),this._parallaxParamsNew.transform=o(),i(this._parallaxParamsNew.transform,this._parallaxParamsNew.transform,D[3],u(D))),h(this._cameraPositionLastFrame,a)}_bindParallaxParams(t,s){t.setUniform1f("cloudsHeight",this._parallaxParams.cloudsHeight),t.setUniformMatrix4fv("rotationMatrixClouds",this._parallaxParams.transform),t.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",this._parallaxParamsNew.transform),t.setUniform3fv("anchorPosition",this._parallaxParams.anchorPointClouds),t.setUniform3fv("anchorPositionCrossFade",this._parallaxParamsNew.anchorPointClouds),this._fadeInOutParams.fadeInOutStage!==H.FINISHED?t.setUniform1f("totalFadeInOut",this._fadeInOutHeightParams.fadeHeightFactor+Math.max(a(this._fadeInOutParams.fadeInOutFactor,0,1))):t.setUniform1f("totalFadeInOut",this._fadeInOutHeightParams.fadeHeightFactor+Math.max(a(this._fadeInParams.fadeInFactor,0,1))),t.setUniform1f("radiusCurvatureCorrectionFactor",this._parallaxParams.radiusCurvatureCorrectionFactor),t.setUniform1i("crossFade",this._crossFadeParams.crossFadeStage),t.setUniform1f("crossFadeAnchorFactor",a(this._crossFadeParams.crossFadeFactor,0,1)),t.setUniform1f("radius",this._parallaxParams.radius),t.setUniform3fv("cameraPosition",s.eye)}}const E=I(0,0,1),D=F(),N=f(),C=f();export{p as CloudsComposition};
