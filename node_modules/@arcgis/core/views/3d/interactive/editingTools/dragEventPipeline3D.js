/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{isSome as e,isNone as r,unwrapOr as t}from"../../../../core/maybe.js";import{screenPointObjectToArray as n,castScreenPointArray as o,createScreenPointArray as s}from"../../../../core/screenUtils.js";import{g as c,l,f as a,d as i,a as u,b as p,c as d}from"../../../../chunks/vec3.js";import{c as m}from"../../../../chunks/vec3f64.js";import{projectPoint as f}from"../../../../geometry/projection.js";import{intersectRay as g,fromPositionAndNormal as y,create as S}from"../../../../geometry/support/plane.js";import{create as j}from"../../../../geometry/support/ray.js";import{projectPoint as E}from"../../../../geometry/support/vector.js";import{sv2d as v}from"../../../../geometry/support/vectorStacks.js";import{getZForElevationMode as x,getGraphicEffectiveElevationInfo as b}from"../../../../support/elevationInfoUtils.js";import{fromScreen as w}from"../../support/geometryUtils/ray.js";import{newIntersector as I}from"../../webgl-engine/lib/Intersector.js";import{TERRAIN_ID as C}from"../../webgl-engine/lib/verticalOffsetUtils.js";import{EventPipeline as H}from"../../../interactive/dragEventPipeline.js";function P(e,r){return h(e,(()=>r))}function U(e){return h(e,(e=>e.plane))}function h(t,s){const c=m(),l=m();let a=!1;return i=>{const u=s(i);if("start"===i.action){const r=n(i.screenStart,o(v.get())),s=w(t.state.camera,r,J);e(s)&&(a=g(u,s,c))}if(!a)return null;const p=n(i.screenEnd,o(v.get())),d=w(t.state.camera,p,J);return r(d)?null:g(u,d,l)?{...i,renderStart:c,renderEnd:l,plane:u,ray:d}:null}}function k(t,n,o,c=null,l=null){let a=null;return i=>{if("start"===i.action&&(a=t.sceneIntersectionHelper.intersectElevationFromScreen(s(i.screenStart.x,i.screenStart.y),n,o,l),e(a)&&e(c)&&!f(a,a,c)))return null;if(r(a))return null;const u=t.sceneIntersectionHelper.intersectElevationFromScreen(s(i.screenEnd.x,i.screenEnd.y),n,o,l);return e(u)?e(c)&&!f(u,u,c)?null:{...i,mapStart:a,mapEnd:u}:null}}function M(e,r,t,n=null,o=null){return k(e,t,x(r,e,t),n,o)}function R(e,r,t,n=null,o=null){return M(e,t,b(r),n,o)}function F(r,t,n,o){const s=t.toMap(r.screenStart,{include:[n]});return e(s)?R(t,n,s,o):null}function T(e,r){const t=z,n=B,o=S();e.renderCoordsHelper.worldUpAtPosition(r,t);const s=d(o,t,a(n,r,e.state.camera.eye));return d(s,s,t),y(r,s,o)}function A(e,r,t){let n=null;const o=new H;return o.next(P(e,T(e,r))).next(D(e,r)).next(q(e,t)).next((e=>{e.mapEnd.x=e.mapStart.x,e.mapEnd.y=e.mapStart.y,n=e})),e=>(n=null,o.execute(e),n)}function D(e,r){const t=m(),n=l(r);e.renderCoordsHelper.worldUpAtPosition(r,t);const o=m(),s=m(),d=o=>{if(a(o,o,r),E(t,o,o),"global"===e.viewingMode){l(o)*Math.sign(i(t,o))<.001-n&&a(o,u(o,t,.001),r)}return p(o,o,r),o};return e=>(e.renderStart=d(c(o,e.renderStart)),e.renderEnd=d(c(s,e.renderEnd)),e)}function q(r,t){const n=r.renderCoordsHelper;return r=>{const o=n.fromRenderCoords(r.renderStart,t),s=n.fromRenderCoords(r.renderEnd,t);return e(o)&&e(s)?{...r,mapStart:o,mapEnd:s}:null}}function G(r){let t=null;return n=>{switch(n.action){case"start":t=r.disableDisplay();break;case"end":case"cancel":e(t)&&(t.remove(),t=null)}return n}}function O(o,c=null){const l=I(o.state.viewingMode);l.options.selectionMode=!0,l.options.store=0,l.options.hud=!1;const a=s(),i={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},u=m(),p=t(c,o.spatialReference),d=e=>{o.map.ground&&o.map.ground.opacity<1?i.exclude.add(C):i.exclude.delete(C),o.sceneIntersectionHelper.intersectIntersectorScreen(n(e,a),l,i);const r=l.results.min;let t;if(r.getIntersectionPoint(u))t=2===r.intersector?0:1;else{if(!l.results.ground.getIntersectionPoint(u))return null;t=0}return{location:o.renderCoordsHelper.fromRenderCoords(u,p),surfaceType:t}};let f;return t=>{if("start"===t.action){const r=d(t.screenStart);f=e(r)?r.location:null}if(r(f))return null;const n=d(t.screenEnd);return e(n)&&e(n.location)?{...t,mapStart:f,mapEnd:n.location,surfaceType:n.surfaceType}:null}}const z=m(),B=m(),J=j();export{q as convertToMapCoordinates,G as hideManipulatorWhileDragging,D as projectToWorldUp,O as screenToMap3D,M as screenToMapXYAtLocation,F as screenToMapXYForGraphic,R as screenToMapXYForGraphicAtLocation,P as screenToRenderPlane,U as screenToRenderPlaneFromEvent,A as screenToZConstrained};
