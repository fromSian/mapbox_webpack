/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import"../../../../../geometry.js";import{neverReached as e}from"../../../../../core/compilerUtils.js";import t from"../../../../../core/Logger.js";import{rad2deg as i,deg2rad as r}from"../../../../../core/mathUtils.js";import{isNone as s,isSome as n,unwrapOr as o}from"../../../../../core/maybe.js";import{castRenderScreenPointArray3 as a}from"../../../../../core/screenUtils.js";import{r as c,i as l,f as u,m,d,a as p,g}from"../../../../../chunks/mat4.js";import{c as f}from"../../../../../chunks/mat4f64.js";import{r as b}from"../../../../../chunks/quat.js";import{a as h,g as y,d as w,c as j,n as M,b as v,l as k,f as P,p as R,s as x,v as U}from"../../../../../chunks/vec3.js";import{a as O,c as S,f as T}from"../../../../../chunks/vec3f64.js";import{tryProjectWithZConversion as C}from"../../../../../geometry/projection.js";import{r as E,f as L,i as F,c as A,n as z,u as G}from"../../../../../chunks/boundedPlane.js";import{fromPositionAndNormal as I,fromVectorsAndPoint as H}from"../../../../../geometry/support/plane.js";import{create as D}from"../../../../../geometry/support/ray.js";import{angleAroundAxis as B}from"../../../../../geometry/support/vector.js";import{sv3d as W,sm4d as V,sq4d as Z}from"../../../../../geometry/support/vectorStacks.js";import{Manipulator3D as q}from"../../Manipulator3D.js";import{calculateTranslateRotateFromBases as N}from"../../manipulatorUtils.js";import{SHIFT_RESTART_TIP_RADIUS as $,RESIZE_HANDLE_EDGE_PADDING_FRAC as J,SMALL_ANGLE_DOT_THRESHOLD as K,PLANE_MIN_BASIS_SCREEN_LEN2 as Q,INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION as X,SHIFT_RESTART_OFFSET_DISTANCE as Y,SHIFT_RESTART_ARROW_OUTLINE_WIDTH as _,SHIFT_RESTART_ARROW_TIP_COLOR as ee,SHIFT_RESTART_ARROW_CAP_COLOR as te,SHIFT_RESTART_TUBE_COLOR as ie,SHIFT_RESTART_OUTLINE_COLOR as re,SHIFT_RESTART_CALLOUT_COLOR as se,ROTATE_HEADING_OFFSET_DISTANCE as ne,ROTATE_HEADING_DISC_RADIUS as oe,ROTATE_HEADING_CALLOUT_COLOR as ae,PLANE_OUTLINE_COLOR as ce,PLANE_OUTLINE_WIDTH as le,PLANE_BACKGROUND_COLOR as ue,GRID_COLOR as me,RESIZE_HANDLE_CORNER_INPUT_RADIUS as de,RESIZE_HANDLE_EDGE_INPUT_RADIUS as pe,ROTATE_HEADING_TIP_LENGTH as ge,VERTICAL_DOT_THRESHOLD as fe,ROTATE_HEADING_DISC_RADIUS_FOCUS_MULTIPLIER as be,RESIZE_HANDLE_COLOR as he,DISPLAY_FOCUS_MULTIPLIER as ye,RESIZE_HANDLE_EDGE_WIDTH as we,SHIFT_RESTART_ARROW_LENGTH as je,SHIFT_RESTART_TUBE_RADIUS as Me,SHIFT_RESTART_TIP_LENGTH as ve,SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER as ke,SHIFT_RESTART_TIP_FOCUS_MULTIPLIER as Pe,RESIZE_HANDLE_CORNER_WIDTH as Re}from"./sliceToolConfig.js";import{LineVisualElement as xe}from"../../visualElements/LineVisualElement.js";import{SlicePlaneVisualElement as Ue}from"../../visualElements/SlicePlaneVisualElement.js";import{getElevationAtPoint as Oe}from"../../../support/ElevationProvider.js";import{RenderCoordsHelper as Se}from"../../../support/RenderCoordsHelper.js";import{fromRender as Te}from"../../../support/geometryUtils/ray.js";import{Geometry as Ce}from"../../../webgl-engine/lib/Geometry.js";import Ee from"../../../webgl-engine/lib/GeometryUtil.js";import{ColorMaterial as Le}from"../../../webgl-engine/materials/ColorMaterial.js";import{ImageMaterial as Fe}from"../../../webgl-engine/materials/ImageMaterial.js";import{NativeLineMaterial as Ae}from"../../../webgl-engine/materials/NativeLineMaterial.js";import{RibbonLineMaterial as ze}from"../../../webgl-engine/materials/RibbonLineMaterial.js";import Ge from"../../../../../widgets/Slice/SlicePlane.js";import Ie from"../../../../../geometry/Extent.js";const He=t.getLogger("esri.views.3d.interactive.analysisTools.slice.sliceToolUtils");function De(e,t,i,r,s,n,o,a){return Be(t,o.worldUpAtPosition(e,W.get()),s,n,a.basis1,a.basis2),h(a.basis1,a.basis1,i),h(a.basis2,a.basis2,r),y(a.origin,e),H(a.basis2,a.basis1,a.origin,a.plane),a}function Be(e,t,i,r,s,n){const o=w(e,t),a=W.get(),c=W.get();switch(0===r?Math.abs(o)>fe?1:2:r){case 2:{const r=Math.abs(o)<=K?e:i.viewUp;j(a,r,t),y(c,t);break}case 1:j(a,i.viewUp,t),j(c,t,a);break;case 3:{const r=Math.abs(o)<=K?t:i.viewUp;j(a,r,e),j(c,e,a);break}}const l=j(W.get(),a,c);w(l,i.viewForward)>0&&h(c,c,-1),M(s,a),M(n,c)}function We(e,t,i){const r=t.worldUpAtPosition(e.origin,W.get()),s=e.basis1,n=ft(e,r),o=Math.round(n/Rt)*Rt;return E(e,o-n,s,i)}function Ve(e,t,i,r,s,n){const o=y(W.get(),s.origin);v(o,o,h(W.get(),s.basis1,e.direction[0]<0?1:-1)),v(o,o,h(W.get(),s.basis2,e.direction[1]<0?1:-1));const a=k(s.basis1),c=k(s.basis2),l=P(W.get(),i,o),u=P(W.get(),t,o);let m=0,d=0;if(rt(e)){const t=it(s),i=it(n);m=a-.5*e.direction[0]*w(s.basis1,u)/a,d=c-.5*e.direction[1]*w(s.basis2,u)/c;const r=i/t;m*=r,d*=r}const p=m+.5*e.direction[0]*w(s.basis1,l)/a,g=d+.5*e.direction[1]*w(s.basis2,l)/c,f=h(W.get(),s.basis1,p/a),b=h(W.get(),s.basis2,g/c);(p<=0||et(n.origin,f,r)<=Q)&&y(f,n.basis1),(g<=0||et(n.origin,b,r)<=Q)&&y(b,n.basis2);const j=y(W.get(),o);return v(j,j,h(W.get(),f,e.direction[0]<0?-1:1)),v(j,j,h(W.get(),b,e.direction[1]<0?-1:1)),L(j,f,b,n)}function Ze(e,t){return X*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function qe(e,t,i,r){const s=j(W.get(),t,i);return j(s,s,t),I(e,s,r)}function Ne(e,t){return N(e.basis1,e.basis2,e.origin,t)}function $e(e,t,i,r){const s=t.worldUpAtPosition(e.origin,W.get()),n=W.get();switch(i){case 1:y(n,s);break;case 2:y(n,e.basis1)}return I(e.origin,n,r)}function Je(e,t,i,r){const s=_e(i,2),n=V.get();c(n,t,s.edge*Math.PI/2);const o=M(W.get(),s.basis);let l=h(W.get(),o,s.direction*r.computeScreenPixelSizeAt(s.position)*Y);v(l,l,s.position);const u=r.projectToRenderScreen(l,a(W.get())),m=Ke(r,u);Te(r,u,Pt),M(Pt.direction,Pt.direction);const d=W.get();!m&&F(i,Pt,d)&&(l=d),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=O(l),m?e.state|=kt:e.state&=~kt}function Ke(e,t){const[i,r,s,n]=e.viewport,o=Math.min(s,n)/16;let a=!0;return t[0]<i+o?(t[0]=i+o,a=!1):t[0]>i+s-o&&(t[0]=i+s-o,a=!1),t[1]<r+o?(t[1]=r+o,a=!1):t[1]>r+n-o&&(t[1]=r+n-o,a=!1),a}function Qe(e,t,i,r){const s=k(r.basis1),n=k(r.basis2),o=tt(r),a=it(r),d=x(W.get(),0,0,0);v(d,h(W.get(),r.basis1,t.direction[0]),h(W.get(),r.basis2,t.direction[1])),v(d,r.origin,d);let p=0,g=1;if(rt(t))1===t.direction[0]&&-1===t.direction[1]?p=Rt:1===t.direction[0]&&1===t.direction[1]?p=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(p=3*Math.PI/2),g=a;else{const e=0!==t.direction[0]?1:2;p=1===e?Rt:0,g=(1===e?n:s)-o}const f=l(V.get());c(f,f,p),u(f,f,x(W.get(),g,g,g)),m(f,i,f),f[12]=0,f[13]=0,f[14]=0,e.modelTransform=f,e.renderLocation=d}function Xe(e,t,i,r){const s=r.worldUpAtPosition(i.origin,W.get()),n=_e(i,0),o=l(V.get());c(o,o,n.edge*Math.PI/2),d(o,o,-ft(i,s)),m(o,t,o),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=n.position}function Ye(e,t,i){const r=_e(i,1),s=l(V.get());c(s,s,r.edge*Math.PI/2),d(s,s,Rt),m(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=r.position}function _e(e,t){switch(t){case 0:return{basis:e.basis1,direction:1,position:v(W.get(),e.origin,e.basis1),edge:t};case 1:return{basis:e.basis2,direction:1,position:v(W.get(),e.origin,e.basis2),edge:t};case 2:return{basis:e.basis1,direction:-1,position:P(W.get(),e.origin,e.basis1),edge:t};case 3:return{basis:e.basis2,direction:-1,position:P(W.get(),e.origin,e.basis2),edge:t}}}function et(e,t,i){const r=i.projectToRenderScreen(v(W.get(),e,t),a(W.get())),s=i.projectToRenderScreen(P(W.get(),e,t),a(W.get()));return R(P(r,r,s))}function tt(e){const t=k(e.basis1),i=k(e.basis2);return J*Math.min(t,i)}function it(e){return tt(e)}function rt(e){return 0!==e.direction[0]&&0!==e.direction[1]}function st(e,t=1){const i=0===t?Y:0,r=[T(i,0,-je/2),T(i,0,je/2)],s=mt(r,!0),n=(e,t)=>lt(r,r,{tubeRadius:Me,tipRadius:$,tipLength:ve,tubeFocusMultiplier:ke,tipFocusMultiplier:Pe,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t}),o=n(0,!1),a=n(_,!0),c=new Le({color:ee,cullFace:2,renderOccluded:16}),l=new Le({color:te,cullFace:2,renderOccluded:16}),u=new Le({color:ie,cullFace:2,renderOccluded:16}),m=new Le({color:re,transparent:!0,writeDepth:!1,cullFace:1,renderOccluded:2}),d=Ee.createPolylineGeometry([[i,0,0],[i-Y,0,0]]),p=Ee.createPolylineGeometry([[i,0,0],[i-Y,0,0]]),g=new Ae({color:se,renderOccluded:4});return new q({view:e,renderObjects:[...o.normal.map((({part:e,geometry:t,transform:i})=>({geometry:t,material:"tip"===e?c:"cap"===e?l:u,transform:i,stateMask:1|vt}))),...a.normal.map((({geometry:e,transform:t})=>({geometry:e,material:m,transform:t,stateMask:1|vt}))),{geometry:d,material:g,stateMask:1|vt|kt},...o.focused.map((({part:e,geometry:t,transform:i})=>({geometry:t,material:"tip"===e?c:"cap"===e?l:u,transform:i,stateMask:2|vt}))),...a.focused.map((({geometry:e,transform:t})=>({geometry:e,material:m,transform:t,stateMask:2|vt}))),{geometry:p,material:g,stateMask:2|vt|kt}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:$,state:vt})}function nt(e,t){const i=new Fe({transparent:!0,writeDepth:!1,textureId:t.id,renderOccluded:16}),r=ne,s=oe,n=s*be,o=e=>{const t=new Uint32Array([0,1,2,2,3,0]);return new Ce([["position",{size:3,data:[r-e,-e,0,r+e,-e,0,r+e,e,0,r-e,e,0],exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1]}]],[["position",t],["uv0",t]])},a=Ee.createPolylineGeometry([[0,0,0],[r-s,0,0]]),c=Ee.createPolylineGeometry([[0,0,0],[r-n,0,0]]),l=new Ae({color:ae,renderOccluded:4}),u=[{geometry:o(s),material:i,stateMask:1|vt},{geometry:a,material:l,stateMask:1|vt},{geometry:o(n),material:i,stateMask:2|vt},{geometry:c,material:l,stateMask:2|vt}];return new q({view:e,renderObjects:u,autoScaleRenderObjects:!1,collisionType:{type:"disc",direction:[0,0,1],offset:[r,0,0]},collisionPriority:1,radius:s/2,state:vt})}function ot(e){return new xe({view:e,attached:!0,color:ce,width:le,writeDepthEnabled:!1,renderOccluded:4,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function at(e){return new Ue({view:e,attached:!0,backgroundColor:[...ue],gridColor:me,gridWidth:4,renderOccluded:4})}function ct(e,t){const i=rt(t),r=i?[T(1,0,0),T(0,0,0),T(0,1,0)]:[T(1,0,0),T(-1,0,0)],s=Ee.createPolylineGeometry(r),n=he,o=e=>new ze({color:n,width:e,renderOccluded:4}),a=()=>new Ae({color:n,renderOccluded:4}),c=i?Re:we,l=c*ye,u=we,m=e=>e>1?o(e):a(),d=[{geometry:s,material:m(c),stateMask:1|xt},{geometry:s,material:m(l),stateMask:2|xt},{geometry:s,material:m(u),stateMask:Ut}],p=new q({view:e,renderObjects:d,collisionType:{type:"line",paths:[r]},autoScaleRenderObjects:!1,worldSized:!0,radius:i?de:pe});return p.state=xt,p}function lt(e,t,i){const r=r=>{const s=(r?t:e).slice(0),o=P(W.get(),s[0],s[1]);M(o,o);const a=P(W.get(),s[s.length-1],s[s.length-2]);if(M(a,a),i.padding>0){const e=h(S(),a,-i.padding);if(s[s.length-1]=v(e,e,s[s.length-1]),i.bothEnds){const e=h(S(),o,-i.padding);s[0]=v(e,e,s[0])}}const c=r?i.tipFocusMultiplier:1,d=i.tipLength*(i.focusTipLength?c:1),y=i.tipRadius*c,w=l(V.get());if(i.padding>0){const e=d/4,t=x(W.get(),0,e,0),r=1+i.padding/e;p(w,w,t),u(w,w,x(W.get(),r,r,r)),p(w,w,h(t,t,-1/r))}const j=l(f()),k=T(0,1,0),R=g(f(),b(Z.get(),k,a));R[12]=s[s.length-1][0],R[13]=s[s.length-1][1],R[14]=s[s.length-1][2],m(R,R,w);const U=[{part:"tube",geometry:ut(i.tubeRadius*(r?i.tubeFocusMultiplier:1)+i.padding,i.flat,s),transform:j}];let O,C;if(n(i.flat)?O=Ee.createExtrudedTriangle(d,y,y,i.flat.thickness):(O=Ee.createConeGeometry(d,y,24,!1,!1,!0),C=Ee.createConeGeometry(d,y,24,!1,!0,!1)),U.push({part:"tip",geometry:O,transform:R}),C&&U.push({part:"cap",geometry:C,transform:R}),i.bothEnds){const e=g(f(),b(Z.get(),k,o));e[12]=s[0][0],e[13]=s[0][1],e[14]=s[0][2],m(e,e,w),U.push({part:"tip",geometry:O,transform:e}),C&&U.push({part:"cap",geometry:C,transform:e})}return U};return{normal:r(!1),focused:r(!0)}}function ut(e,t,i){const r=[];if(n(t))r.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else{const t=12;for(let i=0;i<t;i++){const s=i/t*2*Math.PI;r.push([Math.cos(s)*e,Math.sin(s)*e])}}return Ee.createPathExtrusionGeometry(r,i,[],[],!1)}function mt(e,t){const i=P(S(),e[e.length-1],e[e.length-2]);if(M(i,i),h(i,i,ge),v(i,i,e[e.length-1]),t){const t=P(S(),e[0],e[1]);return M(t,t),h(t,t,ge),v(t,t,e[0]),[t,...e,i]}return[...e,i]}function dt(e,t,r,n=new Ge){if(s(e))return null;const{renderCoordsHelper:o}=t,a=o.fromRenderCoords(e.origin,t.spatialReference);if(s(a))return null;const c=C(a,r);if(s(c))return null;n.position=c;const l=o.worldUpAtPosition(e.origin,W.get()),u=o.worldBasisAtPosition(e.origin,1,W.get()),m=2*k(e.basis1),d=2*k(e.basis2),p=Se.renderUnitScaleFactor(t.spatialReference,r);return n.width=m*p,n.height=d*p,n.tilt=i(ft(e,l)),n.heading=i(bt(e,l,u)),n}function pt(e,t,i){if(s(e)||s(e.position))return null;const{spatialReference:r}=e.position,o=gt(wt(e,{renderCoordsHelper:t,spatialReference:r},i),t,r);return!e.position.hasZ&&n(o)&&(o.zmin=null,o.zmax=null),o}function gt(e,t,i){if(s(e))return null;const r=e.origin,n=W.get(),o=W.get(),a=W.get(),c=W.get();let l,u,m,d,p,g;v(n,r,e.basis1),v(n,n,e.basis2),v(o,r,e.basis1),U(o,o,e.basis2),U(a,r,e.basis1),U(a,a,e.basis2),U(c,r,e.basis1),v(c,c,e.basis2);for(const f of[n,o,a,c]){const e=t.fromRenderCoords(f,f,i);if(s(e))return null;l=null==l?e[0]:Math.min(l,e[0]),u=null==u?e[0]:Math.max(u,e[0]),m=null==m?e[1]:Math.min(m,e[1]),d=null==d?e[1]:Math.max(d,e[1]),p=null==p?e[2]:Math.min(p,e[2]),g=null==g?e[2]:Math.max(g,e[2])}return new Ie({xmin:l,xmax:u,ymin:m,ymax:d,zmin:p,zmax:g,spatialReference:i})}function ft(e,t){return B(t,e.basis2,e.basis1)+Rt}function bt(e,t,i){return B(e.basis1,i,t)-Rt}function ht(e,t,i,s,n,o,a=A()){return o.toRenderCoords(e,a.origin)?(o.worldBasisAtPosition(a.origin,0,a.basis1),o.worldBasisAtPosition(a.origin,1,a.basis2),H(a.basis2,a.basis1,a.origin,a.plane),E(a,-r(t),z(a),a),E(a,r(i),a.basis1,a),h(a.basis1,a.basis1,s/2),h(a.basis2,a.basis2,n/2),G(a),a):(He.error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}function yt(e,t){if(s(e)||s(e.position))return null;const i=C(e.position,t);if(s(i))return null;const r=Se.renderUnitScaleFactor(e.position.spatialReference,t),n=e.width*r,o=e.height*r;return{position:i,heading:e.heading,tilt:e.tilt,renderWidth:n,renderHeight:o}}function wt(e,t,i,r=A()){const n=yt(e,t.spatialReference);return s(n)?null:jt(n,t,i,r)}function jt(e,t,i,r=A()){if(s(e))return null;let a=e.position;!e.position.hasZ&&n(t.elevationProvider)&&(a=e.position.clone(),a.z=o(Oe(t.elevationProvider,e.position),0));const c=ht(a,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,r);return!i.tiltEnabled&&n(c)&&We(c,t.renderCoordsHelper,c),c}function Mt(t){switch(t.type){case"analysis":case"building-scene":case"csv":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return e(t.type),!1}}const vt=16,kt=32,Pt=D(),Rt=Math.PI/2,xt=16,Ut=32;function Ot(e){const t="building-scene-3d"===e.type?e:null;return n(t)}export{vt as DidPointerMoveRecentlyFlag,kt as IsShiftEdgeOnScreenFlag,mt as addArrowTips,Ne as calculateBoundedPlaneTranslateRotate,it as calculateDiagonalResizeHandleScale,Ze as calculatePlaneHalfSize,tt as calculateResizeHandlePadding,et as calculateScreenSpaceBasisLength2,lt as createArrowGeometry,at as createGridVisualElement,ot as createOutlineVisualElement,De as createPlane,ct as createResizeManipulator,nt as createRotateManipulator,$e as createRotatePlane,st as createShiftManipulator,qe as createShiftPlane,We as forceHorizontalOrVertical,Mt as isAlwaysDrapedLayer,rt as isDiagonalResizeHandle,Ot as isIBuildingSceneLayerView3D,Be as normalToBases,gt as planeToExtent,dt as planeToShape,yt as projectShape,jt as projectedShapeToPlane,xt as resizeNormal,Ut as resizeOutlineOnly,Ve as resizePlane,pt as shapeToExtent,wt as shapeToPlane,Qe as updateResizeHandle,Xe as updateRotateHeadingHandle,Ye as updateRotateTiltHandle,Je as updateShiftRestartHandle};
