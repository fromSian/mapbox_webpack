/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{generateUID as t}from"../../../../core/uid.js";import r from"../../../webgl/FramebufferObject.js";import i from"../../../webgl/Renderbuffer.js";import s from"../../../webgl/Texture.js";import{getGpuMemoryUsage as h}from"../../../webgl/Util.js";const o={dataType:5121,internalFormat:6408},d={};class a{constructor(e){this.rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach((e=>e.dispose())),this._depthBuffers.clear(),this._depthTextures.forEach((e=>e.dispose())),this._depthTextures.clear(),this._colorTextures.forEach((e=>e.dispose())),this._colorTextures.clear(),this._framebuffers.forEach((e=>e.dispose())),this._framebuffers.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this.disposeWithFramebuffers(this._depthTextures,t),this.disposeWithFramebuffers(this._depthBuffers,t),this.disposeWithFramebuffers(this._colorTextures,t))}disposeWithFramebuffers(e,t){const r=e.get(t);r&&(this._framebuffers.forEach(((e,t)=>{e.colorAttachment!==r&&e.depthStencilAttachment!==r||(e.detachAll(),e.dispose(),this._framebuffers.delete(t))})),r.dispose(),e.delete(t))}getDepthTexture(e,t){if(!this.depthTextureSupported)return null;let r=this._depthTextures.get(e.id);return!r||r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=null),r||(r=new s(this.rctx,{target:3553,pixelFormat:34041,dataType:34042,samplingMode:9728,wrapMode:33071,width:t.width,height:t.height}),this._depthTextures.set(e.id,r),this._activeTargets.add(e.id)),r}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return null;let r=this._depthBuffers.get(e.id);return r?r.descriptor.width===t.width&&r.descriptor.height===t.height||r.resize(t.width,t.height):(r=new i(this.rctx,{internalFormat:34041,...t}),this._depthBuffers.set(e.id,r),this._activeTargets.add(e.id)),r}getColorTexture(e,t){let r=this._colorTextures.get(e.id);return r&&(r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=null)),r||(r=new s(this.rctx,{target:3553,pixelFormat:6408,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:null!=e.samplingMode?e.samplingMode:9729,wrapMode:33071,width:t.width,height:t.height}),this._colorTextures.set(e.id,r),this._activeTargets.add(e.id)),r}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:t(),...d,...e}}registerColorTarget(e={}){return{id:t(),...o,...e}}getFramebuffer(t,i,s){const h=this.getKey(i,s);let o=this._framebuffers.get(h);const d=this.getColorTexture(i,t);if(this.depthTextureSupported){const i=s?this.getDepthTexture(s,t):void 0;if(!o)return o=e(s)?new r(this.rctx,{colorTarget:0,depthStencilTarget:4},d,i):new r(this.rctx,{colorTarget:0,depthStencilTarget:0},d),this._framebuffers.set(h,o),o;return(o.width!==t.width||o.height!==t.height||o.colorTexture!==d||o.depthStencilTexture!==i)&&(o.detachAll(),o.resize(t.width,t.height),o.attachColorTexture(d),o.attachDepthStencilTexture(i)),o}const a=s?this.getDepthBuffer(s,t):void 0;if(!o)return o=new r(this.rctx,{colorTarget:0,depthStencilTarget:s?3:0},d,a),this._framebuffers.set(h,o),o;return(o.width!==t.width||o.height!==t.height||o.colorTexture!==d)&&(o.detachAll(),o.resize(t.width,t.height),o.attachColorTexture(d),o.attachDepthStencilBuffer(a)),o}getKey(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}get gpuMemoryUsage(){let e=0;const t=new Set,r=r=>{t.has(r)||(t.add(r),e+=h(r))};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),e}}export{a as RenderTargetHelper};
