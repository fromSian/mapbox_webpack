/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{smoothstep as t,clamp as i}from"../../../../core/mathUtils.js";import{isNone as e,disposeMaybe as a}from"../../../../core/maybe.js";import{n as s,s as r,d as h}from"../../../../chunks/vec3.js";import{c as o}from"../../../../chunks/vec3f64.js";import{f as c}from"../../../../chunks/vec4f32.js";import{createQuadVAO as n}from"./glUtil3D.js";import{ShadowHighlightTechnique as m}from"../shaders/ShadowHighlightTechnique.js";import{vertexCount as p}from"../../../webgl/Util.js";const _=.001953125,d=4e4,l=5e4;class u{constructor(t,i){this._rctx=t,this._viewingMode=i,this._maxOpacity=1,this._parameters={shadowColor:c(1,0,1,1),shadowOpacity:.2,occludedShadowOpacity:.1,opacityElevation:1,dayNightTerminator:1},this._vao=n(this._rctx)}get technique(){return e(this._technique)&&(this._technique=new m({rctx:this._rctx,viewingMode:this._viewingMode},null)),this._technique}render(t,i){if(this._updateParameters(t),!t.shadowMap.enabled||!t.linearDepthTexture||!this.isVisible)return;const e=this.technique;this._rctx.bindFramebuffer(i),this._rctx.useProgram(e.program),e.bindPipelineState(this._rctx),e.bindPass(this._parameters,t),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,p(this._vao,"geometry"))}get gpuMemoryUsage(){var t,i;return null!=(t=null==(i=this._vao)?void 0:i.size)?t:0}setDefaultOptions(t){this._parameters={...this._parameters,...t},this._updateMaxOpacity()}_updateParameters(e){this._parameters.opacityElevation=1-t(d,l,e.camera.relativeElevation);const a=1===this._viewingMode?s(g,e.camera.center):r(g,0,0,1),o=h(a,e.lighting.lightingMainDirection);this._parameters.dayNightTerminator=t(0,1,i(30*o,0,1))}dispose(){this._vao=a(this._vao),this._technique=a(this._technique)}get isVisible(){return this._maxOpacity*this._parameters.opacityElevation*this._parameters.dayNightTerminator>=_}_updateMaxOpacity(){const t=this._parameters,i=t.shadowColor,e=Math.max(t.shadowOpacity,t.occludedShadowOpacity);this._maxOpacity=e*i[3]}}const g=o();export{u as ShadowHighlightHelper};
