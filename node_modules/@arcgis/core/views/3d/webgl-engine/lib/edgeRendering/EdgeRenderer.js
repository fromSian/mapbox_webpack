/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{releaseMaybe as e,isNone as t}from"../../../../../core/maybe.js";import s from"../../../../../core/PooledArray.js";import{t as r,e as i,g as n}from"../../../../../chunks/mat3.js";import{c as o}from"../../../../../chunks/mat3f32.js";import{g as a,s as l}from"../../../../../chunks/vec3.js";import{c as h}from"../../../../../chunks/vec3f64.js";import c from"../../../support/debugFlags.js";import{ComponentDrawParameters as d}from"../../collections/Component/Material/ComponentTechnique.js";import{bindSliceUniforms as m}from"../../core/shaderLibrary/Slice.glsl.js";import{VertexPosition as u}from"../../core/shaderLibrary/attributes/VertexPosition.glsl.js";import{bindMultipassTerrainTexture as f}from"../../core/shaderLibrary/shading/MultipassTerrainTest.glsl.js";import{doublePrecisionRequiresObfuscation as g}from"../../core/shaderLibrary/util/DoublePrecision.glsl.js";import{TwoVectorPosition as b}from"../../core/util/TwoVectorPosition.js";import{EdgeShaderTechnique as p}from"./EdgeShaderTechnique.js";const y=8,T=128,R={type:"uber",slicePlaneEnabled:!1,sliceHighlightDisabled:!1,strokesTexture:null,legacy:!0};class v{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const x={solid:0,sketch:1,uber:2};class P{constructor(e,t,r){this.rctx=e,this.shaderTechniqueRepository=t,this.config=new p.Configuration,this.technique=null,this.refCount=new v,this.renderables=new Set,this.sortedRenderables={1:{1:new s,2:new s},2:{1:new s,2:new s}},this.renderablesDirty=!1,this.settings={...R,...r},this.key=P.getKey(this.settings.type,this.settings.slicePlaneEnabled,this.settings.legacy);const i=this.settings.strokesTexture.variants;this.writerSettings={variants:i,reducedPrecision:c.TESTS_DISABLE_OPTIMIZATIONS},this.config.legacy=this.settings.legacy,this.config.mode=x[this.settings.type],this.config.silhouette=!1,this.config.antialiasing=!!this.rctx.capabilities.blendMinMax,this.config.slicePlaneEnabled=this.settings.slicePlaneEnabled,this.config.doublePrecisionRequiresObfuscation=g(e)}dispose(){this.technique=e(this.technique)}addRenderable(e){this.renderables.add(e),this.renderablesDirty=!0}removeRenderable(e){this.renderables.delete(e),this.renderablesDirty=!0}setRenderablesDirty(){this.renderablesDirty=!0}forEachRenderable(e,t){this.renderablesDirty&&this.sortRenderables(),this.sortedRenderables[t][1].forAll(e),this.sortedRenderables[t][2].forAll(e)}setMultipassParameters(e){this.config.multipassTerrainEnabled=!!e.multipassTerrainEnabled&&e.multipassTerrainEnabled,this.config.cullAboveGround=!!e.cullAboveGround&&e.cullAboveGround}bindRegularEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!1,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(p,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.technique.bindPipelineState(this.rctx,e.slot),this.rctx.useProgram(this.technique.program)}bindSilhouetteEdges(e,t){this.setMultipassParameters(e),this.config.silhouette=!0,this.technique=this.shaderTechniqueRepository.releaseAndAcquire(p,this.config,this.technique),this.technique.bindPass({bindParameters:e,edgeRenderParameters:t}),this.technique.bindPipelineState(this.rctx,e.slot),this.rctx.useProgram(this.technique.program)}renderRegularEdges(e,t,s){this.render(e,e.regular.vao,t,s)}renderSilhouetteEdges(e,t,s){this.render(e,e.silhouette.vao,t,s)}render(e,t,s,r){this.setUniforms(e,s),this.rctx.bindVAO(t),this.rctx.capabilities.instancing.drawArraysInstanced(6,0,4,r)}setUniforms(e,t){const s=this.technique.program;if(e.components.buffer.textureBuffer.bind(s,S,M),t.multipassTerrainEnabled&&(s.setUniform2fv("cameraNearFar",t.camera.nearFar),s.setUniform2fv("inverseViewport",t.inverseViewport),f(s,t)),"origin"in e.transform)s.setUniformMatrix4fv("uView",t.localViewMatrixForEdges),s.setUniformMatrix4fv("uModel",e.transform.modelMatrix),m(s,this.settings,t.slicePlane,e.transform.origin.vec3);else{const o=new b(e.transform.position),h=r(w,i(w,e.transform.rotationScale)),c=new d;a(c.worldFromModel_TL,o.low),a(c.worldFromModel_TH,o.high),n(c.worldFromModel_RS,e.transform.rotationScale),n(c.transformNormal_GlobalFromModel,h),u.bindModelTransform(s,c),s.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",c.transformNormal_GlobalFromModel);const f=t.camera.viewInverseTransposeMatrix,g=l(q,f[3],f[7],f[11]);m(s,this.settings,t.slicePlane,g)}"uber"!==this.settings.type&&"sketch"!==this.settings.type||this.setSketchUniforms(s),s.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[3]/2))}setSketchUniforms(e){const s=this.settings.strokesTexture,r=s.texture;t(r)||(e.bindTexture(r,"uStrokesTexture"),e.setUniform2f("uStrokesTextureScale",1/r.descriptor.width,1/r.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",Math.log2(s.resolution)),e.setUniform1f("uStrokesNormalizationScale",s.normalizationScale),e.setUniform1f("uStrokesAmplitude",s.amplitude),e.setUniform1f("uStrokeVariants",s.variants))}sortRenderables(){this.renderablesDirty=!1,this.sortedRenderables[1][1].clear(),this.sortedRenderables[1][2].clear(),this.sortedRenderables[2][1].clear(),this.sortedRenderables[2][2].clear(),this.renderables.forEach((e=>{0!==e.objectTransparency&&0!==e.edgeTransparency&&this.sortedRenderables[e.objectTransparency][e.edgeTransparency].push(e)}));const e=(e,t)=>"origin"in e.transform&&"origin"in t.transform?e.transform.origin.id<t.transform.origin.id?-1:e.transform.origin.id>t.transform.origin.id?1:0:0;this.sortedRenderables[1][1].sort(e),this.sortedRenderables[1][2].sort(e),this.sortedRenderables[2][1].sort(e),this.sortedRenderables[2][2].sort(e)}static getKey(e,t,s){return`edges-t:${e}:${t}:${s}`}}const S="uComponentDataTex",M="uComponentDataTexInvDim",w=o(),q=h();export{T as EXTENSION_LENGTH_OFFSET,P as EdgeRenderer,y as LINE_WIDTH_FRACTION_FACTOR,M as componentDataInvDimName,S as componentDataTexName};
