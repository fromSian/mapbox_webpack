/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import i from"../../../../core/Accessor.js";import t from"../../../../core/Handles.js";import s from"../../../../core/Logger.js";import{isSome as a,isNone as l}from"../../../../core/maybe.js";import{reactTruthy as n,react as r}from"../../../../core/reactiveUtils.js";import{whenOnce as o}from"../../../../core/watchUtils.js";import{property as c}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as d}from"../../../../core/accessorSupport/decorators/subclass.js";import{c as h}from"../../../../chunks/boundedPlane.js";import y from"../../../../layers/Layer.js";import u from"../../../../layers/buildingSublayers/BuildingComponentSublayer.js";import{logFailedGeometryProjectionError as p}from"../support/loggerUtils.js";import{isAlwaysDrapedLayer as w,isIBuildingSceneLayerView3D as v,projectShape as f,projectedShapeToPlane as m,planeToShape as _}from"../../interactive/analysisTools/slice/sliceToolUtils.js";import V from"../../../../widgets/Slice/SlicePlane.js";const g=s.getLogger("esri.views.3d.analysis.Slice.SliceController");let S=class extends i{constructor(e){super(e),this._handles=new t,this._internalChange=!1,this._currentSlicePlane=null,this.state="pending"}get ready(){return"ready"===this.state}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",(e=>{const i=e.item;null!=i&&(i instanceof y||i instanceof u)?i instanceof y&&w(i)?(g.error("excludedLayers",`Layer '${i.title}, id:${i.id}' of type '${i.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(i)&&e.preventDefault():(g.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())}))),this._handles.add(n((()=>this.view.ready&&a(this.view.renderCoordsHelper)),(()=>this._initialize()),{sync:!0,initial:!0,once:!0}))}_initialize(){"destroyed"!==this.state&&"ready"!==this.state&&(L(this.view,this),this._handles.add([r((()=>this.analysisView.analysisViewData.plane),(()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()}),{sync:!0}),r((()=>this.analysis.excludeGroundSurface),(()=>this._updateLayerViews()),{sync:!0}),this.analysis.excludedLayers.on("change",(()=>this._updateLayerViews())),r((()=>[this.analysisView.active,this.analysisView.visible]),(()=>{this._updateActiveController(),this._updateViewSlicePlane()}),{sync:!0}),r((()=>this._allLayerAndSubLayerViews),(()=>this._updateLayerViews()))]),this._handles.add([r((()=>this.analysis.shape),(()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())}),{sync:!0})],"analysis"),this._set("state","ready"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())}destroy(){"destroyed"!==this.state&&"pending"!==this.state&&(this.analysisView.active=!1,x(this.view,this),this._handles.destroy(),this.view.slicePlane=null,this.set("view",null),this._set("state","destroyed"))}async whenReady(){return await o(this,"ready"),this}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(v).flatMap((({sublayerViews:e})=>e.items)))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,i=this._currentSlicePlane;if(l(i)&&l(e)||a(i)&&a(e)&&e.equals(i))return;let t=null,s=null;if(a(e)&&a(e.position)){const i=e.position.spatialReference,n=f(e,this.view.spatialReference);l(n)&&p(this.analysis,i,g),t=m(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},h()),a(t)&&(s={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=s,this._internalChange=!0,this.analysisView.analysisViewData.plane=t,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisView.analysisViewData.plane,i=_(e,this.view,this.view.spatialReference,new V);let t=null;a(i)&&(t={heading:i.heading,tilt:i.tilt,position:i.position,width:i.width,height:i.height}),this._currentSlicePlane=t,this._internalChange=!0,this.analysis.shape=i,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(C)return;const e=j(this.view);if(this.analysisView.active)a(e.activeController)&&e.activeController!==this?(C=!0,e.activeController.analysisView.active=!1,C=!1):a(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(a(e.activeController)&&e.activeController!==this)return;a(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){"ready"===this.state&&P(this.view)}_updateLayerViews(){const e=a(this.analysisView.analysisViewData.plane)&&this.analysisView.visible&&this.analysisView.active,i=[],t=e=>{"layers"in e?e.layers.forEach(t):i.push(e)};this.analysis.excludedLayers.forEach(t),this.view.allLayerViews.forEach((t=>{t.destroyed||("slicePlaneEnabled"in t&&(t.slicePlaneEnabled=e&&i.indexOf(t.layer)<0),"sublayerViews"in t&&t.sublayerViews.forEach((t=>{t.slicePlaneEnabled=e&&i.indexOf(t.sublayer)<0})))})),null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};e([c({readOnly:!0})],S.prototype,"state",void 0),e([c()],S.prototype,"view",void 0),e([c()],S.prototype,"analysis",void 0),e([c()],S.prototype,"analysisView",void 0),e([c()],S.prototype,"ready",null),e([c()],S.prototype,"_allLayerAndSubLayerViews",null),S=e([d("esri.views.3d.analysis.Slice.SliceController")],S);const b=new Map;let C=!1;function P(e){const i=j(e).activeController;a(i)&&a(i.analysisView.analysisViewData.plane)&&i.analysisView.visible?e.slicePlane=i.analysisView.analysisViewData.plane:e.slicePlane=null}function L(e,i){b.has(e)||b.set(e,{all:[],activeController:null}),b.get(e).all.push(i)}function j(e){return b.get(e)}function x(e,i){if(!b.has(e))throw new Error("view expected in global slice register");const t=b.get(e),s=t.all.lastIndexOf(i);if(-1===s)throw new Error("controller expected in global slice register");t.all.splice(s,1),0===t.all.length&&b.delete(e)}export{S as SliceController};
