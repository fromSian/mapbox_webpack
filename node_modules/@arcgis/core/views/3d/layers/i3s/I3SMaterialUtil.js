/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../../../../core/has.js";import{clamp as a,isPowerOfTwo as r}from"../../../../core/mathUtils.js";import{isSome as o,isNone as s}from"../../../../core/maybe.js";import{RenderTexture as t}from"../../webgl-engine/core/material/RenderTexture.js";import{PBRSchematicMRRValues as n}from"../../webgl-engine/core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl.js";import{defaultMaskAlphaCutoff as l}from"../../webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl.js";import{getEllipsoidMode as i}from"../../webgl-engine/core/shaderLibrary/util/EllipsoidMode.js";import{Texture as u}from"../../webgl-engine/lib/Texture.js";function c(e,a){const r=new Map,t=(e,a)=>{if(s(e))return-1;if(r.has(e.id)){const o=r.get(e.id);return o.usage|=a,o.id}const o=r.size;return r.set(e.id,{id:o,usage:a}),o},l=a.pbrMetallicRoughness,i=l&&l.baseColorFactor,u=a.emissiveFactor,c=null==a.normalTexture&&null==a.emissiveTexture&&null==a.occlusionTexture&&(!l||null==l.metallicRoughnessTexture&&1===l.roughnessFactor&&(1===l.metallicFactor||0===l.metallicFactor)),g=c?n[0]:l?l.metallicFactor:1,p=c?n[1]:l?l.roughnessFactor:1,h="mask"===a.alphaMode?33:1,f={baseColorFactor:i?[i[0],i[1],i[2],i[3]]:[1,1,1,1],baseColorTextureId:t(l&&l.baseColorTexture,h),metallicRoughnessTextureId:t(l&&l.metallicRoughnessTexture,2),metallicFactor:g,roughnessFactor:p},x={alphaMode:a.alphaMode,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,cullFace:"none"===a.cullFace?0:"back"===a.cullFace?2:"front"===a.cullFace?1:void 0,normalTextureId:t(a.normalTexture,4),emissiveTextureId:t(a.emissiveTexture,16),occlusionTextureId:t(a.occlusionTexture,8),emissiveFactor:u?[u[0],u[1],u[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,hasParametersFromSource:c},b=[];return r.forEach((({usage:a},r)=>{const s=o(e)&&e[r]&&e[r].formats,t=s?m(s.map((({name:e,format:a})=>({name:e,encoding:d[a]})))):[];b.push({id:r,usage:a,encodings:t})})),{material:x,textures:b}}function m(e){return e.sort(((e,a)=>e.encoding-a.encoding))}const d={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},g={[u.KTX2_ENCODING]:2,[u.BASIS_ENCODING]:2,[u.DDS_ENCODING]:4,"image/png":8,"image/jpg":16,"image/jpeg":16,"image/ktx":32};function p(e){const r=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,o=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,s=r&&e.materialDefinitions[r],t=o&&e.textureDefinitions[o],n=h();if(null!=s){const e=s.params;e.diffuse&&(n.metallicRoughness.baseColorFactor=[e.diffuse[0],e.diffuse[1],e.diffuse[2],1]),null!=e.doubleSided&&(n.doubleSided=e.doubleSided,n.cullFace=e.doubleSided?0:2),"none"!==e.cullFace&&"front"!==e.cullFace&&"back"!==e.cullFace||(n.cullFace="none"===e.cullFace?0:"back"===e.cullFace?2:1),e.transparency&&(n.metallicRoughness.baseColorFactor[3]=a(1-e.transparency,0,1)),(e.useVertexColorAlpha||n.metallicRoughness.baseColorFactor[3]<1)&&(n.alphaMode="blend")}const l=[];if(null!=t){const e=0;!t.wrap||"repeat"!==t.wrap[0]&&"repeat"!==t.wrap[1]||(n.wrapTextures=!0);let a=1;"rgba"===t.channels&&(n.alphaMode="blend",a|=32);const r=t.images.length-1,o=t.images[r],s=e=>e&&e.split("/").pop(),i=Array.isArray(t.encoding)?m(t.encoding.map(((e,a)=>({name:s(o.href[a]),encoding:g[e]||0})))):[{name:s(o.href),encoding:g[t.encoding]||0}];l.push({id:e,usage:a,encodings:i}),n.metallicRoughness.baseColorTextureId=e}return{material:n,textures:l}}const h=()=>({alphaMode:"opaque",alphaCutoff:l,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});function f(e,a,o,t){if(s(e)||null==e.data)return null;const n=e.data,l=!(n instanceof HTMLImageElement)||r(n.width)&&r(n.height),i=t.renderingContext.parameters.maxMaxAnisotropy,c=o&&!t.capabilities.shaderTextureLOD?1:i,m=l&&!e.downsampled&&c>1,d=o||!a.wrapTextures?x:b,g=I(e.encoding),p=1&e.usage?"opaque"===a.alphaMode?3:4:3;return new u(n,{mipmap:m,maxAnisotropy:c,encoding:g,wrap:d,components:p,noUnpackFlip:!0})}const x={s:33071,t:33071},b={s:10497,t:10497};function F(e,r,s,n,u,c){const m=c.rendererTextureUsage,d=e=>w(n,s,e&m),g=r.metallicRoughness.baseColorFactor,p=a(r.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[g[0],g[1],g[2],p],e.hasParametersFromSource=!!r.hasParametersFromSource,e.usePBR=c.usePBR,e.mrrFactors=[r.metallicRoughness.metallicFactor,r.metallicRoughness.roughnessFactor,r.hasParametersFromSource?.2:.5],e.emissiveFactor=r.emissiveFactor,e.isIntegratedMesh=c.isIntegratedMesh,e.alphaCutoff="mask"===r.alphaMode?r.alphaCutoff:l,e.alphaDiscardMode="opaque"===r.alphaMode?1:"mask"===r.alphaMode?2:3;const h=[],f=d(33);o(f)&&(e.baseColorTexture=new t(u,f),h.push(e.baseColorTexture.loadPromise));const x=d(2);o(x)&&(e.metallicRoughnessTexture=new t(u,x),h.push(e.metallicRoughnessTexture.loadPromise));const b=d(16);o(b)&&(e.emissionTexture=new t(u,b),h.push(e.emissionTexture.loadPromise));const F=d(8);o(F)&&(e.occlusionTexture=new t(u,F),h.push(e.occlusionTexture.loadPromise));const T=d(4);return o(T)&&(e.normalTexture=new t(u,T),h.push(e.normalTexture.loadPromise)),e.commonMaterialParameters.slicePlaneEnabled=c.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=r.doubleSided,e.commonMaterialParameters.cullFace=r.cullFace,e.ellipsoidMode=i(c.viewSpatialReference),Promise.all(h)}function T(a){const r=!!a.compressedTextureS3TC,o=!!a.compressedTextureETC,s=e("disable-feature:i3s-basis")?0:3;return 24|(r?4|s:0)|(o?s:0)}function C(e,a){return e.find((e=>0!=(e.encoding&a)))}function w(e,a,r){if(s(e)||0===r)return null;for(let s=0;s<e.length;s++){const t=e[s];if(o(t)&&0!=(t.usage&r)){const e=a[s];return o(e)?e.id:null}}return null}function I(e){switch(e){case 1:return u.KTX2_ENCODING;case 2:return u.BASIS_ENCODING;case 4:return u.DDS_ENCODING;case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}export{F as configureMaterial,f as createTexture,c as getMaterialAndTextures,p as getMaterialAndTexturesFromShared,T as getSupportedEncodings,C as selectEncoding};
