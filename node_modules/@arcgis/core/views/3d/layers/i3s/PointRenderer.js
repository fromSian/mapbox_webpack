/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{isNone as e,unwrap as i,disposeMaybe as t,isSome as s}from"../../../../core/maybe.js";import r from"../../../../core/PooledArray.js";import{i as n,a as o,m as h}from"../../../../chunks/mat4.js";import{c as a}from"../../../../chunks/mat4f32.js";import{f as l,l as c,a as d,o as u,d as m,p,s as g}from"../../../../chunks/vec3.js";import{c as f}from"../../../../chunks/vec3f32.js";import{c as _}from"../../../../chunks/vec3f64.js";import{s as x}from"../../../../chunks/vec4.js";import{create as S,POSITIVE_INFINITY as z,offset as b,contains as P,containsPoint as w,equals as R,set as y}from"../../../../geometry/support/aaBoundingBox.js";import{create as q}from"../../../../geometry/support/plane.js";import{fromPoints as v}from"../../../../geometry/support/ray.js";import{PointHighlights as M}from"./PointHighlights.js";import{minimumDistancePlane as j,maximumDistancePlane as F,intersectLine as H,toAaBoundingBox as V}from"../../support/orientedBoundingBox.js";import{bindSliceUniforms as A}from"../../webgl-engine/core/shaderLibrary/Slice.glsl.js";import{bindOutputHighlight as U}from"../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl.js";import{Default3D as C}from"../../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{newIntersectorResult as E}from"../../webgl-engine/lib/Intersector.js";import{PointRendererTechniqueConfiguration as B,PointRendererTechnique as L}from"../../webgl-engine/shaders/PointRendererTechnique.js";import N from"../../../webgl/BufferObject.js";import O from"../../../webgl/VertexArrayObject.js";const T={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};class W{constructor(e){this._params=e,this.type=5,this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new M({forEachNode:e=>this.forEachNode(e),addHighlight:(e,i,t)=>this.addHighlight(e,i,t),removeHighlight:(e,i)=>this.removeHighlight(e,i)}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=S(z),this._techniqueConfig=new B,this.tempMatrix4=a(),this.tempVec3=f(),this.nodes=new r}get needsHighlight(){return this._highlights.hasHighlights}initializeRenderContext(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRep,e.requestRender()}uninitializeRenderContext(){}intersect(e,i,t,s){const r=_(),n=_(),o=_(),h=_(),a=q(),g=e.camera.perScreenPixelRatio/2,f=e.camera.near,z=this._getSizeParams();l(n,s,t);const R=1/c(n);d(n,n,R),u(o,n),x(a,n[0],n[1],n[2],-m(n,t));class y{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}const M=new y,A=new y,U=[],C=S(),B=S(this._clipBox);b(B,-t[0],-t[1],-t[2],B),this.nodes.forAll((c=>{const d=c.splatSize*this._scaleFactor;let u=j(c.obb,a),_=F(c.obb,a);u-=D(d,u+f,z,g,c.isLeaf),_-=D(d,_+f,z,g,c.isLeaf);const x=_<0,S=null!=M.dist&&null!=A.dist&&M.dist<u*R&&A.dist>_*R;if(x||S)return;const q=I(d,_+f,z,g,c.isLeaf);if(!H(c.obb,t,n,q))return;const v=q*q;V(c.obb,C),b(C,-t[0],-t[1],-t[2],C);const E=!P(B,C);l(h,c.origin,t);const L=c.coordinates.length/3;for(let a=0;a<L;a++){if(r[0]=h[0]+c.coordinates[3*a],r[1]=h[1]+c.coordinates[3*a+1],r[2]=h[2]+c.coordinates[3*a+2],E&&!w(B,r))continue;const l=m(r,n),u=p(r)-l*l;if(u>v)continue;let _=l+f;const x=D(d,_,z,g,c.isLeaf);if(l-x<0)continue;_-=x;const S=I(d,_,z,g,c.isLeaf);if(u>S*S)continue;const b=(l-x)*R,P=e=>{e.point=G(c,a,e.point),e.dist=b,e.normal=o,e.node=c,e.pointId=a,e.layerUid=this.layerUid};if((null==M.dist||b<M.dist)&&(null==i||i(t,s,b))&&P(M),0!==e.options.store&&(null==A.dist||b>A.dist)&&(null==i||i(t,s,b))&&P(A),2===e.options.store&&(null==i||i(t,s,b))){const e=new y;P(e),U.push(e)}}}));const L=e=>{const{layerUid:i,node:t,pointId:s}=e;return{point:e.point,layerUid:i,graphicUid:s,createGraphic:()=>this._params.createGraphic(t,s,e.point)}},N=(e,i)=>{const t=L(i);e.set(this.type,t,i.dist,i.normal)};if(null!=M.dist){const i=e.results.min;(null==i.dist||M.dist<i.dist)&&N(i,M)}if(null!=A.dist&&0!==e.options.store){const i=e.results.max;(null==i.dist||A.dist>i.dist)&&N(i,A)}if(2===e.options.store){const i=v(t,s);for(const t of U){const s=E(i);N(s,t),e.results.all.push(s)}}}render(e){if(0===this.nodes.length||0!==e.pass&&2!==e.pass&&5!==e.pass)return!1;const i=this._getSizeParams(),t=this.selectTechnique(e,i),s=t.program;if(null==s)return!1;this.nodes.forAll((i=>{null==i.vao&&this._initNode(e,i)}));const r=e.rctx;r.useProgram(s),t.bindPipelineState(r);const a=this._clipBox,l=!R(a,z,((e,i)=>e===i));l||(g(this.tempVec3,-1/0,-1/0,-1/0),s.setUniform3fv("uClipMin",this.tempVec3),g(this.tempVec3,1/0,1/0,1/0),s.setUniform3fv("uClipMax",this.tempVec3)),s.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix);2===e.pass&&s.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,U(s,this._bindParameters));const c=e.camera.pixelRatio;i.drawFixedSize&&s.setUniform2f("uPointScale",i.fixedSize*c,e.camera.fullHeight);const d=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;return this.nodes.forAll((u=>{if(0===u.coordinates.length||e.isHighlightPass&&!u.highlights)return;if(s.setUniform2f("uScreenMinMaxSize",i.screenMinSize*c,k(u.isLeaf)*c),!i.drawFixedSize){const i=u.splatSize*this._scaleFactor;s.setUniform2f("uPointScale",i*c,e.camera.fullHeight/c)}const m=u.origin;l&&(g(this.tempVec3,a[0]-m[0],a[1]-m[1],a[2]-m[2]),s.setUniform3fv("uClipMin",this.tempVec3),g(this.tempVec3,a[3]-m[0],a[4]-m[1],a[5]-m[2]),s.setUniform3fv("uClipMax",this.tempVec3)),n(this.tempMatrix4),o(this.tempMatrix4,this.tempMatrix4,m),h(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),s.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),A(s,t.configuration,d,m),r.bindVAO(u.vao),e.isHighlightPass?this._renderHighlightFragments(r,u):r.drawArrays(0,0,u.coordinates.length/3)})),!0}_renderHighlightFragments(t,s){const r=s.highlights;if(e(r))return;let n=i(r[0].component),o=n+1;for(let e=1;e<r.length;e++){const s=i(r[e].component);if(s!==o){const e=o-n;e>0&&t.drawArrays(0,n,e),n=s}o=s+1}const h=o-n;h>0&&t.drawArrays(0,n,h)}set useFixedSizes(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._useFixedSizes}set scaleFactor(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}get scaleFactor(){return this._scaleFactor}set minSizePx(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}get minSizePx(){return this._minSizePx}set useRealWorldSymbolSizes(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._useRealWorldSymbolSizes}set size(e){this._size!==e&&(this._size=e,this._requestRender())}get size(){return this._size}set sizePx(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}get sizePx(){return this._sizePx}set clippingBox(e){y(this._clipBox,e||z)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let i=null;return this.nodes.filterInPlace((s=>s.id!==e||(i=s,s.vao=t(s.vao),this._highlights.nodeRemoved(s),!1))),this._requestRender(),i}forEachNode(e){this.nodes.forAll(e)}removeAll(){this.nodes.forAll((e=>e.vao=t(e.vao))),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()}highlight(e){return this._highlights.add(e)}addHighlight(e,i,t){e.highlights=K(e.highlights,i,t),this._requestRender()}removeHighlight(e,i){e.highlights=Q(e.highlights,i),this._requestRender()}_initNode(e,i){const t=e.rctx;i.vao=new O(t,C,T,{positions:N.createVertex(t,35044,i.coordinates),colors:N.createVertex(t,35044,i.rgb)})}_requestRender(){this._context&&this._context.requestRender()}_getSizeParams(){const e=this._useFixedSizes,i=e&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:i,drawFixedSize:e,fixedSize:i?this._sizePx:this._size,screenMinSize:e?0:this._minSizePx}}selectTechnique(e,i){return this._techniqueConfig.drawScreenSize=i.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=2===e.pass?1:5===e.pass?4:0,this._techniqueRep.releaseAndAcquire(L,this._techniqueConfig,this._technique)}}function k(e){return e?256:64}function I(e,i,t,s,r){if(t.drawScreenSpace)return t.fixedSize*i*s;const n=k(r)*i*s;return t.drawFixedSize?Math.min(t.fixedSize/2,n):t.screenMinSize>0?Math.min(Math.max(t.screenMinSize*i*s,e/2),n):Math.min(e/2,n)}function D(e,i,t,s,r){return t.drawScreenSpace?0:I(e,i,t,s,r)}function G(e,i,t){return null==t&&(t=_()),t[0]=e.origin[0]+e.coordinates[3*i],t[1]=e.origin[1]+e.coordinates[3*i+1],t[2]=e.origin[2]+e.coordinates[3*i+2],t}function J(e){return s(e.component)?e.component:-1}function K(i,t,s){e(i)&&(i=[]);const r={component:t,id:s};i.push(r);const n=J(r);let o=i.length-1;for(;o>0&&n<J(i[o-1]);)[i[o-1],i[o]]=[i[o],i[o-1]],--o;return i}function Q(i,t){if(e(i))return i;const s=i.filter((e=>e.id!==t));return 0===s.length?null:s}!function(e){function i(e){return e.hasOwnProperty("splatSize")}e.isInstanceOfNode=i}(W||(W={}));export{W as PointRenderer};
