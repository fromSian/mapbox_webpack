/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{isSome as t,isNone as e}from"../../../../core/maybe.js";import{h as s,i,l as r,a as n,d as a,p as o,f as h,b as c}from"../../../../chunks/vec3.js";import{c as m}from"../../../../chunks/vec3f64.js";import{c as p}from"../../../../chunks/vec4.js";import{projectBoundingSphere as u}from"../../../../geometry/projection.js";import{getSphericalPCPF as l}from"../../../../geometry/projectionEllipsoid.js";import{create as _,fromMatrix as d,intersectsSphere as b}from"../../../../geometry/support/frustum.js";import{w as g}from"../../../../chunks/sphere.js";import{makeDehydratedPoint as f}from"../../../../layers/graphics/dehydratedFeatures.js";import{evaluateElevationAlignmentAtPoint as M}from"../graphics/elevationAlignmentUtils.js";import{ElevationContext as v}from"../graphics/ElevationContext.js";import{createContextWithoutExpressionSupport as x,extractExpressionInfo as D}from"../graphics/featureExpressionInfoUtils.js";import{transformObb as C,intersectBoundingRectWithMbs as P}from"./I3SUtil.js";import{create as R,isVisible as S}from"../../support/orientedBoundingBox.js";const L=1e5;class E{constructor(t,e,s,i,r,n,a,o={}){this._indexSR=t,this._renderCoordsHelper=e,this.clippingArea=r,this._elevationProvider=n,this._options=o,this._frustum=_(),this._useFrustumCulling=!1,this._poi=m(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=m(),this._tmp2=m(),this._tmp3=m(),this._tmp0=m(),this._screenspaceErrorBias=o.screenspaceErrorBias||1,this._progressiveLoadFactor=o.progressiveLoadFactor||1,this.updateCamera(s,i),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(a),this._tmpPoint=f(0,0,0,t)}updateElevationInfo(t){null!=t?(this._elevationContext=v.fromElevationInfo(t),this._elevationContext.updateFeatureExpressionInfoContext(x(D(t,!1)))):this._elevationContext=null}updateCamera(t,e){this._useFrustumCulling=e,e&&d(t.viewMatrix,t.projectionMatrix,this._frustum),this._screenSizeFactor=1/(t.perScreenPixelRatio/2),this._camPos=t.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(t){this._poi=t}updateScreenSpaceErrorBias(t){const e=this._screenspaceErrorBias;return this._screenspaceErrorBias=t,e}updateClippingArea(t){this.clippingArea=t}getRenderMbs(t){const e=t.renderMbs;return e[3]<0&&(p(e,t.mbs),this._elevationContext&&e[3]<L&&(this._tmpPoint.x=e[0],this._tmpPoint.y=e[1],this._tmpPoint.z=e[2],e[2]=M(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)),u(e,this._indexSR,e,this.engineSR)),e}getVisibilityObb(s){if(t(s.visibilityObb))return s.visibilityObb;const i=s.serviceObb;return e(i)||i.halfSize[0]<0?void 0:(s.serviceObbInRenderSR=this._computeRenderObb(i,s.serviceObbInRenderSR,s.mbs[3]),s.serviceObbInRenderSR)}_computeRenderObb(t,s,i){if(e(s)&&(s=R()),s.halfSize[0]<0){let e=0;this._elevationContext&&i<L&&(this._tmpPoint.x=t.center[0],this._tmpPoint.y=t.center[1],this._tmpPoint.z=t.center[2],e=M(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-t.center[2]),C(t,this._indexSR,s,this.engineSR,e)}return s}isNodeVisible(e){const s=this.getRenderMbs(e);if(!this._isMBSinClippingArea(s))return!1;if(!this._useFrustumCulling)return!0;const i=this.getVisibilityObb(e);return t(i)?S(i,this._frustum):b(this._frustum,g(s))}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const s=e.geometryObb;return t(s)?S(s,this._frustum):this.isNodeVisible(e)}_isMBSinClippingArea(t){return!!e(this.clippingArea)||0!==P(this.clippingArea,t)}screenSpaceDiameterMbs(t,e){const i=this.getRenderMbs(t),r=Math.sqrt(s(i,this._camPos)),n=r-i[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:e/n*this._screenSizeFactor}calcCameraDistance(t){return this.calcCameraDistanceToCenter(t)-this.getRenderMbs(t)[3]}calcCameraDistanceToCenter(t){const e=this.getRenderMbs(t),s=i(e,this._camPos);return this._updateMinMaxDistance(s),s}calcAngleDependentLoD(t){const e=this.getRenderMbs(t),s=e[3],n=(Math.abs(e[0]*(e[0]-this._camPos[0])+e[1]*(e[1]-this._camPos[1])+e[2]*(e[2]-this._camPos[2]))/r(e)+s)/i(e,this._camPos);return Math.min(1,n)}hasLOD(t){return 0!==t.lodMetric}getDistancePlanarMode(t,e){const s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2],n=s*s+i*i,a=e[3];if(n<=a*a)return Math.abs(r);const o=Math.sqrt(n)-a;return Math.sqrt(r*r+o*o)}getDistanceGlobeMode(t,e){const m=r(e),p=r(t)-m;n(this._tmp0,t,a(t,e)/o(t));const u=s(e,this._tmp0),l=e[3];if(u<=l*l)return Math.abs(p);{const s=n(this._tmp0,e,1/m),o=m,u=l*l/2/o,_=n(this._tmp1,s,o-u),d=t,b=h(this._tmp2,d,_),g=h(this._tmp2,b,n(this._tmp3,s,a(s,b))),f=c(this._tmp2,_,n(this._tmp2,g,l/r(g)));let M=i(d,f);if(p>=2e5){const t=h(this._tmp1,d,f);let e=a(t,s)/r(t);e<.08&&(e=1e-4),M/=e}return M}}getDistance(t,e){return this.engineSR===l(this.engineSR)?this.getDistanceGlobeMode(t,e):this.getDistancePlanarMode(t,e)}_updateMinMaxDistance(t){t>0?(this.minDistance=Math.min(this.minDistance,t),this.maxDistance=Math.max(this.maxDistance,t)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-t))}getLodLevel(t){if(0===t.lodMetric||!t.resources.hasFeatureData)return 0;if(0===t.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const e=this._progressiveLoadFactor*this._screenspaceErrorBias,s=this._screenspaceErrorBias;return this.evaluateLODmetric(t,e)?this.evaluateLODmetric(t,s)?2:1:0}return this.evaluateLODmetric(t,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(t,e){switch(t.lodMetric){case 2:{const s=this.getRenderMbs(t),i=this.getDistance(this._camPos,s),r=2*i/this._screenSizeFactor,n=i+s[3];return this._updateMinMaxDistance(n),t.maxError*e<=r}case 1:{let s=this.screenSpaceDiameterMbs(t,t.mbs[3]*e);return this._options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(t)),s<t.maxError}case 3:return this.screenSpaceDiameterMbs(t,t.maxError)*e<10;case 4:return this.calcCameraDistance(t)>t.maxError*e}return!1}distToPOI(t){const e=this.getRenderMbs(t);return i(e,this._poi)-e[3]}distCameraToPOI(){return i(this._camPos,this._poi)}}export{E as default};
