/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{isSome as e}from"../../../../core/maybe.js";import{intersectLine as i}from"../../support/orientedBoundingBox.js";import{newIntersectorResult as r}from"../../webgl-engine/lib/Intersector.js";import{getVerticalOffsetI3S as t}from"../../webgl-engine/lib/verticalOffsetUtils.js";class s{constructor(e){this.type=4,this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this.collection=e.collection,this.traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}intersect(s,o,l,d){const c=s.results,a=2===s.options.store,b=s.ray.direction,u=s.tolerance;let y=e=>e,m=e=>e;const h=t(s.verticalOffset);e(h)&&(y=e=>h.applyToMbs(e),m=e=>h.applyToObb(e)),this.traverseNodeHierarchy(((t,p)=>!(e(t.serviceObbInRenderSR)&&!i(m(t.serviceObbInRenderSR),l,b,u))&&(!p||e(t.geometryObb)&&!i(m(t.geometryObb),l,b,u)||!e(t.serviceObbInRenderSR)&&!n(y(t.renderMbs),l,b,u)||this.collection.intersect(p,l,d,u,h,((e,i,n,b)=>{if(i>=0){if(null!=o&&!o(l,d,i))return;const u=r=>{const s={layerUid:this.layerUid,sublayerUid:this.sublayerUid,nodeIndex:t.index,componentIndex:e,triangleNr:b};r.set(this.type,s,i,n)};if(this.isGround&&(null==c.ground.dist||i<c.ground.dist)&&u(c.ground),s.options.isFiltered)return;if((null==c.min.dist||i<c.min.dist)&&u(c.min),(null==c.max.dist||i>c.max.dist)&&u(c.max),a){const e=r(s.ray);u(e),s.results.all.push(e)}}})),!0)))}}function n(e,i,r,t=0){const s=e[3]+t,n=i[0]-e[0],o=i[1]-e[1],l=i[2]-e[2],d=r[0],c=r[1],a=r[2],b=d*n+c*o+a*l;return b*b-(d*d+c*c+a*a)*(n*n+o*o+l*l-s*s)>=0}export{s as I3SIntersectionHandler};
