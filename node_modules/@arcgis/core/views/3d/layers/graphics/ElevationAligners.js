/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{isNone as t}from"../../../../core/maybe.js";import{c as e}from"../../../../chunks/mat4.js";import{c as a}from"../../../../chunks/mat4f64.js";import{s as o}from"../../../../chunks/vec3.js";import{c as s}from"../../../../chunks/vec3f64.js";import{projectBuffer as n,computeTranslationToOriginAndRotation as r}from"../../../../geometry/projection.js";import{evaluateElevationInfoAtPoint as i,SampleElevationInfo as c}from"./elevationAlignmentUtils.js";import{updateVertexAttributeAuxpos1w as l}from"./graphicUtils.js";import m from"../../support/debugFlags.js";import{SamplePosition as f}from"../../support/ElevationProvider.js";function p(t,e,a,o){const s=t.stageObject,r=a.spatialReference,c=s.geometryRecords,l="absolute-height"!==e.mode;let p=0;for(const u of c){const t=u.geometry,c=u.getShaderTransformation();I[0]=c[12],I[1]=c[13],I[2]=c[14],t.invalidateBoundingInfo();const d=t.getMutableAttribute("position"),h=d.data,S=t.vertexAttributes.get("mapPos").data,M=d.size,E=h.length/M,v=new f(S,r);let j=0,O=!1,y=0;for(let s=0;s<E;s++){if(g[0]=h[j],g[1]=h[j+1],g[2]=h[j+2],i(v,a,e,o,A),l&&(y+=A.sampledElevation),m.TESTS_DISABLE_OPTIMIZATIONS)h[j]=v.array[v.offset],h[j+1]=v.array[v.offset+1],h[j+2]=A.z,n(h,r,j,h,o.spatialReference,j,1),h[j]-=I[0],h[j+1]-=I[1],h[j+2]-=I[2],O=!0;else{b[0]=h[j]+I[0],b[1]=h[j+1]+I[1],b[2]=h[j+2]+I[2],o.setAltitude(b,A.z),h[j]=b[0]-I[0],h[j+1]=b[1]-I[1],h[j+2]=b[2]-I[2];const t=T/o.unitInMeters;(Math.abs(g[0]-h[j])>=t||Math.abs(g[1]-h[j+1])>=t||Math.abs(g[2]-h[j+2])>=t)&&(O=!0)}j+=M,v.offset+=3}p+=y/E,O&&s.geometryVertexAttrsUpdated(u)}return p/c.length}function u(t,a,s,n){const c=t.stageObject,f=a.centerPointInElevationSR;let p=0;if(c.metadata.usesVerticalDistanceToGround)i(f,s,a,n,A),l(c,A.verticalDistanceToGround),p=A.sampledElevation;else{i(f,s,a,n,A);"absolute-height"!==a.mode&&(p=A.sampledElevation)}const u=e(d,c.transformation),h=o(M,u[12],u[13],u[14]);m.TESTS_DISABLE_OPTIMIZATIONS?(b[0]=f.x,b[1]=f.y,b[2]=A.z,r(f.spatialReference,b,u,n.spatialReference)&&(c.transformation=u)):n.setAltitudeOfTransformation(A.z,u);const I=T/n.unitInMeters;return(Math.abs(u[12]-h[0])>=I||Math.abs(u[13]-h[1])>=I||Math.abs(u[14]-h[2])>=I)&&(c.transformation=u),p}const d=a();function h(e,a,s,n){const c=e.graphics3DSymbolLayer.lodRenderer;if(t(c))return 0;const l=a.centerPointInElevationSR;i(l,s,a,n,A);const f="absolute-height"!==a.mode?A.sampledElevation:0,p=c.instanceData,u=e.instanceIndex,d=S;p.getGlobalTransform(u,d);const h=o(M,d[12],d[13],d[14]);m.TESTS_DISABLE_OPTIMIZATIONS?(b[0]=l.x,b[1]=l.y,b[2]=A.z,r(l.spatialReference,b,d,n.spatialReference)&&p.setGlobalTransform(u,d)):n.setAltitudeOfTransformation(A.z,d);const I=T/n.unitInMeters;return(m.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(d[12]-h[0])>=I||Math.abs(d[13]-h[1])>=I||Math.abs(d[14]-h[2])>=I)&&p.setGlobalTransform(u,d),f}const T=.01,b=s(),I=s(),g=s(),S=a(),M=s(),A=new c;export{h as perLodInstanceElevationAligner,u as perObjectElevationAligner,p as perVertexElevationAligner};
