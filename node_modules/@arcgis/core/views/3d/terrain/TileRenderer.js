/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import{nextHighestPowerOfTwo as e}from"../../../core/mathUtils.js";import{disposeMaybe as t,releaseMaybe as r,isNone as s,isSome as i}from"../../../core/maybe.js";import{s as a,c as o}from"../../../chunks/vec2.js";import{Z as n}from"../../../chunks/vec2f64.js";import{f as l}from"../../../chunks/vec3f64.js";import{f as u}from"../../../chunks/vec4f64.js";import{isBaseLayer as c}from"../../../layers/support/layerUtils.js";import"../../webgl/BufferObject.js";import"../../webgl/FramebufferObject.js";import"../../../core/has.js";import"../../webgl/checkWebGLError.js";import"../../webgl/enums.js";import"../../../chunks/builtins.js";import h from"../../webgl/Texture.js";import"../../webgl/VertexArrayObject.js";import{VectorTileRendererHelper3D as d}from"../../2d/engine/vectorTiles/VectorTileRendererHelper3D.js";import{ImageWithType as f}from"../support/StreamDataLoader.js";import{BlendLayersTechniqueConfiguration as _,BlendLayersTechnique as p}from"./BlendLayersTechnique.js";import{RasterColorizerTechniqueConfiguration as T,RasterColorizerTechnique as b}from"./RasterColorizerTechnique.js";import{isVectorTileLayerView as m,isVectorTileRenderInfo as x,isImageryTileRenderInfo as y,isRasterTileRenderInfo as g,isTextureTileRenderInfo as w}from"./terrainUtils.js";import{TextureReference as k}from"./TextureReference.js";import I from"./TileTexture.js";import{FBOPool as q}from"./support/FBOPool.js";import{Pos2Tex as L}from"../webgl-engine/lib/DefaultVertexBufferLayouts.js";import{createQuadVAO as R,createColorTexture as j,createEmptyTexture as C}from"../webgl-engine/lib/glUtil3D.js";import{vertexCount as O}from"../../webgl/Util.js";class D{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._techniqueRepository=r,this._backgroundIsGrid=!1,this._backgroundTexture=null,this._backgroundColor=null,this._blackTex=null,this._vectorTileHelper=new d,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._vaoQuad=R(this._rctx,L),this._blackTex=new I(j(this._rctx,[0,0,0,1])),this._fboPool=new q(this._rctx)}dispose(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null),this._vaoQuad=t(this._vaoQuad),this._backgroundTexture=r(this._backgroundTexture),this._blackTex=r(this._blackTex),this._blendLayersTechnique=t(this._blendLayersTechnique),this._applyOpacityTechnique=t(this._applyOpacityTechnique),this._vectorTileHelper=t(this._vectorTileHelper)}get blendLayersTechnique(){if(s(this._blendLayersTechnique)){const e=new _;e.mode=2,this._blendLayersTechnique=this._techniqueRepository.acquire(p,e)}return this._blendLayersTechnique}get applyOpacityTechnique(){if(s(this._applyOpacityTechnique)){const e=new _;e.mode=1,this._applyOpacityTechnique=this._techniqueRepository.acquire(p,e)}return this._applyOpacityTechnique}get backgroundIsGrid(){return this._backgroundIsGrid}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){const r=e.layerInfo[1];for(const i of r)i.pendingUpdates&=-1;if(!e.renderData)return;const s=e.surface,a=s.baseOpacity;let o=0,n=0,l=this.tileSize,u=!1;const h=s.view.pixelRatio;let d=r.length,f=0;for(;f<r.length&&!u;f++){const t=s.layerViewByIndex(f,1),i=t.fullOpacity;if(E[f]=i,c(t.layer)&&d>=r.length&&(d=f),0===i)continue;++n;const _=U(e,f,z);_&&(m(t)?l=Math.max(l,this.tileSize*h):1===a&&1===i&&(t.isOpaque||this._dataToTexture(_)&&_.sourceLayerInfo.data.descriptor.isOpaque)&&(u=!0),++o)}this._cleanupFBOPool(h,r.length),l=P(l);const _=l/this.tileSize,p=f-1;0!==o?1===o&&(u||this._backgroundIsGrid||i(this._backgroundColor))&&this._useLayerTexture(e,p,d,E[p])||this._composeMapLayers(e,t,p,d,u,E,l,_):this._useBackgroundTexture(e,n)}_useBackgroundTexture(e,t){let r=0;(e.surface.view.layerViewManager.updating||t>0)&&(r=5e3),this._backgroundTexture&&s(e.renderData.textureReference)&&(r=0),e.renderData.setTextureReference(i(this._backgroundTexture)?new k(this._backgroundTexture,0,S,e.surface.baseOpacity,1,1,!1):null,r)}_useLayerTexture(e,t,r,s){const i=t<r,a=i?1:e.surface.baseOpacity,o=i?e.surface.baseOpacity:1,n=U(e,t,z);return!!this._dataToTexture(n)&&(e.renderData.setTextureReference(new k(n.sourceLayerInfo.data,0,n,a,s,o,!0)),!0)}_composeMapLayers(e,t,r,s,a,o,l,u){const c=this._rctx,d=this._fboPool.acquire(l);c.bindFramebuffer(d),c.setViewport(0,0,l,l),c.setClearColor(0,0,0,0),c.setClearDepth(1),c.clearSafe(16640);let f=!1;!a&&i(this._backgroundTexture)&&this._drawRasterData(this.blendLayersTechnique,this._backgroundTexture.texture,1,n);const _=e.surface.baseOpacity;let p=!1,T=9987;for(let i=r;i>=0;i--){const t=U(e,i,z);t&&(i<s&&_<1&&!p&&(this._drawRasterData(this.applyOpacityTechnique,this._blackTex.texture,1,n,_),p=!0),0!==o[i]&&(x(t)?f=this._drawVectorData(this.blendLayersTechnique,t,u,o[i],l,d,f):y(t)?(this._drawImageryTileData(t,o[i]),this.hasNearestInterpolation(t)&&(T=9728)):this._dataToTexture(t)&&this._drawRasterData(this.blendLayersTechnique,t.sourceLayerInfo.data.texture,t.scale,t.offset,o[i])))}const b=e.renderData.ensureTexture(l,(()=>this._buildTexture(l,T))),m=c.bindTexture(b.texture,h.TEXTURE_UNIT_FOR_UPDATES),g=b.descriptor;c.gl.copyTexImage2D(c.gl.TEXTURE_2D,0,g.pixelFormat,0,0,g.width,g.height,0),b.generateMipmap(),c.bindTexture(m,h.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(null),this._fboPool.release(d);const w=p?1:_;e.renderData.setTextureReference(new k(b,t,S,w,1,1,!1))}_drawQuad(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(5,0,O(this._vaoQuad,"geometry"))}_drawRasterData(e,t,r,i,a=1){if(s(t))return;const o=this._rctx,n=e.program;e.bindPipelineState(o),o.useProgram(n),n.bindTexture(t,"tex"),n.setUniform1f("scale",r),n.setUniform2f("offset",i[0],i[1]),n.setUniform1f("opacity",a),this._drawQuad(n)}hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}_drawImageryTileData(e,t=1){const r=e.sourceLayerInfo.data;if(!r.source)return;e.tile.surface.layerViewByIndex(e.layerIndex,1).ensureSymbolizerParameters(r);const s=this._getRasterColorizerTechnique(r),i=this._rctx,a=s.program;if(s.bindPipelineState(i),i.useProgram(a),!r.bind(i))return;r.opacity=t,r.scale=e.scale,r.offset=e.offset;const{names:o,textures:n}=r.getTextures();o.forEach(((e,t)=>a.bindTexture(n[t],e))),s.bindPass(r.getUniforms()),this._drawQuad(a),i.bindVAO()}_getRasterColorizerTechnique(e){const t=e.symbolizerParameters,r=["stretch","lut","hillshade"].indexOf(t.type);return s(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new T,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.colorizerType=r,this._rasterColorizerConfig.applyColormap=!!t.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?0:1,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(b,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}_drawVectorData(e,t,r,s,a,o,n){const l=this._rctx,u=t.sourceLayerInfo.data,c=t.tile.surface.layerViewByIndex(t.layerIndex,1);let h;return e.bindPipelineState(l),s<1?(h=this._fboPool.acquire(a),l.bindFramebuffer(h),l.setClearColor(1,1,1,0),l.clearSafe(16640)):n&&l.clearSafe(256),this._vectorTileHelper.render(l,t.sourceLod,u,c.painter,c.layer.styleRepository,c.schemaHelper,Math.round(1/t.scale),t.offset,this.tileSize,r),!i(h)||(l.bindFramebuffer(o),this._drawRasterData(e,h.colorTexture,1,[0,0],s),this._fboPool.release(h),n)}_dataToTexture(e){return g(e)&&this._rasterDataToTexture(e),w(e)}_rasterDataToTexture(e){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}setBackground(e,t){r(this._backgroundTexture),this._backgroundIsGrid=t,e instanceof HTMLImageElement?(this._backgroundTexture=this._buildTexture(e),this._backgroundColor=null):(this._backgroundTexture=new I(j(this._rctx,u(e[0]||0,e[1]||0,e[2]||0,1))),this._backgroundColor=l(e[0]||0,e[1]||0,e[2]||0))}_buildTexture(e,t=9987){if(s(e))return null;const r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:t,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._rctx;let a;if("number"==typeof e)r.width=r.height=e,a=new I(new h(i,r));else if(e instanceof f)r.isOpaque=e.isOpaque,a=new I(new h(i,r,e.image)),e.release();else try{a=new I(new h(i,r,e))}catch(n){a=new I(C(i)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=i.bindTexture(a.texture,h.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),i.bindTexture(o,h.TEXTURE_UNIT_FOR_UPDATES),a}_cleanupFBOPool(e,t){e===this._lastPixelRatio&&t===this._lastNumLayers||(this._fboPool.clear(),this._lastPixelRatio=e,this._lastNumLayers=t)}get test(){return{backgroundTexture:this._backgroundTexture}}}function P(t){const r=e(t),s=r*r,i=t*t;if(s===i)return t;const a=r/2;return s-i<i-a*a?r:a}function U(e,t,r){r.layerIndex=t;const s=e.layerInfo[1][t];if(s.data)return a(r.offset,0,0),r.tile=e,r.scale=1,r.sourceLod=e.lij,r.sourceLayerInfo=s,r;const i=s.upsampleInfo;if(i){const e=i.tile.layerInfo[1][t];return r.tile=i.tile,o(r.offset,i.offset),r.scale=i.scale,r.sourceLod=i.tile.lij,r.sourceLayerInfo=e,r}return null}const E=new Array,z={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},S={offset:[0,0],scale:1};export{D as TileRenderer};
