/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import e from"../../../../../core/RandomLCG.js";import"../../../../webgl/BufferObject.js";import"../../../../webgl/FramebufferObject.js";import"../../../../../core/has.js";import"../../../../webgl/checkWebGLError.js";import"../../../../webgl/enums.js";import"../../../../../chunks/builtins.js";import t from"../../../../webgl/Texture.js";import"../../../../webgl/VertexArrayObject.js";import{TEXTURE_BINDING_RENDERER_0 as o,TEXTURE_BINDING_RENDERER_1 as r,TILE_SIZE as i}from"../definitions.js";import{WGLGeometryType as s}from"../enums.js";import{createProgramDescriptor as a}from"../Utils.js";import n from"./WGLGeometryBrush.js";import{FillMaterialKey as l}from"../materialKey/MaterialKey.js";const u=e=>{const t={geometry:[{location:0,name:"a_pos",count:2,type:5122},{location:1,name:"a_id",count:3,type:5121},{location:2,name:"a_bitset",count:1,type:5121}]};return e.dotDensity?(t.geometry.push({location:3,name:"a_inverseArea",count:1,type:5126}),a(e.data,t)):(t.geometry.push({location:3,name:"a_color",count:4,type:5121,normalized:!0}),e.simple||t.geometry.push({location:4,name:"a_aux1",count:4,type:5123}),t.geometry.push({location:5,name:"a_aux2",count:4,type:5121},{location:6,name:"a_aux3",count:4,type:5121}),e.simple||t.geometry.push({location:7,name:"a_zoomRange",count:2,type:5123}),a(e.data,t))};class d extends n{constructor(){super(...arguments),this._dotTextureSize=0,this._dotTextures=null,this._dotSamplers=new Int32Array([o,r])}dispose(){this._disposeTextures()}getGeometryType(){return s.FILL}drawGeometry(e,t,o,r){const{context:s,painter:a,rendererInfo:n,requiredLevel:d}=e,m=l.load(o.materialKey),{bufferLayouts:c,attributes:f}=u(m),p=a.materialManager.getMaterialProgram(e,m,"materials/fill",f,r);if(s.useProgram(p),this._setSharedUniforms(p,e,t),p.setUniform2f("u_tileOffset",512*t.key.col,512*t.key.row),m.textureBinding){a.textureManager.bindTextures(s,p,m);const o=1/2**(d-t.key.level)/e.pixelRatio;p.setUniform1f("u_zoomFactor",o)}const _=1/e.pixelRatio;if(p.setUniform1f("u_blur",_),p.setUniform1f("u_antialiasing",_),this._setSizeVVUniforms(m,p,n,t),this._setColorAndOpacityVVUniforms(m,p,n),m.dotDensity){const o=i/n.ddDotSize,r=o*window.devicePixelRatio*o*window.devicePixelRatio,a=1/2**(d-t.key.level),l=1/a*(1/a),u=n.ddDotScale?e.state.scale/n.ddDotScale:1;p.setUniform1f("u_tileZoomFactor",a),p.setUniform1f("u_tileDotsOverArea",r/(i*window.devicePixelRatio*i*window.devicePixelRatio)),p.setUniformMatrix4fv("u_dotColors",n.ddColors),p.setUniform4fv("u_isActive",n.ddActiveDots),p.setUniform4fv("u_dotBackgroundColor",n.ddBackgroundColor),p.setUniform1f("u_dotValue",Math.max(1,n.ddDotValue*u*l)),this._bindDotDensityTextures(s,p,n,o)}o.draw(s,c,f)}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_bindDotDensityTextures(e,t,o,r){const i=this._createDotDensityTextures(e,r,o.ddSeed);t.setUniform1iv("u_dotTextures",this._dotSamplers);for(let s=0;s<i.length;s++)e.bindTexture(i[s],this._dotSamplers[s])}_createDotDensityTextures(t,o,r){if(this._dotTextureSize===o&&this._seed===r||(this._disposeTextures(),this._dotTextureSize=o,this._seed=r),null===this._dotTextures){const i=new e(r);this._dotTextures=[this._allocDotDensityTexture(t,o,i),this._allocDotDensityTexture(t,o,i)]}return this._dotTextures}_allocDotDensityTexture(e,o,r){const i=new Float32Array(o*o*4);for(let t=0;t<i.length;t++)i[t]=r.getFloat();return new t(e,{wrapMode:10497,pixelFormat:6408,dataType:5126,samplingMode:9728,width:o,height:o},i)}}export{d as default};
