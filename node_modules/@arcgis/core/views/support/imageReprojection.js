/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.22/esri/copyright.txt for details.
*/
import t from"../../request.js";import e from"../../geometry/Point.js";import{project as r}from"../../geometry/projection.js";import{projectResolution as i,getProjectionOffsetGrid as a}from"../../layers/support/rasterFunctions/rasterProjectionHelper.js";import{isImageSource as s,rasterize as o}from"../2d/engine/Bitmap.js";import n from"../2d/engine/webgl/VertexStream.js";import{createProgramTemplate as m}from"../2d/engine/webgl/shaders/MaterialPrograms.js";import p from"../webgl/FramebufferObject.js";import h from"../webgl/ProgramCache.js";import{createTransformTexture as c}from"../webgl/rasterUtils.js";import{RenderingContext as x}from"../webgl/RenderingContext.js";import d from"../webgl/Texture.js";class g{constructor(t){if(t)this._ownsRctx=!1,this._rctx=t;else{this._ownsRctx=!0;const t=document.createElement("canvas").getContext("webgl");t.getExtension("OES_texture_float"),this._rctx=new x(t,{})}const e=m("raster/reproject","raster/reproject",new Map([["a_position",0]])),r=new h(this._rctx);this._program=r.getProgram(e,{applyProjection:!0,bilinear:!1,bicubic:!1}),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new n(this._rctx,[0,0,1,0,0,1,1,1])}reprojectTexture(t,s,o=!1){const n=r(t.extent,s),m=new e({x:(t.extent.xmax-t.extent.xmin)/t.texture.descriptor.width,y:(t.extent.ymax-t.extent.ymin)/t.texture.descriptor.height,spatialReference:t.extent.spatialReference}),{x:h,y:x}=i(m,s,t.extent);let g=(h+x)/2;const u=Math.round((n.xmax-n.xmin)/g),_=Math.round((n.ymax-n.ymin)/g);g=(n.width/u+n.height/_)/2;const f=new e({x:g,y:g,spatialReference:n.spatialReference}),l=a({projectedExtent:n,srcBufferExtent:t.extent,pixelSize:f,hasWrapAround:!0,spacing:[16,16]}),w=c(this._rctx,l),b=new d(this._rctx,{width:u,height:_,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1}),j=new p(this._rctx,{colorTarget:0,depthStencilTarget:0,width:u,height:_},b);if(this._rctx.bindFramebuffer(j),this._rctx.setViewport(0,0,u,_),this._rctx.useProgram(this._program),this._rctx.bindTexture(t.texture,0),this._rctx.bindTexture(w,1),this._quad.bind(),this._program.setUniform2f("u_srcImageSize",t.texture.descriptor.width,t.texture.descriptor.height),this._program.setUniform2fv("u_transformSpacing",l.spacing),this._program.setUniform2fv("u_transformGridSize",l.size),this._program.setUniform2f("u_targetImageSize",u,_),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),w.dispose(),o){const t=new ImageData(j.descriptor.width,j.descriptor.height);return j.readPixels(0,0,j.descriptor.width,j.descriptor.height,6408,5121,t.data),j.detachColorTexture(36064),j.dispose(),{texture:b,extent:n,imageData:t}}return j.detachColorTexture(36064),j.dispose(),{texture:b,extent:n}}reprojectBitmapData(t,e){const r=s(t.bitmapData)?o(t.bitmapData):t.bitmapData,i=new d(this._rctx,{width:t.bitmapData.width,height:t.bitmapData.height,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,hasMipmap:!1},r),a=this.reprojectTexture({texture:i,extent:t.extent},e,!0);a.texture.dispose();const n=document.createElement("canvas");n.width=a.imageData.width,n.height=a.imageData.height;return n.getContext("2d").putImageData(a.imageData,0,0),{bitmapData:n,extent:a.extent}}async loadAndReprojectBitmapData(e,r,i){const a=(await t(e,{responseType:"image"})).data,s=document.createElement("canvas");s.width=a.width,s.height=a.height;const o=s.getContext("2d");o.drawImage(a,0,0);const n=o.getImageData(0,0,s.width,s.height),m=this.reprojectBitmapData({bitmapData:n,extent:r},i);return{bitmapData:m.bitmapData,extent:m.extent}}destroy(){this._quad.dispose(),this._program.dispose(),this._ownsRctx&&this._rctx.dispose()}}export{g as ImageReprojector};
